<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gu√≠a de Implementaci√≥n de Seguridad</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #d32f2f;
            border-bottom: 3px solid #d32f2f;
            padding-bottom: 10px;
        }

        h2 {
            color: #1976d2;
            margin-top: 30px;
        }

        .critical {
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            padding: 15px;
            margin: 15px 0;
        }

        .warning {
            background: #fff3e0;
            border-left: 4px solid #f57c00;
            padding: 15px;
            margin: 15px 0;
        }

        .success {
            background: #e8f5e9;
            border-left: 4px solid #388e3c;
            padding: 15px;
            margin: 15px 0;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .step {
            margin: 20px 0;
            padding: 15px;
            background: #fafafa;
            border-radius: 5px;
        }

        .step-number {
            background: #1976d2;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        ul {
            padding-left: 20px;
        }

        li {
            margin: 8px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üõ°Ô∏è Gu√≠a Paso a Paso: Implementaci√≥n de Seguridad</h1>

        <div class="critical">
            <strong>‚ö†Ô∏è ATENCI√ìN:</strong> Esta gu√≠a debe seguirse en orden. Cada paso es cr√≠tico para la seguridad de la
            aplicaci√≥n.
        </div>

        <h2>üìã Archivos Creados</h2>
        <ul>
            <li><code>firestore.rules</code> - Reglas de seguridad de Firestore</li>
            <li><code>docs/js/security-helpers.js</code> - Funciones de seguridad centralizadas</li>
            <li><code>firebase.json</code> - Configuraci√≥n con headers de seguridad</li>
        </ul>

        <h2>üöÄ Fase 1: Configuraci√≥n Inmediata (HOY)</h2>

        <div class="step">
            <h3><span class="step-number">1</span>Desplegar Reglas de Firestore</h3>
            <pre>firebase deploy --only firestore:rules</pre>
            <p><strong>¬øQu√© hace?</strong> Aplica las reglas de seguridad estrictas a tu base de datos.</p>
            <div class="warning">
                <strong>IMPORTANTE:</strong> Esto puede romper funcionalidades existentes si el c√≥digo cliente intenta
                hacer operaciones no permitidas. Prueba en un entorno de desarrollo primero.
            </div>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span>Agregar Security Helpers a Todos los HTML</h3>
            <p>Agrega esta l√≠nea en el <code>&lt;head&gt;</code> de TODOS tus archivos HTML:</p>
            <pre>&lt;script src="./js/security-helpers.js"&gt;&lt;/script&gt;</pre>
            <p>Archivos afectados:</p>
            <ul>
                <li>index.html</li>
                <li>user.html</li>
                <li>noc.html</li>
                <li>senales.html</li>
                <li>documentos.html</li>
                <li>gestion_empleados.html</li>
                <li>registros.html</li>
            </ul>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span>Instalar DOMPurify</h3>
            <p>Agrega DOMPurify en todos los HTML (antes de security-helpers.js):</p>
            <pre>&lt;script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"&gt;&lt;/script&gt;</pre>
        </div>

        <div class="step">
            <h3><span class="step-number">4</span>Configurar Firebase Hosting</h3>
            <pre>firebase deploy --only hosting</pre>
            <p>Esto desplegar√° los headers de seguridad (CSP, X-Frame-Options, etc.)</p>
        </div>

        <h2>üîß Fase 2: Refactorizaci√≥n de C√≥digo (Esta Semana)</h2>

        <div class="step">
            <h3><span class="step-number">5</span>Reemplazar innerHTML Vulnerable</h3>
            <p><strong>ANTES (INSEGURO):</strong></p>
            <pre>element.innerHTML = `&lt;div&gt;${userData.name}&lt;/div&gt;`;</pre>

            <p><strong>DESPU√âS (SEGURO) - Opci√≥n 1: textContent</strong></p>
            <pre>element.textContent = userData.name;</pre>

            <p><strong>DESPU√âS (SEGURO) - Opci√≥n 2: DOMPurify</strong></p>
            <pre>safeInnerHTML(element, `&lt;div&gt;${userData.name}&lt;/div&gt;`);</pre>

            <p><strong>DESPU√âS (SEGURO) - Opci√≥n 3: DOM API</strong></p>
            <pre>const div = createSafeElement('div', 'mi-clase', userData.name);
element.appendChild(div);</pre>

            <div class="warning">
                <strong>Priorizar estos archivos:</strong>
                <ul>
                    <li>senales.js (19 instancias)</li>
                    <li>noc.js (17 instancias)</li>
                    <li>script.js (12 instancias)</li>
                </ul>
            </div>
        </div>

        <div class="step">
            <h3><span class="step-number">6</span>Agregar Verificaci√≥n de Permisos Real</h3>
            <p><strong>ANTES:</strong></p>
            <pre>// Solo verificaci√≥n en cliente (INSEGURO)
const role = localStorage.getItem('userRole');
if (role === 'admin') {
  // hacer operaci√≥n sensible
}</pre>

            <p><strong>DESPU√âS:</strong></p>
            <pre>// Verificar desde Firestore (SEGURO)
try {
  await requireAdmin('modificar calendario');
  // hacer operaci√≥n sensible
  await auditLog('CALENDAR_MODIFIED', { date: '2025-12-07' });
} catch (error) {
  Swal.fire('Error', error.message, 'error');
}</pre>
        </div>

        <div class="step">
            <h3><span class="step-number">7</span>Implementar Re-Autenticaci√≥n</h3>
            <p>Para operaciones cr√≠ticas (borrar datos, cambiar contrase√±as):</p>
            <pre>try {
  await requireRecentAuth(5); // 5 minutos max
  // Operaci√≥n cr√≠tica
  await db.collection('calendarios').doc(id).delete();
} catch (error) {
  Swal.fire('Error', error.message, 'error');
}</pre>
        </div>

        <h2>‚úÖ Verificaci√≥n</h2>

        <div class="success">
            <h3>Checklist de Verificaci√≥n:</h3>
            <ul>
                <li>‚úÖ Reglas de Firestore desplegadas</li>
                <li>‚úÖ security-helpers.js agregado en todos los HTML</li>
                <li>‚úÖ DOMPurify incluido</li>
                <li>‚úÖ Headers de seguridad configurados</li>
                <li>‚úÖ innerHTML cr√≠ticos reemplazados</li>
                <li>‚úÖ Verificaci√≥n de permisos real implementada</li>
            </ul>
        </div>

        <h2>üß™ Testing</h2>

        <div class="step">
            <h3>Pruebas que DEBES hacer:</h3>
            <ol>
                <li><strong>Intenta modificar localStorage</strong>
                    <pre>localStorage.setItem('userRole', 'superadmin');
location.reload();</pre>
                    <p>‚úÖ NO deber√≠a dar acceso a funciones de admin</p>
                </li>

                <li><strong>Verifica CSP en DevTools</strong>
                    <ul>
                        <li>Abre DevTools ‚Üí Red tab</li>
                        <li>Recarga la p√°gina</li>
                        <li>Busca el header "Content-Security-Policy"</li>
                        <li>Verifica que no hay errores de CSP en Consola</li>
                    </ul>
                </li>

                <li><strong>Prueba con usuario normal</strong>
                    <ul>
                        <li>Login como usuario regular</li>
                        <li>Verifica que NO vea botones de admin</li>
                        <li>Intenta acceder directamente a /index.html</li>
                        <li>‚úÖ Deber√≠a redirigir a user.html</li>
                    </ul>
                </li>
            </ol>
        </div>

        <h2>üìû Soporte</h2>
        <p>Si encuentras problemas durante la implementaci√≥n:</p>
        <ol>
            <li>Revisa la consola del navegador para errores</li>
            <li>Verifica los logs de Firebase Console</li>
            <li>Consulta el <code>security_audit_report.md</code> para detalles espec√≠ficos</li>
        </ol>

        <div class="critical">
            <strong>‚ö†Ô∏è RECORDATORIO FINAL:</strong> NO despliegues a producci√≥n hasta completar al menos la Fase 1 y 2,
            y despu√©s de testing exhaustivo.
        </div>
    </div>
</body>

</html>