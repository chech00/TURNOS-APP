rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // ========================================================
    // REGLAS GENERALES: Validar autenticación
    // ========================================================
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEmailVerified() {
    	// Opcional: request.auth.token.email_verified
      return isAuthenticated();
    }

    function isAdmin() {
      // Verificar claim personalizado o documento en 'userRoles'
      // Por simplicidad, leemos el doc (tiene costo, pero es seguro)
      // OMEJOR: Usar Custom Claims si estuvieran configurados.
      // Aquí usaremos la lectura 'userRoles'
      return isAuthenticated() && 
      	get(/databases/$(database)/documents/userRoles/$(request.auth.uid)).data.rol in ['admin', 'superadmin'];
    }

    
    // ========================================================
    // COLECCIONES
    // ========================================================

    // 1. Usuarios y Roles
    match /userRoles/{userId} {
      allow read: if isAuthenticated(); // Cualquiera puede leer (para ver perfiles) o restringir a propio?
      // Mejor: Cada uno lee lo suyo, Admin lee todo.
      // Por ahora dejamos leer autenticado para que la UI cargue.
      allow write: if isAdmin(); // Solo admin puede cambiar roles
    }
    
    match /users/{userId} {
    	allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // 2. Nodos y Topología (Senales)
    // BLINDADO: Escrituras solo via API Backend
    match /Nodos/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; 
    }

    // 3. Uptime Logs (INCIDENTES) - BLINDADO (Backend-First)
    match /uptime_logs/{incidentId} {
      allow read: if isAuthenticated();
      // BLOCKED WRITES: Todas las escrituras deben ir por la API Backend
      allow write: if false; 
    }
    
    // 4. Configuración (Monitoring Toggle, etc)
    match /config/{docId} {
    	allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 5. Sesiones Activas (Presencia)
    match /activeSessions/{userId} {
      allow read: if isAuthenticated();
      // Write is handled by client in active-session.js (should ideally be backend but legacy)
      // Since active-session.js writes directly, we must allow user to write their own doc
      allow write: if request.auth.uid == userId; 
    }
  }
}
