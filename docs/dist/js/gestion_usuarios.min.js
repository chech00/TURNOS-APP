"use strict";function getAuth(){return window.auth}function getDb(){return window.db}let allUsers=[],auditLogs=[];async function loadAllUsers(){try{const e=getDb();if(!e)throw new Error("Firestore no inicializado");console.log("Cargando usuarios...");const t=await e.collection("userRoles").get();console.log(`Roles encontrados: ${t.size}`);let a={};try{(await e.collection("userStatus").get()).forEach(e=>{a[e.id]=e.data()})}catch(e){console.warn("No se pudo cargar userStatus (posible error de permisos):",e)}const n=[];t.forEach(e=>{const t=e.data(),r=e.id,o=t.lastLogin?.toDate?.()||null;n.push({uid:r,email:t.email||"Sin email",nombre:t.nombre||t.email?.split("@")[0]||"Usuario",rol:t.rol||"user",suspended:a[r]?.suspended||!1,lastLogin:o})}),allUsers=n;return getAuth().currentUser&&0===allUsers.length&&console.warn("¡ALERTA! El usuario actual está logueado pero la lista de roles está vacía. Verifique reglas de seguridad."),n}catch(e){throw console.error("Error al cargar usuarios:",e),e}}async function renderUsersTable(){const e=document.getElementById("tbodyUsuarios"),t=document.getElementById("table-loader"),a=document.getElementById("tablaUsuarios");if(e){t&&(t.style.display="flex"),a&&(a.style.display="none");try{const n=await loadAllUsers();if(t&&(t.style.display="none"),a&&(a.style.display="table"),0===n.length)return void(e.innerHTML='<tr><td colspan="5" style="text-align:center; padding: 2rem;">No hay cuentas de usuario registradas.</td></tr>');e.innerHTML=n.map(e=>{const t=getRoleBadge(e.rol),a=getStatusBadge(e.suspended),n=e.lastLogin?e.lastLogin.toLocaleString("es-CL"):"No disponible";return`\n                <tr data-uid="${e.uid}">\n                    <td>\n                        <div class="user-info">\n                            <span class="user-name">${escapeHtml(e.nombre)}</span>\n                            <span class="user-email">${escapeHtml(e.email)}</span>\n                        </div>\n                    </td>\n                    <td>${t}</td>\n                    <td>${a}</td>\n                    <td>${n}</td>\n                    <td>\n                        <div class="actions-cell">\n                            <button class="btn-action edit" onclick="editUser('${e.uid}')" title="Cambiar Rol">\n                                <i data-lucide="edit"></i>\n                            </button>\n                            ${e.suspended?`\n                                <button class="btn-action activate" onclick="reactivateUser('${e.uid}')" title="Reactivar Cuenta">\n                                    <i data-lucide="user-check"></i>\n                                </button>\n                            `:`\n                                <button class="btn-action suspend" onclick="suspendUser('${e.uid}')" title="Suspender Cuenta">\n                                    <i data-lucide="user-x"></i>\n                                </button>\n                           `}\n                            <button class="btn-action reset" onclick="sendPasswordReset('${escapeHtml(e.email)}')" title="Resetear Contraseña">\n                                <i data-lucide="key"></i>\n                            </button>\n                            <button class="btn-action delete" onclick="deleteUser('${e.uid}', '${escapeHtml(e.email)}')" title="Eliminar Cuenta">\n                                <i data-lucide="trash-2"></i>\n                            </button>\n                        </div>\n                    </td>\n                </tr>\n            `}).join(""),lucide.createIcons(),updateStats(n)}catch(n){console.error("Error al renderizar tabla:",n),t&&(t.style.display="none"),a&&(a.style.display="table");let r=n.message;"permission-denied"===n.code&&(r="Permisos insuficientes para ver la lista de usuarios. Contacte al desarrollador para revisar las reglas de Firestore (userRoles)."),e.innerHTML=`<tr><td colspan="5" style="text-align:center; color: #f87171; padding: 2rem;">\n            Error: ${r}\n        </td></tr>`}}}function updateStats(e){const t=e.length,a=e.filter(e=>"admin"===e.rol).length,n=e.filter(e=>"superadmin"===e.rol).length,r=e.filter(e=>e.suspended).length;document.getElementById("stat-total-users").textContent=t,document.getElementById("stat-admins").textContent=a,document.getElementById("stat-superadmins").textContent=n,document.getElementById("stat-suspended").textContent=r}async function createNewUser(e,t,a,n){try{if(!e||!t||!n)throw new Error("Email, nombre y contraseña son obligatorios");if(!window.secondaryAuth)throw new Error("Sistema de autenticación secundario no disponible");Swal.fire({title:"Creando cuenta...",didOpen:()=>Swal.showLoading()});const r=(await window.secondaryAuth.createUserWithEmailAndPassword(e,t)).user,o=getDb();await o.collection("userRoles").doc(r.uid).set({email:e,nombre:n,rol:a,mustChangePassword:!0}),await logAuditAction("user_created",r.uid,e,{role:a,name:n}),Swal.fire({icon:"success",title:"Cuenta Creada",text:`Cuenta para ${n} (${e}) creada exitosamente.`,timer:2e3}),await renderUsersTable()}catch(e){console.error("Error al crear cuenta:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo crear la cuenta: "+e.message})}}async function editUser(e){const t=allUsers.find(t=>t.uid===e);if(!t)return;const{value:a}=await Swal.fire({title:"Editar Usuario",html:`\n            <div style="text-align: left; margin-bottom: 1rem;">\n                <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Nombre</label>\n                <input id="swal-input-name" class="swal2-input" style="margin: 0 0 1em 0; width: 100%;" placeholder="Nombre completo" value="${t.nombre||""}">\n                \n                <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Rol</label>\n                <select id="swal-input-role" class="swal2-select" style="margin: 0; width: 100%;">\n                    <option value="user" ${"user"===t.rol?"selected":""}>Usuario Regular</option>\n                    <option value="admin" ${"admin"===t.rol?"selected":""}>Administrador</option>\n                    <option value="superadmin" ${"superadmin"===t.rol?"selected":""}>SuperAdministrador</option>\n                </select>\n            </div>\n            <p style="font-size: 0.8em; color: #64748b;">Email: ${t.email}</p>\n        `,focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Guardar Cambios",cancelButtonText:"Cancelar",preConfirm:()=>({name:document.getElementById("swal-input-name").value,role:document.getElementById("swal-input-role").value})});if(a){const n=a.name.trim(),r=a.role;if(!n)return void Swal.fire("Error","El nombre no puede estar vacío","error");try{Swal.fire({title:"Actualizando...",didOpen:()=>Swal.showLoading()});const a=getDb();await a.collection("userRoles").doc(e).update({nombre:n,rol:r}),await logAuditAction("user_updated",e,t.email,{oldRole:t.rol,newRole:r,oldName:t.nombre,newName:n}),Swal.fire({icon:"success",title:"Usuario Actualizado",text:`Los datos de ${n} han sido actualizados.`,timer:2e3}),await renderUsersTable()}catch(e){console.error("Error al actualizar usuario:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo actualizar el usuario: "+e.message})}}}async function suspendUser(e){const t=allUsers.find(t=>t.uid===e);if(!t)return;const{value:a}=await Swal.fire({title:"¿Suspender Cuenta?",html:`<p>Usuario: <strong>${t.email}</strong></p>\n               <p style="color: #fbbf24;">⚠️ El usuario no podrá iniciar sesión hasta que sea reactivado.</p>`,input:"textarea",inputLabel:"Razón de suspensión (opcional)",inputPlaceholder:"Ingrese la razón de la suspensión...",showCancelButton:!0,confirmButtonText:"Sí, Suspender",cancelButtonText:"Cancelar",confirmButtonColor:"#f59e0b"});if(void 0!==a)try{Swal.fire({title:"Suspendiendo...",didOpen:()=>Swal.showLoading()});const n=getDb(),r=getAuth().currentUser;await n.collection("userStatus").doc(e).set({suspended:!0,suspendedAt:firebase.firestore.FieldValue.serverTimestamp(),suspendedBy:r.uid,suspendedReason:a||"No especificada"}),await logAuditAction("user_suspended",e,t.email,{reason:a||"No especificada"}),Swal.fire({icon:"success",title:"Cuenta Suspendida",text:`${t.email} ha sido suspendido`,timer:2e3}),await renderUsersTable()}catch(e){console.error("Error al suspender cuenta:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo suspender la cuenta"})}}async function reactivateUser(e){const t=allUsers.find(t=>t.uid===e);if(!t)return;if((await Swal.fire({title:"¿Reactivar Cuenta?",html:`<p>Usuario: <strong>${t.email}</strong></p>\n               <p style="color: #4ade80;">✓ El usuario podrá iniciar sesión nuevamente.</p>`,icon:"question",showCancelButton:!0,confirmButtonText:"Sí, Reactivar",cancelButtonText:"Cancelar",confirmButtonColor:"#22c55e"})).isConfirmed)try{Swal.fire({title:"Reactivando...",didOpen:()=>Swal.showLoading()});const a=getDb();await a.collection("userStatus").doc(e).set({suspended:!1,reactivatedAt:firebase.firestore.FieldValue.serverTimestamp()}),await logAuditAction("user_reactivated",e,t.email,{}),Swal.fire({icon:"success",title:"Cuenta Reactivada",text:`${t.email} ha sido reactivado`,timer:2e3}),await renderUsersTable()}catch(e){console.error("Error al reactivar cuenta:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo reactivar la cuenta"})}}async function sendPasswordReset(e){if((await Swal.fire({title:"Resetear Contraseña",html:`<p>Se enviará un email de recuperación a:</p>\n               <p><strong>${e}</strong></p>`,icon:"question",showCancelButton:!0,confirmButtonText:"Enviar Email",cancelButtonText:"Cancelar"})).isConfirmed)try{Swal.fire({title:"Enviando email...",didOpen:()=>Swal.showLoading()});const t=getAuth();await t.sendPasswordResetEmail(e);const a=allUsers.find(t=>t.email===e);a&&await logAuditAction("password_reset",a.uid,e,{}),Swal.fire({icon:"success",title:"Email Enviado",text:`Email de recuperación enviado a ${e}`,timer:3e3})}catch(e){console.error("Error al enviar email:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo enviar el email de recuperación: "+e.message})}}async function deleteUser(e,t){if((await Swal.fire({title:"⚠️ ELIMINAR CUENTA",html:`<p>¿Estás seguro de eliminar la cuenta de:</p>\n               <p><strong>${t}</strong></p>\n               <div style="background-color: #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px; margin-top: 10px;">\n                   <strong>ADVERTENCIA:</strong> Esta acción NO se puede deshacer.<br>\n                   Se eliminará el acceso al sistema para este usuario.\n               </div>`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, ELIMINAR",cancelButtonText:"Cancelar",confirmButtonColor:"#dc2626"})).isConfirmed)try{Swal.fire({title:"Eliminando cuenta...",didOpen:()=>Swal.showLoading()});const a=getDb();await a.collection("userRoles").doc(e).delete(),await a.collection("userStatus").doc(e).delete(),await logAuditAction("user_deleted",e,t,{}),Swal.fire({icon:"success",title:"Cuenta Eliminada",text:`${t} ha sido eliminado del sistema`,timer:2e3}),await renderUsersTable()}catch(e){console.error("Error al eliminar cuenta:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo eliminar la cuenta"})}}async function logAuditAction(e,t,a,n){try{const r=getDb(),o=getAuth().currentUser;if(!o)return;await r.collection("auditLogs").add({timestamp:firebase.firestore.FieldValue.serverTimestamp(),action:e,performedBy:o.uid,performedByEmail:o.email,targetUser:t,targetUserEmail:a,details:n||{}})}catch(e){console.error("Error al registrar auditoría:",e)}}async function loadAuditLogs(e={}){try{let t=getDb().collection("auditLogs").orderBy("timestamp","desc").limit(100);e.action&&(t=t.where("action","==",e.action)),e.targetUser&&(t=t.where("targetUser","==",e.targetUser));const a=await t.get(),n=[];return a.forEach(e=>{const t=e.data();n.push({id:e.id,timestamp:t.timestamp?t.timestamp.toDate():null,action:t.action,performedByEmail:t.performedByEmail,targetUserEmail:t.targetUserEmail,details:t.details||{}})}),auditLogs=n,n}catch(e){return console.error("Error al cargar logs de auditoría:",e),[]}}async function renderAuditTable(e={}){const t=document.getElementById("tbodyAudit");if(t){t.innerHTML='<tr><td colspan="5" style="text-align:center;">Cargando logs...</td></tr>';try{const a=await loadAuditLogs(e);if(0===a.length)return void(t.innerHTML='<tr><td colspan="5" style="text-align:center;">No hay registros de auditoría.</td></tr>');t.innerHTML=a.map(e=>{const t=getActionBadge(e.action),a=e.timestamp?e.timestamp.toLocaleString("es-CL"):"Fecha desconocida",n=formatAuditDetails(e.action,e.details);return`\n                <tr>\n                    <td>${a}</td>\n                    <td>${t}</td>\n                    <td>${escapeHtml(e.performedByEmail)}</td>\n                    <td>${escapeHtml(e.targetUserEmail)}</td>\n                    <td>${n}</td>\n                </tr>\n            `}).join("")}catch(e){console.error("Error al renderizar logs:",e),t.innerHTML='<tr><td colspan="5" style="text-align:center; color: #f87171;">Error al cargar logs</td></tr>'}}}function formatAuditDetails(e,t){switch(e){case"role_changed":return`${t.oldRole} → ${t.newRole}`;case"user_suspended":return t.reason||"Sin razón especificada";case"user_created":return`Rol: ${t.role}`;default:return"—"}}function escapeHtml(e){if(!e)return e;const t=document.createElement("div");return t.textContent=e,t.innerHTML}function getRoleBadge(e){const t={user:{text:"Usuario",icon:"user"},admin:{text:"Admin",icon:"shield-check"},superadmin:{text:"SuperAdmin",icon:"crown"}},a=t[e]||t.user;return`\n        <span class="role-badge ${e}">\n            <i data-lucide="${a.icon}"></i>\n            ${a.text}\n        </span>\n    `}function getStatusBadge(e){return e?'\n            <span class="status-badge suspended">\n                <i data-lucide="user-x"></i>\n                Suspendido\n            </span>\n        ':'\n            <span class="status-badge active">\n                <i data-lucide="user-check"></i>\n                Activo\n            </span>\n        '}function getActionBadge(e){return`<span class="action-badge ${e}">${{user_created:"Cuenta Creada",role_changed:"Cambio de Rol",user_suspended:"Cuenta Suspendida",user_reactivated:"Cuenta Reactivada",password_reset:"Reset de Contraseña",user_deleted:"Cuenta Eliminada"}[e]||e}</span>`}function configurarSidebar(){const e=document.getElementById("sidebar"),t=document.getElementById("main-content"),a=document.getElementById("menu-toggle");a&&e&&t&&a.addEventListener("click",()=>{e.classList.toggle("expanded"),t.classList.toggle("expanded")})}function configurarLogout(){const e=document.getElementById("logout-btn");e&&e.addEventListener("click",()=>{getAuth().signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>{console.error("Error al cerrar sesión:",e)})})}function verificarAccesoSuperAdmin(){getAuth().onAuthStateChanged(async e=>{if(e)try{const t=await getDb().collection("userRoles").doc(e.uid).get();if(!t.exists)return getAuth().signOut(),localStorage.removeItem("userRole"),void(window.location.href="login.html");const a=t.data();if("superadmin"!==a.rol)return void Swal.fire({icon:"error",title:"Acceso Denegado",text:"Solo SuperAdministradores pueden acceder a esta sección."}).then(()=>{window.location.href="index.html"});document.body.classList.add("is-admin");const n=document.getElementById("li-registros"),r=document.getElementById("li-turnos"),o=document.getElementById("li-animaciones");n&&(n.style.display="block"),r&&(r.style.display="block"),o&&(o.style.display="block"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons(),await renderUsersTable(),await populateUserFilterSelect()}catch(e){console.error("Error al verificar acceso:",e),window.location.href="index.html"}else window.location.href="login.html"})}async function populateUserFilterSelect(){const e=document.getElementById("filter-user");e&&0!==allUsers.length&&(e.innerHTML='<option value="">Todos</option>',allUsers.forEach(t=>{const a=document.createElement("option");a.value=t.uid,a.textContent=t.email,e.appendChild(a)}))}function waitForFirebase(){return new Promise((e,t)=>{let a=0;const n=()=>{a++,window.auth&&window.db&&window.secondaryAuth?(console.log("Firebase Global Objects Ready"),e()):a>=50?(console.error("Timeout esperando a Firebase."),Swal.fire({icon:"error",title:"Error de Conexión",text:"No se pudieron cargar los servicios de Firebase. Recarga la página."}),t(new Error("Timeout waiting for Firebase"))):setTimeout(n,100)};n()})}async function initOne(){await waitForFirebase(),configurarSidebar(),configurarLogout(),verificarAccesoSuperAdmin();const e=document.getElementById("btnAgregarUsuario");e&&(console.log("Botón agregar usuario encontrado y listener asociado."),e.addEventListener("click",async()=>{if(console.log("Click en agregar usuario"),"undefined"==typeof Swal)return void alert("Error: SweetAlert2 no está cargado.");if(!window.secondaryAuth)return void Swal.fire("Error","El sistema de autenticación secundaria no está listo. Intente refrescar la página.","error");const{value:e}=await Swal.fire({title:"Crear Nueva Cuenta de Sistema",html:'\n                    <div style="text-align: left;">\n                        <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Email</label>\n                        <input id="swal-email" class="swal2-input" style="margin: 0 0 1em 0; width: 100%;" placeholder="ejemplo@email.com" type="email">\n\n                        <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Nombre</label>\n                        <input id="swal-name" class="swal2-input" style="margin: 0 0 1em 0; width: 100%;" placeholder="Nombre completo">\n\n                        <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Contraseña</label>\n                        <input id="swal-password" class="swal2-input" style="margin: 0 0 1em 0; width: 100%;" placeholder="Contraseña (min 6 chars)" type="password">\n                        \n                        <label style="display:block; font-size: 0.9em; margin-bottom: 0.3em; color: #cbd5e1;">Rol</label>\n                        <select id="swal-role" class="swal2-select" style="margin: 0; width: 100%;">\n                            <option value="user">Usuario Regular</option>\n                            <option value="admin">Administrador</option>\n                            <option value="superadmin">SuperAdministrador</option>\n                        </select>\n                    </div>',focusConfirm:!1,showCancelButton:!0,confirmButtonText:"Crear Cuenta",cancelButtonText:"Cancelar",preConfirm:()=>({email:document.getElementById("swal-email").value,name:document.getElementById("swal-name").value,password:document.getElementById("swal-password").value,role:document.getElementById("swal-role").value})});if(e){const{email:t,password:a,role:n,name:r}=e;if(!(t&&a&&n&&r))return void Swal.fire("Error","Todos los campos son obligatorios","error");await createNewUser(t,a,n,r)}}));const t=document.getElementById("audit-header"),a=document.getElementById("audit-content"),n=t?.querySelector(".collapse-btn");t&&a&&n&&t.addEventListener("click",()=>{const e="none"!==a.style.display;a.style.display=e?"none":"block",n.classList.toggle("active"),e||0!==auditLogs.length||renderAuditTable()});const r=document.getElementById("btnApplyFilters");r&&r.addEventListener("click",()=>{renderAuditTable({action:document.getElementById("filter-action").value||null,targetUser:document.getElementById("filter-user").value||null})});const o=document.getElementById("btnClearFilters");o&&o.addEventListener("click",()=>{document.getElementById("filter-action").value="",document.getElementById("filter-user").value="",renderAuditTable()}),window.createNewUser=createNewUser,window.editUser=editUser,window.suspendUser=suspendUser,window.reactivateUser=reactivateUser,window.sendPasswordReset=sendPasswordReset,window.deleteUser=deleteUser}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initOne):initOne();