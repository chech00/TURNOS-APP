"use strict";function getAuth(){return window.auth}function getDb(){return window.db}const empleadosChannel=new BroadcastChannel("empleados_sync");document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("userRole");if("superadmin"===e){const e=document.getElementById("li-registros"),n=document.getElementById("li-turnos"),o=document.getElementById("li-usuarios");e&&(e.style.display="block"),n&&(n.style.display="block"),o&&(o.style.display="block"),document.body.classList.add("is-admin")}else"admin"===e&&document.body.classList.add("is-admin")});const EMPLEADOS_DEFAULT=[{nombre:"Sergio Castillo"},{nombre:"Ignacio Aburto"},{nombre:"Claudio Bustamante"},{nombre:"Julio Oliva"},{nombre:"Gabriel Trujillo"}];async function cargarEmpleados(){try{const e=getDb();if(!e)throw new Error("Firestore no inicializado");const n=await e.collection("Config").doc("empleados_noc").get();if(n.exists){const e=n.data();if(e.lista&&Array.isArray(e.lista))return e.lista}}catch(e){console.error("Error al cargar empleados de Firestore:",e);const n=localStorage.getItem("noc_empleados_list");if(n)try{return JSON.parse(n)}catch(e){console.error("Error parsing localStorage:",e)}}return EMPLEADOS_DEFAULT}async function guardarEmpleados(e){try{const n=getDb();if(!n)throw new Error("Firestore no inicializado");return await n.collection("Config").doc("empleados_noc").set({lista:e}),localStorage.setItem("noc_empleados_list",JSON.stringify(e)),empleadosChannel.postMessage({type:"empleados_updated",data:e}),!0}catch(e){return console.error("Error al guardar empleados en Firestore:",e),Swal.fire({icon:"error",title:"Error de conexión",text:"No se pudieron guardar los cambios en la base de datos. Verifique su conexión."}),!1}}function escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):e}async function renderTablaEmpleados(){const e=document.getElementById("tbodyEmpleados");if(!e)return;e.innerHTML='<tr><td colspan="4" style="text-align:center; padding: 20px;">Cargando empleados...</td></tr>';const n=await cargarEmpleados();0!==n.length?(e.innerHTML=n.map((e,o)=>{const t=o+1,a=t<=2;return`\n      <tr data-index="${o}">\n        <td>\n          <span class="posicion-numero ${a?"privilegiado":""}">${t}</span>\n        </td>\n        <td>${escapeHtml(e.nombre)}</td>\n        <td>${"nocturno"===(e.tipoTurno||"diurno")?'<span class="tipo-badge nocturno"><i data-lucide="moon"></i> Nocturno</span>':'<span class="tipo-badge diurno"><i data-lucide="sun"></i> Diurno</span>'}</td>\n        <td>\n          <span class="privilegios-badge ${a?"activo":"inactivo"}">\n            ${a?"✓ DL + Feriados":"— Sin privilegios"}\n          </span>\n        </td>\n        <td>\n          <div class="acciones-cell">\n            ${o>0?`<button class="btn-accion subir" onclick="moverEmpleado(${o}, -1)" title="Subir posición"><i data-lucide="arrow-up"></i></button>`:""}\n            ${o<n.length-1?`<button class="btn-accion bajar" onclick="moverEmpleado(${o}, 1)" title="Bajar posición"><i data-lucide="arrow-down"></i></button>`:""}\n            <button class="btn-accion editar" onclick="editarEmpleado(${o})" title="Editar"><i data-lucide="pencil"></i></button>\n            <button class="btn-accion eliminar" onclick="eliminarEmpleado(${o})" title="Eliminar"><i data-lucide="trash-2"></i></button>\n          </div>\n        </td>\n      </tr>\n    `}).join(""),lucide.createIcons()):e.innerHTML='<tr><td colspan="4" style="text-align:center; padding: 20px;">No hay empleados registrados.</td></tr>'}function agregarEmpleado(){Swal.fire({title:"Agregar Empleado",html:'\n            <div style="text-align: left;">\n                <label style="display:block; margin-bottom: 5px; font-weight: 600;">Nombre del empleado:</label>\n                <input id="swal-input-nombre" class="swal2-input" placeholder="Ej: Juan Pérez" style="width: 100%; margin: 0 0 15px 0;">\n                \n                <label style="display:block; margin-bottom: 5px; font-weight: 600;">Tipo de turno:</label>\n                <select id="swal-input-tipo" class="swal2-select" style="width: 100%; margin: 0;">\n                    <option value="diurno" selected>Diurno (Calendario General)</option>\n                    <option value="nocturno">Nocturno (Calendario Nocturno)</option>\n                </select>\n            </div>\n        ',showCancelButton:!0,confirmButtonText:"Agregar",cancelButtonText:"Cancelar",focusConfirm:!1,preConfirm:()=>{const e=document.getElementById("swal-input-nombre").value,n=document.getElementById("swal-input-tipo").value;return e&&""!==e.trim()?{nombre:e.trim(),tipoTurno:n}:(Swal.showValidationMessage("Debes ingresar un nombre"),!1)}}).then(async e=>{if(e.isConfirmed&&e.value){Swal.fire({title:"Guardando...",didOpen:()=>Swal.showLoading()});const n=await cargarEmpleados();n.push({nombre:e.value.nombre,tipoTurno:e.value.tipoTurno});if(await guardarEmpleados(n)){await renderTablaEmpleados();const n="nocturno"===e.value.tipoTurno?"nocturno":"diurno";Swal.fire({icon:"success",title:"Empleado agregado",text:`${e.value.nombre} ha sido agregado como empleado ${n}.`,timer:2e3,showConfirmButton:!1})}}})}async function editarEmpleado(e){const n=await cargarEmpleados(),o=n[e];if(!o)return;const t=o.tipoTurno||"diurno";Swal.fire({title:"Editar Empleado",html:`\n            <div style="text-align: left;">\n                <label style="display:block; margin-bottom: 5px; font-weight: 600;">Nombre del empleado:</label>\n                <input id="swal-input-nombre" class="swal2-input" value="${o.nombre}" style="width: 100%; margin: 0 0 15px 0;">\n                \n                <label style="display:block; margin-bottom: 5px; font-weight: 600;">Tipo de turno:</label>\n                <select id="swal-input-tipo" class="swal2-select" style="width: 100%; margin: 0;">\n                    <option value="diurno" ${"diurno"===t?"selected":""}>Diurno (Calendario General)</option>\n                    <option value="nocturno" ${"nocturno"===t?"selected":""}>Nocturno (Calendario Nocturno)</option>\n                </select>\n            </div>\n        `,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",focusConfirm:!1,preConfirm:()=>{const e=document.getElementById("swal-input-nombre").value,n=document.getElementById("swal-input-tipo").value;return e&&""!==e.trim()?{nombre:e.trim(),tipoTurno:n}:(Swal.showValidationMessage("Debes ingresar un nombre"),!1)}}).then(async o=>{if(o.isConfirmed&&o.value){Swal.fire({title:"Actualizando...",didOpen:()=>Swal.showLoading()}),n[e].nombre=o.value.nombre,n[e].tipoTurno=o.value.tipoTurno;await guardarEmpleados(n)&&(await renderTablaEmpleados(),Swal.fire({icon:"success",title:"Empleado actualizado",timer:1500,showConfirmButton:!1}))}})}async function eliminarEmpleado(e){const n=await cargarEmpleados(),o=n[e];o&&Swal.fire({title:"¿Eliminar empleado?",html:`¿Estás seguro de eliminar a "<b>${o.nombre}</b>"?<br><br>\n               <div style="background-color: #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px; font-size: 0.9em;">\n                   <strong>⚠️ ADVERTENCIA CRÍTICA:</strong><br>\n                   Esta acción eliminará permanentemente todos los turnos asignados a este empleado en el calendario.<br>\n                   <strong>No se puede deshacer.</strong>\n               </div>`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, eliminar y borrar turnos",cancelButtonText:"Cancelar",confirmButtonColor:"#d33"}).then(async o=>{if(o.isConfirmed){Swal.fire({title:"Eliminando...",didOpen:()=>Swal.showLoading()}),n.splice(e,1);await guardarEmpleados(n)&&(await renderTablaEmpleados(),Swal.fire({icon:"success",title:"Empleado eliminado",timer:1500,showConfirmButton:!1}))}})}async function moverEmpleado(e,n){Swal.fire({title:"Moviendo...",didOpen:()=>Swal.showLoading(),showConfirmButton:!1,allowOutsideClick:!1});const o=await cargarEmpleados(),t=e+n;if(t<0||t>=o.length)return void Swal.close();const a=o[e];o[e]=o[t],o[t]=a;await guardarEmpleados(o)&&(await renderTablaEmpleados(),Swal.close())}function configurarSidebar(){const e=document.getElementById("sidebar"),n=document.getElementById("main-content"),o=document.querySelectorAll("#menu-toggle");e&&n&&0!==o.length?o.forEach(o=>{o.addEventListener("click",()=>{e.classList.toggle("expanded"),n.classList.toggle("expanded")})}):console.error("No se encontró el sidebar o main content.")}function configurarLogout(){const e=document.getElementById("logout-btn");e&&e.addEventListener("click",()=>{getAuth().signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>{console.error("Error al cerrar sesión:",e)})})}function verificarAcceso(){getAuth().onAuthStateChanged(e=>{e?getDb().collection("userRoles").doc(e.uid).get().then(e=>{if(e.exists){const n=e.data(),o="admin"===n.rol,t="superadmin"===n.rol;if(!o&&!t)return void Swal.fire({icon:"error",title:"Acceso denegado",text:"No tienes permisos para acceder a esta página."}).then(()=>{window.location.href="index.html"});if(document.body.classList.add("is-admin"),t){const e=document.getElementById("li-registros"),n=document.getElementById("li-turnos"),o=document.getElementById("li-usuarios"),t=document.getElementById("li-animaciones");e&&(e.style.display="block"),n&&(n.style.display="block"),o&&(o.style.display="block"),t&&(t.style.display="block"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}renderTablaEmpleados()}else window.location.href="index.html"}).catch(e=>{console.error("Error al verificar rol:",e),window.location.href="index.html"}):window.location.href="login.html"})}document.addEventListener("DOMContentLoaded",function(){configurarSidebar(),configurarLogout(),verificarAcceso();const e=document.getElementById("btnAgregarEmpleado");e&&e.addEventListener("click",agregarEmpleado),window.moverEmpleado=moverEmpleado,window.editarEmpleado=editarEmpleado,window.eliminarEmpleado=eliminarEmpleado});