"use strict";import{auth,db}from"./firebase.js";import{FERIADOS_DEFAULT}from"./modules/logic/holidayLogic.js";const supabaseUrl="https://jmrzvajipfdqvzilqjvq.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imptcnp2YWppcGZkcXZ6aWxxanZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg3ODU3MTksImV4cCI6MjA1NDM2MTcxOX0.xQZX2i-6wynnRnEKBb_mwbt63S6vvrr10SilIyug5Mg";let supabase=null;(async()=>{try{const{createClient:e}=await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm");supabase=e(supabaseUrl,supabaseKey),console.log("[Supabase] Cliente inicializado correctamente")}catch(e){console.error("[Supabase] Error al inicializar (no cr√≠tico):",e)}})();let firebaseCheckAttempts=0;const maxFirebaseAttempts=50;function checkFirebaseAvailability(){firebaseCheckAttempts++,auth&&db?console.log("[NOC] Firebase disponible (Module Import)."):firebaseCheckAttempts<50?setTimeout(checkFirebaseAvailability,100):(console.error("Firebase auth/db not initialized after timeout."),Swal.fire({icon:"error",title:"Error de Carga",text:"No se pudo conectar con el sistema de autenticaci√≥n.",footer:"Detalle t√©cnico: Firebase no inicializado."}))}document.addEventListener("DOMContentLoaded",()=>{checkFirebaseAvailability()});let usuarioEsAdmin=!1,currentDate=new Date,selectedDays=[],isMonthLocked=!1;const vacationIcon='<i data-lucide="tree-palm"></i>';let feriadosChile=[],feriadosInfo={};async function cargarFeriados(){try{const e=await db.collection("Config").doc("feriados").get();if(e.exists){const t=e.data();if(t.lista&&Array.isArray(t.lista)){let e=t.lista,o=!1;const n=new Set(e.map(e=>e.fecha));return FERIADOS_DEFAULT.forEach(t=>{n.has(t.fecha)||(e.push(t),n.add(t.fecha),o=!0)}),o&&(console.log("Actualizando feriados en Firestore con nuevos a√±os..."),e.sort((e,t)=>new Date(e.fecha)-new Date(t.fecha)),await db.collection("Config").doc("feriados").set({lista:e})),feriadosChile=e.map(e=>e.fecha),feriadosInfo={},e.forEach(e=>{feriadosInfo[e.fecha]=e.nombre}),void console.log("Feriados cargados (y actualizados) desde Firestore")}}console.log("Inicializando feriados en Firestore..."),await db.collection("Config").doc("feriados").set({lista:FERIADOS_DEFAULT}),feriadosChile=FERIADOS_DEFAULT.map(e=>e.fecha),feriadosInfo={},FERIADOS_DEFAULT.forEach(e=>{feriadosInfo[e.fecha]=e.nombre})}catch(e){console.error("Error cargando feriados:",e),feriadosChile=FERIADOS_DEFAULT.map(e=>e.fecha),feriadosInfo={},FERIADOS_DEFAULT.forEach(e=>{feriadosInfo[e.fecha]=e.nombre})}}let empleados=[];const DEFAULT_EMPLOYEES_NAMES=["Sergio Castillo","Ignacio Aburto","Claudio Bustamante","Julio Oliva","Gabriel Trujillo","Cristian Oyarzo"];async function cargarEmpleadosDeFirestore(){if(!db)return console.warn("[NOC] DB no lista al cargar empleados. Se reintentar√°."),[];let e=[];try{const t=await db.collection("Config").doc("empleados_noc").get();if(t.exists){const o=t.data();o.lista&&Array.isArray(o.lista)&&(e=o.lista.map(e=>({nombre:e.nombre,tipoTurno:e.tipoTurno||"diurno",turnos:[]})))}}catch(e){console.error("Error al cargar empleados de Firestore:",e)}return DEFAULT_EMPLOYEES_NAMES.forEach(t=>{e.some(e=>e.nombre===t)||(console.log(`[NOC] Agregando empleado faltante al calendario: ${t}`),e.push({nombre:t,tipoTurno:"diurno",turnos:[]}))}),e}function iniciarCalendario(){console.log("[DEBUG] iniciarCalendario llamado"),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{"function"==typeof renderCalendar&&renderCalendar()}):"function"==typeof renderCalendar&&renderCalendar()}empleados=DEFAULT_EMPLOYEES_NAMES.map(e=>({nombre:e,turnos:[]})),window.empleados=empleados,feriadosChile&&0!==feriadosChile.length||(feriadosChile=FERIADOS_DEFAULT.map(e=>e.fecha),feriadosInfo={},FERIADOS_DEFAULT.forEach(e=>{feriadosInfo[e.fecha]=e.nombre})),document.addEventListener("DOMContentLoaded",()=>{"function"==typeof renderCalendar&&(console.log("[OPTIMIZACI√ìN] Renderizado inicial optimista (sin esperar DB)"),renderCalendar())}),console.log("[DEBUG] Iniciando sincronizaci√≥n en segundo plano..."),Promise.all([cargarEmpleadosDeFirestore(),cargarFeriados()]).then(([e])=>{console.log("[DEBUG] Datos frescos cargados. Actualizando vista..."),e&&e.length>0&&(empleados=e,window.empleados=empleados),iniciarCalendario(),document.dispatchEvent(new CustomEvent("datosCargados"))}).catch(e=>{console.error("[DEBUG] Error en sincronizaci√≥n:",e)});let renderCalendarTimeout=null;function renderCalendarDebounced(e=currentDate,t=150){clearTimeout(renderCalendarTimeout),renderCalendarTimeout=setTimeout(()=>{renderCalendar(e)},t)}function fixShiftTextColors(){document.querySelectorAll("button.calendar-day").forEach(e=>{e.style.backgroundColor&&""!==e.style.backgroundColor&&(e.style.color="#000")})}function updateLockUI(){const e=document.getElementById("lockedIndicator"),t=document.getElementById("btnToggleLock");"superadmin"===localStorage.getItem("userRole")&&t&&(t.style.display="inline-flex",t.innerHTML=isMonthLocked?'<i data-lucide="unlock"></i> Abrir Mes':'<i data-lucide="lock"></i> Cerrar Mes',t.className="btn-horarios superadmin-only",isMonthLocked?(t.style.backgroundColor="#7796cb",t.style.color="#fff"):(t.style.backgroundColor="#f39c12",t.style.color="#fff")),isMonthLocked?(document.body.classList.add("locked-mode"),e&&(e.style.display="flex")):(document.body.classList.remove("locked-mode"),e&&(e.style.display="none")),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}const empleadosChannel=new BroadcastChannel("empleados_sync");empleadosChannel.onmessage=function(e){e.data&&"empleados_updated"===e.data.type&&(console.log("Empleados actualizados - recargando p√°gina"),location.reload())};const bitacoraEmployees=["Sergio Castillo","Ignacio Aburto","Julio Oliva","Carolina Gonzalez","Gabriel Trujillo","Claudio Bustamante"];function obtenerClaveMes(e){return`calendar_v3_${e.getFullYear()}-${e.getMonth()+1}`}function limpiarCacheAntiguo(){const e=[],t=[];for(let o=0;o<localStorage.length;o++){const n=localStorage.key(o);n&&(n.startsWith("calendar_v2_")||n.startsWith("calendar_")&&!n.startsWith("calendar_v3_"))?e.push(n):n&&n.startsWith("calendar_v3_")&&t.push(n)}e.forEach(e=>{console.log(`Limpiando cache antiguo: ${e}`),localStorage.removeItem(e)}),e.length>0&&console.log(`Cache antiguo limpiado: ${e.length} entradas removidas`);const o=new Set(empleados.map(e=>e.nombre));let n=0;t.forEach(e=>{try{const t=JSON.parse(localStorage.getItem(e));if(t&&t.assignments){let a=!1;Object.keys(t.assignments).forEach(r=>{o.has(r)||(console.log(`Eliminando empleado del cache ${e}: ${r}`),delete t.assignments[r],a=!0,n++)}),a&&localStorage.setItem(e,JSON.stringify(t))}}catch(t){console.error(`Error limpiando cache v3 ${e}:`,t)}}),n>0&&console.log(`Empleados eliminados purgados del cache: ${n} entradas`)}function obtenerDatosCalendario(){const e=document.getElementById("current-month"),t=document.getElementById("general-calendar"),o=document.getElementById("nocturno-calendar"),n=document.getElementById("feriados-calendar");return{mes:e.textContent,generalHTML:t?t.outerHTML:"",nocturnoHTML:o?o.outerHTML:"",feriadosHTML:n?n.outerHTML:"",locked:isMonthLocked}}function guardarCalendarioEnLocalStorage(){const e=obtenerClaveMes(currentDate),t={mes:document.getElementById("current-month").textContent,assignments:{},nocturno:{},feriados:{}},o=document.getElementById("general-calendar");o&&o.querySelectorAll("tbody tr").forEach(e=>{const o=e.querySelector("td:first-child");if(!o)return;const n=o.textContent.replace(/\s*\(Ex\)\s*$/,"").trim();if("Encargado de Bit√°cora"===n)return;const a={};e.querySelectorAll("button.calendar-day").forEach(e=>{const t=e.getAttribute("data-day");let o=e.textContent.trim();(e.querySelector('[data-lucide="tree-palm"]')||e.querySelector("svg.lucide-tree-palm"))&&(o="V"),o&&(a[t]=o)}),Object.keys(a).length>0&&(t.assignments[n]=a)});const n=document.getElementById("nocturno-calendar");n&&n.querySelectorAll("button.calendar-day").forEach(e=>{const o=e.getAttribute("data-day");let n=e.textContent.trim();n&&(t.nocturno[o]=n)});const a=document.getElementById("feriados-calendar");a&&a.querySelectorAll("button.calendar-day").forEach(e=>{const o=e.getAttribute("data-day");let n=e.textContent.trim();n&&(t.feriados[o]=n)}),t.locked=isMonthLocked,localStorage.setItem(e,JSON.stringify(t)),console.log(`Calendario guardado en localStorage (formato JSON seguro) con la clave: ${e}`)}function verificarRolUsuario(e){auth.onAuthStateChanged(t=>{t?db.collection("userRoles").doc(t.uid).get().then(t=>{if(t.exists){const o=t.data().rol;localStorage.setItem("userRole",o);const n="admin"===o,a="superadmin"===o;if(a){const e=document.getElementById("li-registros"),t=document.getElementById("li-turnos"),o=document.getElementById("li-usuarios"),n=document.getElementById("li-animaciones");e&&(e.style.display="block"),t&&(t.style.display="block"),o&&(o.style.display="block"),n&&(n.style.display="block"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}(n||a)&&document.body.classList.add("is-admin"),e(n||a)}else e(!1)}).catch(t=>{console.error("Error al obtener rol:",t),e(!1)}):window.location.href="login.html"})}function configurarSidebar(){const e=document.getElementById("sidebar"),t=document.getElementById("main-content"),o=document.querySelectorAll("#menu-toggle");e&&t&&0!==o.length?(o.forEach(o=>{o.addEventListener("click",()=>{e.classList.toggle("expanded"),t.classList.toggle("expanded")})}),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons()):console.error("No se encontr√≥ el sidebar o main content.")}function configurarLogout(){const e=document.getElementById("logout-btn");e&&e.addEventListener("click",()=>{auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>{console.error("Error al cerrar sesi√≥n:",e)})})}function asignarDomingosLibres(e,t,o){empleados.forEach(n=>{if(n.turnos=Array(o).fill(""),"Sergio Castillo"===n.nombre||"Ignacio Aburto"===n.nombre)for(let a=1;a<=o;a++){0===new Date(e,t,a).getDay()&&(n.turnos[a-1]="DL")}})}function sincronizarTablasConEmpleados(){const e=document.getElementById("general-calendar");if(!e)return;const t=e.querySelector("tbody");if(!t)return;const o=currentDate.getFullYear(),n=currentDate.getMonth(),a=new Date(o,n+1,0).getDate(),r={};let l="";t.querySelectorAll("tr").forEach(e=>{const t=e.querySelector("td");if(t){const o=t.textContent.trim();"Encargado de Bit√°cora"===o?l=e.outerHTML:r[o]=e.outerHTML}});let s="";empleados.forEach((e,t)=>{if("nocturno"!==(e.tipoTurno||"diurno"))if(r[e.nombre])s+=r[e.nombre],delete r[e.nombre];else{let t=`<tr><td class="text-left p-2">${e.nombre}</td>`;for(let r=1;r<=a;r++){const a=`${o}-${String(n+1).padStart(2,"0")}-${String(r).padStart(2,"0")}`,l=0===new Date(o,n,r).getDay(),s=feriadosChile.includes(a);let c="";const i="Sergio Castillo"===e.nombre||"Ignacio Aburto"===e.nombre;i&&l&&(c="DL");let d="DL"===c?"domingo-libre":"";s&&i&&(d+=" feriado"),t+=`\n          <td>\n            <button\n              data-date="${a}"\n              data-empleado="${e.nombre}"\n              data-day="${r}"\n              class="calendar-day w-full h-full ${d}"\n            >\n              ${c}\n            </button>\n          </td>\n        `}t+="</tr>",s+=t}else console.log(`[SYNC] Saltando empleado nocturno: ${e.nombre}`)});for(const[e,t]of Object.entries(r))console.log(`Eliminando fila de empleado inactivo/borrado: ${e}`);if(l)s+=l;else{s+=`\n      <tr>\n        <td class="bitacora-row" style="white-space:nowrap;">Encargado de Bit√°cora</td>\n        <td class="bitacora-row" colspan="${a+1-1}" style="text-align:center;">\n          ${bitacoraEmployees[(n-1+bitacoraEmployees.length)%bitacoraEmployees.length]}\n        </td>\n      </tr>\n    `}t.innerHTML=s}function sincronizarCalendarioNocturno(){const e=document.getElementById("nocturno-calendar");if(!e)return;const t=e.querySelector("tbody");if(!t)return;const o=currentDate.getFullYear(),n=currentDate.getMonth(),a=new Date(o,n+1,0).getDate(),r={};t.querySelectorAll("tr").forEach(e=>{const t=e.querySelector("td");if(t){const o=t.textContent.trim();r[o]=e.outerHTML}});let l="";empleados.filter(e=>"nocturno"===(e.tipoTurno||"diurno")).forEach(e=>{if(r[e.nombre])l+=r[e.nombre],delete r[e.nombre];else{let t=`<tr><td class="text-left p-2">${e.nombre}</td>`;for(let r=1;r<=a;r++){const a=`${o}-${String(n+1).padStart(2,"0")}-${String(r).padStart(2,"0")}`,l=new Date(o,n,r),s=feriadosChile.includes(a),c=l.getDay();let i="",d="";s?(i="F",d="feriado"):0===c?(i="DL",d="domingo-libre"):6===c?(i="L",d="dia-libre"):(i="N",d="nocturno"),t+=`<td><button data-date="${a}" data-empleado="${e.nombre}" data-day="${r}" class="calendar-day w-full h-full ${d}">${i}</button></td>`}t+="</tr>",l+=t}}),t.innerHTML=l}function agregarEmpleadosFaltantes(){const e=document.getElementById("general-calendar");if(!e)return;const t=e.querySelector("tbody");if(!t)return;const o=currentDate.getFullYear(),n=currentDate.getMonth(),a=new Date(o,n+1,0).getDate(),r=new Set;t.querySelectorAll("tr").forEach(e=>{const t=e.querySelector("td");if(t){const e=t.textContent.replace(/‚ö†Ô∏è/g,"").trim();e&&"Encargado de Bit√°cora"!==e&&r.add(e)}});const l=empleados.filter(e=>"diurno"===(e.tipoTurno||"diurno")&&!r.has(e.nombre));if(0===l.length)return;console.log(`[SYNC+] Agregando ${l.length} diurno(s):`,l.map(e=>e.nombre));const s=t.querySelector("tr:has(td.bitacora-row)");l.forEach(e=>{const r=empleados.indexOf(e)+1<=2;let l=`<tr><td class="text-left p-2">${e.nombre}</td>`;for(let t=1;t<=a;t++){const a=`${o}-${String(n+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`,s=0===new Date(o,n,t).getDay();let c="";r&&s&&(c="DL");let i="DL"===c?"domingo-libre":"";feriadosChile.includes(a)&&r&&(i+=" feriado"),l+=`<td><button data-date="${a}" data-empleado="${e.nombre}" data-day="${t}" class="calendar-day w-full h-full ${i}">${c}</button></td>`}l+="</tr>",s?s.insertAdjacentHTML("beforebegin",l):t.insertAdjacentHTML("beforeend",l)}),usuarioEsAdmin&&attachAdminCellListeners()}function agregarEmpleadosNocturnosFaltantes(){const e=document.getElementById("nocturno-calendar");if(!e)return;const t=e.querySelector("tbody");if(!t)return;const o=currentDate.getFullYear(),n=currentDate.getMonth(),a=new Date(o,n+1,0).getDate(),r=new Set;t.querySelectorAll("tr").forEach(e=>{const t=e.querySelector("td");t&&r.add(t.textContent.trim())});const l=empleados.filter(e=>"nocturno"===(e.tipoTurno||"diurno")&&!r.has(e.nombre));0!==l.length&&(console.log(`[SYNC+] Agregando ${l.length} nocturno(s):`,l.map(e=>e.nombre)),l.forEach(e=>{let r=`<tr><td class="text-left p-2">${e.nombre}</td>`;for(let t=1;t<=a;t++){const a=`${o}-${String(n+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`,l=new Date(o,n,t),s=feriadosChile.includes(a),c=l.getDay();let i="",d="";s?(i="F",d="feriado"):0===c?(i="DL",d="domingo-libre"):6===c?(i="L",d="dia-libre"):(i="N",d="nocturno"),r+=`<td><button data-date="${a}" data-empleado="${e.nombre}" data-day="${t}" class="calendar-day w-full h-full ${d}">${i}</button></td>`}r+="</tr>",t.insertAdjacentHTML("beforeend",r)}),usuarioEsAdmin&&attachAdminCellListeners())}function renderCalendar(e=currentDate){console.log("[DEBUG] renderCalendar llamado, date:",e);const t=document.getElementById("general-calendar");if(t){let e=t.previousSibling;for(;e&&(e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE&&"BR"===e.tagName);){const t=e;e=e.previousSibling,t.remove()}}isMonthLocked=!1,renderCalendarDesdeCero(e);const o=obtenerClaveMes(e),n=localStorage.getItem(o);if(n)try{const t=JSON.parse(n);if(t.generalHTML)return console.log("Detectado formato antiguo. Migrando a JSON seguro..."),migrarDatosAntiguos(o,t),renderCalendar(e);t.assignments&&aplicarAsignaciones(t.assignments),t.nocturno&&aplicarAsignacionesSimples("nocturno-calendar",t.nocturno),t.feriados&&aplicarAsignacionesSimples("feriados-calendar",t.feriados),t.hasOwnProperty("locked")&&(isMonthLocked=!!t.locked,updateLockUI())}catch(e){console.error("Error leyendo localStorage:",e)}usuarioEsAdmin&&attachAdminCellListeners(),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons(),fixShiftTextColors(),updateLockUI(),requestAnimationFrame(()=>{calcularHorasExtras(e);document.querySelectorAll("#general-calendar tbody tr").forEach(e=>checkWeeklyHours(e))})}function migrarDatosAntiguos(e,t){const o=new DOMParser,n={mes:t.mes,assignments:{},nocturno:{},feriados:{}};if(t.generalHTML){o.parseFromString(`<table>${t.generalHTML}</table>`,"text/html").querySelectorAll("tr").forEach(e=>{const t=e.querySelector("td")?.textContent.trim();if(t&&"Encargado de Bit√°cora"!==t){const o={};e.querySelectorAll("button").forEach(e=>{const t=e.getAttribute("data-day");let n=e.textContent.trim();(e.querySelector("svg")||e.querySelector("i"))&&(n="V"),n&&(o[t]=n)}),Object.keys(o).length>0&&(n.assignments[t]=o)}})}localStorage.setItem(e,JSON.stringify(n))}function aplicarAsignaciones(e){const t=document.getElementById("general-calendar");if(!t)return;const o=new Set(empleados.map(e=>e.nombre));Object.entries(e).forEach(([e,n])=>{if(!o.has(e))return void console.log(`Ignorando empleado eliminado del cache: ${e}`);const a=Array.from(t.querySelectorAll("tbody tr")).find(t=>t.querySelector("td")?.textContent.trim()===e);a&&Object.entries(n).forEach(([e,t])=>{const o=a.querySelector(`button[data-day="${e}"]`);o&&actualizarBotonTurno(o,t)})})}function aplicarAsignacionesSimples(e,t){const o=document.getElementById(e);o&&Object.entries(t).forEach(([e,t])=>{const n=o.querySelector(`button[data-day="${e}"]`);n&&actualizarBotonTurno(n,t)})}function actualizarBotonTurno(e,t){e.textContent="V"===t?"":t;const o={M0:"#648c9b",M0A:"#7b69a5",M1:"#557a5f",M1A:"#c49f87",M1B:"#ffaaa5",M2:"#ffcc99",M2A:"#d4a5a5",M2B:"#b5e7a0",M3:"#996a7f",V:"#88C0A6",L:"#8FBCBB",DL:"#D77A7A",N:"#cccccc",S:"#4A90E2",I:"#2C3E50"};window.SHIFT_COLORS||(window.SHIFT_COLORS={...o},document.querySelectorAll(".btn-turno").forEach(e=>{const t=e.getAttribute("data-turno"),o=e.getAttribute("data-color");t&&o&&(window.SHIFT_COLORS[t]=o)}),console.log("[NOC] Color Map Built:",window.SHIFT_COLORS));const n=e.closest("#nocturno-calendar");"V"===t?(e.innerHTML='<i data-lucide="tree-palm"></i>',e.style.backgroundColor=window.SHIFT_COLORS.V,e.style.color="#000",e.setAttribute("title","Vacaciones")):(e.removeAttribute("style"),e.removeAttribute("title"),!n&&"DL"!==t&&"F"!==t&&window.SHIFT_COLORS[t]&&(e.style.backgroundColor=window.SHIFT_COLORS[t],e.style.color="#000")),e.className="calendar-day w-full h-full","DL"===t?(e.classList.add("domingo-libre"),e.style.backgroundColor="",e.style.color=""):"F"===t?(e.classList.add("feriado"),e.style.backgroundColor=""):"N"===t?e.classList.add("nocturno"):"L"===t&&(e.classList.add("dia-libre"),n||(e.style.backgroundColor=window.SHIFT_COLORS.L,e.style.color="#000")),e.style.backgroundColor&&(e.style.color="#000");const a=e.closest("tr");a&&checkWeeklyHours(a)}limpiarCacheAntiguo();const SHIFT_HOURS={M0:9,M0A:9,M1:8,M1A:9,M1B:9,M2:8,M2A:9,M2B:9,M3:9,N:9,S:11,I:11,V:0,L:0,DL:0,F:0};function checkWeeklyHours(e){if(!e)return;const t=e.querySelector("td:first-child");if(!t)return;const o=t.querySelector(".warning-icon");o&&o.remove(),t.classList.remove("text-warning");const n=e.querySelectorAll("button.calendar-day");if(0===n.length)return;const a=t.textContent.trim(),r="Sergio Castillo"===a||"Ignacio Aburto"===a,l=currentDate.getFullYear(),s=currentDate.getMonth();let c=0,i=!1,d=[],u=1;if(console.log(`[44h Check] Checking ${a} for ${s+1}/${l}`),n.forEach((e,t)=>{try{const o=new Date(l,s,t+1).getDay(),a=e.textContent.trim();1===o&&(t>0&&c>44&&(i=!0,d.push(u),console.log(`  -> Violation Found! Week ${u} Sum: ${c}`)),c=0,u++);let m=((void 0!==SHIFT_HOURS?SHIFT_HOURS:window.SHIFT_HOURS)||{})[a]||0;5===o&&m>0&&(m-=1),6===o&&("M1"!==a&&"M2"!==a||(m=5)),0===o&&r&&(m=0),c+=m,0!==o&&t!==n.length-1||c>44&&(i=!0,d.push(u),console.log(`  -> Violation Found! Week End/Month End. Sum: ${c}`),c=0)}catch(e){console.error("Error in daily loop 44h:",e)}}),i){console.log(`[44h ALERT] ${a} exceeded limits.`);const e=document.createElement("span");e.textContent=" ‚ö†Ô∏è",e.className="warning-icon",e.title=`Excede 44 hrs en semana(s): ${d.join(", ")}`,e.style.cssText="cursor:help; margin-left:5px; color: #e74c3c; font-weight:bold; font-size: 1.25em;",t.appendChild(e),t.classList.add("text-warning"),t.style.backgroundColor="rgba(232, 194, 126, 0.35)",t.style.borderLeft="4px solid #e8c27e",t.style.color="#f0f0f0",t.title=`Alerta: 44h excedidas en semanas ${d.join(",")}`}else t.style.backgroundColor="",t.style.borderLeft="",t.style.color="",t.title=""}function restaurarEmpleadosEliminados(e){if(!e)return;const t=document.getElementById("general-calendar"),o=t?.querySelector("tbody");if(!o)return;const n=Array.from(o.querySelectorAll("tr td:first-child")).map(e=>e.textContent.trim()),a=currentDate.getFullYear(),r=currentDate.getMonth(),l=new Date(a,r+1,0).getDate();Object.keys(e).forEach(t=>{if(!n.includes(t)){let n=`<tr><td class="text-left p-2" style="color:#ef4444; font-style:italic;">${t} <span style="font-size:0.8em; opacity:0.8;">(Ex)</span></td>`;for(let o=1;o<=l;o++){const l=e[t][o]||"";let s=l;"V"===l&&(s='<i data-lucide="tree-palm"></i>'),n+=`\n          <td>\n            <button\n              data-date="${`${a}-${String(r+1).padStart(2,"0")}-${String(o).padStart(2,"0")}`}"\n              data-empleado="${t}"\n              data-day="${o}"\n              class="calendar-day w-full h-full"\n            >\n              ${s}\n            </button>\n          </td>\n        `}n+="</tr>";const s=o.querySelector("tr:last-child");s?s.insertAdjacentHTML("beforebegin",n):o.insertAdjacentHTML("beforeend",n);const c=o.querySelector("tr:nth-last-child(2)");c&&Object.entries(e[t]).forEach(([e,t])=>{const o=c.querySelector(`button[data-day="${e}"]`);o&&actualizarBotonTurno(o,t)})}})}function escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):e}function renderCalendarDesdeCero(e){const t=document.getElementById("current-month"),o=e.getFullYear(),n=e.getMonth(),a=new Date(o,n,1),r=new Date(o,n+1,0).getDate();t.textContent=`${a.toLocaleString("default",{month:"long"})} ${o}`;const l=document.getElementById("general-calendar"),s=document.getElementById("nocturno-calendar"),c=document.getElementById("feriados-calendar");function i(e){let t='<tr><th class="text-left p-2">Empleado</th>';for(let e=1;e<=r;e++){t+=`<th><div>${new Date(o,n,e).toLocaleString("default",{weekday:"short"})}</div><div>${e}</div></th>`}t+="</tr>",e&&e.querySelector("thead")?e.querySelector("thead").innerHTML=t:console.error("No se encontr√≥ la cabecera de la tabla")}i(l),i(s),i(c),asignarDomingosLibres(o,n,r);let d="";empleados.forEach(e=>{if("nocturno"===(e.tipoTurno||"diurno"))return;const t=escapeHtml(e.nombre);d+=`<tr><td class="text-left p-2">${t}</td>`;for(let a=1;a<=r;a++){const r=`${o}-${String(n+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`,l=feriadosChile.includes(r),s=e.turnos[a-1]||"";let c=s;!l||""!==s||"Sergio Castillo"!==e.nombre&&"Ignacio Aburto"!==e.nombre||(c="F");d+=`\n        <td>\n          <button\n            data-date="${r}"\n            data-empleado="${t}"\n            data-day="${a}"\n            class="calendar-day w-full h-full ${"DL"===s?"domingo-libre":""} ${"F"===c?"feriado":""}"\n            ${"V"===s?'title="Vacaciones"':""}\n          >\n            ${"V"===s?vacationIcon:c}\n          </button>\n        </td>\n      `}d+="</tr>"});d+=`\n    <tr>\n      <td class="bitacora-row" style="white-space:nowrap;">Encargado de Bit√°cora</td>\n      <td class="bitacora-row" colspan="${r+1-1}" style="text-align:center;">\n        ${bitacoraEmployees[(n-1+bitacoraEmployees.length)%bitacoraEmployees.length]}\n      </td>\n    </tr>\n  `;const u=l.querySelector("tbody");u?u.innerHTML=d:console.error("No se encontr√≥ el tbody de la tabla general");let m="";const g=empleados.filter(e=>"nocturno"===(e.tipoTurno||"diurno"));console.log(`[NOCTURNO] Empleados nocturnos encontrados: ${g.length}`,g.map(e=>e.nombre)),g.forEach(e=>{const t=[];for(let e=1;e<=r;e++){const a=new Date(o,n,e),r=`${o}-${String(n+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,l=feriadosChile.includes(r),s=a.getDay();t[e-1]=l?"F":0===s?"DL":6===s?"L":"N"}m+=`<tr><td class="text-left p-2">${e.nombre}</td>`;for(let a=1;a<=r;a++){const r=t[a-1];let l="";"DL"===r?l="domingo-libre":"L"===r?l="dia-libre":"N"===r&&(l="nocturno");const s="F"===r?"feriado":"",c=`${o}-${String(n+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`;m+=`\n        <td>\n          <button \n            data-date="${c}"\n            data-empleado="${e.nombre}"\n            data-day="${a}"\n            class="calendar-day w-full h-full ${l} ${s}">\n            ${r}\n          </button>\n        </td>\n      `}m+="</tr>"});const f=s.querySelector("tbody");f?f.innerHTML=m:console.error("No se encontr√≥ el tbody de la tabla nocturna");let h='<tr><td class="text-left p-2">Turno Nocturno</td>';for(let e=1;e<=r;e++){const t=new Date(o,n,e),a=`${o}-${String(n+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,r=t.getDay();let l="";feriadosChile.includes(a)?l+=" feriado":0===r?l+=" domingo-libre":6===r&&(l+=" dia-libre"),h+=`\n      <td>\n        <button\n          data-date="${a}"\n          data-empleado="Turno Nocturno"\n          data-day="${e}"\n          class="calendar-day w-full h-full ${l}">\n        </button>\n      </td>\n    `}h+="</tr>";const y=c.querySelector("tbody");y?y.innerHTML=h:console.error("No se encontr√≥ el tbody de la tabla de feriados"),document.querySelectorAll(".calendar-day").forEach(e=>{if("F"===e.textContent.trim()){const t=e.getAttribute("data-date");if(feriadosChile.includes(t)){const o=feriadosInfo[t]||"Feriado";e.setAttribute("title","Feriado: "+o)}}}),usuarioEsAdmin&&attachAdminCellListeners(),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons()}function todosLosDiasRellenos(){const e=document.querySelectorAll("#general-calendar .calendar-day, #nocturno-calendar .calendar-day");for(let t of e)if(""===t.innerHTML.trim())return!1;return!0}const SHIFT_MAP={S:"Sergio Castillo",I:"Ignacio Aburto",M:"Manuel (Demo)",J:"Julio (Demo)"},FACTOR_HORA_EXTRA=.0077777;let salariosCache={};async function cargarSalarios(){try{if("superadmin"!==localStorage.getItem("userRole"))return{};const e=await db.collection("Config").doc("salarios_noc").get();if(e.exists)return salariosCache=e.data(),salariosCache}catch(e){console.warn("No se pudieron cargar los salarios (posible falta de permisos):",e)}return{}}async function actualizarSalario(e,t){try{if("superadmin"!==localStorage.getItem("userRole"))throw new Error("No autorizado");return salariosCache[e]=parseInt(t),await db.collection("Config").doc("salarios_noc").set({[e]:parseInt(t)},{merge:!0}),!0}catch(e){return console.error("Error al guardar salario:",e),Swal.fire("Error","No se pudo guardar el sueldo.","error"),!1}}async function calcularHorasExtras(e){const t=e.getFullYear(),o=e.getMonth(),n={};Object.values(SHIFT_MAP).forEach(e=>{n[e]={count:0,hours:0}});const a=e=>{const t=SHIFT_MAP[e];t&&n[t]&&n[t].count++},r=new Date(t,o-1,1),l=obtenerClaveMes(r),s=localStorage.getItem(l);let c=null;if(s)try{c=JSON.parse(s)}catch(e){console.error("Error parseando JSON local mes anterior:",e)}if(!c)try{let e=await db.collection("calendarios").doc(l).get();if(!e.exists){const t=r.toLocaleString("default",{month:"long"}),o=`${t} ${r.getFullYear()}`;console.log(`[Horas Extra] Intentando fallback Firestore: ${o}`),e=await db.collection("calendarios").doc(o).get()}e.exists&&(c=e.data(),localStorage.setItem(l,JSON.stringify(c)),console.log("[Horas Extra] Datos mes anterior recuperados de Firestore y cacheados."))}catch(e){console.error("Error obteniendo mes anterior de Firestore:",e)}if(c){const e=e=>{Object.entries(e).forEach(([e,t])=>{parseInt(e,10)>=26&&a(t)})};if(c.assignments||c.feriados||c.nocturno)c.feriados&&e(c.feriados);else if(c.feriadosHTML){(new DOMParser).parseFromString(c.feriadosHTML,"text/html").querySelectorAll("button.calendar-day").forEach(e=>{const t=parseInt(e.getAttribute("data-day"),10),o=e.textContent.trim();t>=26&&a(o)})}}return document.querySelectorAll("#feriados-calendar button.calendar-day").forEach(e=>{const t=parseInt(e.getAttribute("data-day"),10),o=e.textContent.trim();t<=25&&a(o)}),Object.keys(n).forEach(e=>{n[e].hours=5*n[e].count}),"superadmin"===localStorage.getItem("userRole")&&await cargarSalarios(),renderOvertimeTable(n,e),n}async function renderOvertimeTable(e,t){const o=document.getElementById("overtime-report-container");if(!o)return;const n="superadmin"===localStorage.getItem("userRole"),a=n?salariosCache:{},r=t.getFullYear(),l=t.getMonth(),s=new Date(r,l-1,26),c=new Date(r,l,25),i={month:"short",day:"numeric"},d=`${s.toLocaleDateString("es-ES",i)} - ${c.toLocaleDateString("es-ES",i)}`;let u=0,m=0,g="N/A",f=-1,h=0;const y=[],p=["Sergio Castillo","Ignacio Aburto"];Object.entries(e).forEach(([e,t])=>{if(t.count>0||p.includes(e)){let o=0,r=0;n&&(r=a[e]||0,o=Math.round(.0077777*r*t.hours),h+=o),y.push({name:e,...t,dinero:o,sueldoBase:r}),u+=t.hours,m+=t.count,t.hours>f&&(f=t.hours,g=e)}}),0===u&&(g="-");const b=(new Date).getDate(),E=b>=20&&b<=25;let S="";E&&(S='<div class="reminder-tooltip"><i data-lucide="bell-ring"></i> Recordatorio: Descargar reporte antes del 25</div>');let C=`\n    <div class="report-header">\n      <div class="report-title-group">\n        <h3>\n          <i data-lucide="bar-chart-2" style="color: #7796cb;"></i>\n          Control de Horas Extras\n          ${n?'<span style="font-size:0.7em; background:#2c3e50; color:#4cd137; padding:2px 8px; border-radius:12px; border:1px solid #4cd137; margin-left:10px;">\n         <i data-lucide="shield-check" style="width:12px; vertical-align:middle"></i> VISTA FINANCIERA\n       </span>':""}\n        </h3>\n        <span class="report-period">\n          <i data-lucide="calendar" style="width: 14px; display: inline-block; vertical-align: middle;"></i> \n          ${d}\n        </span>\n      </div>\n      <div class="report-actions">\n        ${S}\n        <button onclick="exportarReporteHorasExtras()" class="btn-premium-export ${E?"pulse-reminder":""}">\n          <i data-lucide="file-down"></i> Exportar PDF ${n?"(Seguro)":""}\n        </button>\n      </div>\n    </div>\n  `;if(C+=`\n    <div class="summary-cards-grid">\n      \x3c!-- Card 1: Total Horas --\x3e\n      <div class="summary-card accent-purple">\n        <div class="card-header">\n          <div class="card-icon"><i data-lucide="clock"></i></div>\n          <span class="card-label">Total Horas</span>\n        </div>\n        <div class="card-value">${u}</div>\n        <div class="card-subtext">Horas acumuladas este periodo</div>\n      </div>\n  `,n){const e="$ "+h.toLocaleString("es-CL");C+=`\n      \x3c!-- Card 2: Dinero (Superadmin Only) --\x3e\n      <div class="summary-card accent-blue">\n        <div class="card-header">\n          <div class="card-icon"><i data-lucide="dollar-sign"></i></div>\n          <span class="card-label">Total a Pagar</span>\n        </div>\n        <div class="card-value" style="color: #4cd137;">${e}</div>\n        <div class="card-subtext">Estimado (Factor Legal)</div>\n      </div>\n    `}else C+=`\n      \x3c!-- Card 2: Top Contributor (Admin) --\x3e\n      <div class="summary-card accent-blue">\n        <div class="card-header">\n          <div class="card-icon"><i data-lucide="award"></i></div>\n          <span class="card-label">Mayor Colaborador</span>\n        </div>\n        <div class="card-value" style="font-size: 1.5rem;">${g.split(" ")[0]}</div>\n        <div class="card-subtext">${f>0?f+" horas registradas":"Sin registros"}</div>\n      </div>\n    `;C+=`\n      \x3c!-- Card 3: Total Turnos --\x3e\n      <div class="summary-card accent-green">\n        <div class="card-header">\n          <div class="card-icon"><i data-lucide="layers"></i></div>\n          <span class="card-label">Turnos Extra</span>\n        </div>\n        <div class="card-value">${m}</div>\n        <div class="card-subtext">Total turnos cubiertos</div>\n      </div>\n    </div>\n  `;const v=n?"15%":"20%";C+=`\n    <div class="premium-table-container">\n      <table class="premium-table">\n        <thead>\n          <tr>\n            <th style="width: ${n?"25%":"40%"};">Empleado</th>\n            <th style="width: ${v}; text-align: center;">Turnos</th>\n            <th style="width: ${v}; text-align: center;">Horas</th>\n            ${n?'<th style="width: 20%; text-align: center;">Sueldo Base</th>':""}\n            ${n?'<th style="width: 20%; text-align: center; color: #4cd137;">A Pagar (50%)</th>':""}\n            <th style="width: ${v}; text-align: center;">Estado</th>\n          </tr>\n        </thead>\n        <tbody>\n  `,y.forEach(e=>{const t=e.name.split(" ").map(e=>e[0]).join("").substring(0,2);let o="normal",a="Normal",r="check-circle";e.hours>=40?(o="critical",a="Cr√≠tico",r="alert-circle"):e.hours>=20&&(o="high",a="Alto",r="alert-triangle");const l=n?`onclick="editarSueldoBase('${e.name}', ${e.sueldoBase})"`:"",s=n?"cursor: pointer; text-decoration: underline; text-decoration-style: dotted;":"";C+=`\n      <tr>\n        <td>\n          <div class="employee-cell">\n            <div class="avatar-ring">\n              <div class="avatar-inner">${t}</div>\n            </div>\n            <div class="employee-info-text">\n              <span class="employee-name-small" style="font-size: 0.95rem; color: #fff;">${e.name}</span>\n              <span class="employee-role-small">NOC Operator</span>\n            </div>\n          </div>\n        </td>\n        <td style="text-align: center;">\n          <span class="metric-value" style="color: #a5b1c2;">${e.count}</span>\n        </td>\n        <td style="text-align: center;">\n          <span class="metric-value" style="color: #fff;">${e.hours}</span><span class="metric-unit"> hrs</span>\n        </td>\n        \n        ${n?`\n          <td style="text-align: center;" ${l} title="Clic para editar sueldo base">\n            <span class="metric-value" style="color: #a5b1c2; ${s}">\n              $ ${e.sueldoBase.toLocaleString("es-CL")}\n            </span>\n            ${0===e.sueldoBase?'<i data-lucide="alert-circle" style="width:12px; color:orange;"></i>':""}\n          </td>\n          <td style="text-align: center;">\n            <span class="metric-value" style="color: #4cd137; font-weight:bold;">\n              $ ${e.dinero.toLocaleString("es-CL")}\n            </span>\n          </td>\n        `:""}\n\n        <td style="text-align: center;">\n          <span class="premium-badge ${o}">\n            <i data-lucide="${r}" style="width: 12px;"></i> ${a}\n          </span>\n        </td>\n      </tr>\n    `}),C+="\n        </tbody>\n      </table>\n    </div>\n  ",n&&(C+='\n      <div style="text-align: right; margin-top: 10px; font-size: 0.8rem; color: #666;">\n        <i data-lucide="info" style="width:12px;"></i> C√°lculo: Sueldo Base * 0.0077777 * Horas Extras\n      </div>\n    '),o.innerHTML=C,"function"==typeof refreshIcons?refreshIcons():window.lucide&&lucide.createIcons()}window.editarSueldoBase=async(e,t)=>{const{value:o}=await Swal.fire({title:`Sueldo Base: ${e}`,input:"number",inputLabel:"Ingrese el sueldo base mensual (CLP)",inputValue:t,showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",inputValidator:e=>{if(!e)return"Debes ingresar un monto."}});if(o){if(await actualizarSalario(e,o)){Swal.fire({icon:"success",title:"Actualizado",text:`El nuevo sueldo base es $${parseInt(o).toLocaleString("es-CL")}`,timer:1500,showConfirmButton:!1});new Date(document.getElementById("current-month").textContent);calcularHorasExtras(window.currentDate||new Date)}}},window.exportarReporteHorasExtras=exportarReporteHorasExtras;const getBase64ImageFromURL=e=>new Promise((t,o)=>{const n=new Image;n.setAttribute("crossOrigin","anonymous"),n.onload=()=>{const e=document.createElement("canvas");e.width=n.width,e.height=n.height;e.getContext("2d").drawImage(n,0,0);const o=e.toDataURL("image/png");t(o)},n.onerror=e=>{console.warn("No se pudo cargar la imagen para el PDF (CORS o 404).",e),t(null)},n.src=e});async function exportarReporteHorasExtras(){if(!window.jspdf)return void Swal.fire("Error","Librer√≠a PDF no cargada.","error");Swal.fire({title:"Generando Reporte...",text:"Procesando datos y gr√°ficos corporativos",allowOutsideClick:!1,didOpen:()=>{Swal.showLoading()}});try{const{jsPDF:e}=window.jspdf,t=new e,o=t.internal.pageSize.width;let n=currentDate.getFullYear(),a=currentDate.getMonth(),r=new Date(n,a-1,26),l=new Date(n,a,25);const s={day:"numeric",month:"long",year:"numeric"},c=r.toLocaleDateString("es-ES",s),i=`Del ${c} al ${l.toLocaleDateString("es-ES",s)}`,d=(new Date).toLocaleString("es-CL"),u=await calcularHorasExtras(currentDate),m="https://i.ibb.co/HqrX2cr/LOGO-COLOR-2-SLOGAN-768x185.png",g=await getBase64ImageFromURL(m),f=[15,23,42];t.setFillColor(...f),t.rect(0,0,o,6,"F"),g?t.addImage(g,"PNG",14,18,40,10):(t.setFont("helvetica","bold"),t.setFontSize(22),t.setTextColor(...f),t.text("PatagoniaIP",14,25)),t.setFont("helvetica","bold"),t.setTextColor(...f),t.setFontSize(22),t.text("REPORTE DE HORAS EXTRAS",o-14,25,{align:"right"}),t.setFont("helvetica","normal"),t.setFontSize(9),t.setTextColor(100,116,139),t.text("DEPARTAMENTO DE OPERACIONES NOC",o-14,32,{align:"right"}),t.text(i.toUpperCase(),o-14,37,{align:"right"}),t.setDrawColor(226,232,240),t.setLineWidth(.5),t.line(14,45,o-14,45);let h=0,y=0,p="-",b=0;const E=["Sergio Castillo","Ignacio Aburto"],S=[];Object.entries(u).forEach(([e,t])=>{(t.count>0||E.includes(e))&&(h+=t.hours,y+=t.count,t.hours>b&&(b=t.hours,p=e),S.push([e,t.count,t.hours+" hrs",t.hours>=40?"CR√çTICO":t.hours>=20?"ALTO":"NORMAL"]))});const C=60,v=(o-28-10)/3,L=28,w=(e,o,n,a)=>{t.setFillColor(248,250,252),t.roundedRect(e,C,v,L,3,3,"F"),t.setDrawColor(226,232,240),t.setLineWidth(.1),t.roundedRect(e,C,v,L,3,3,"S"),t.setFillColor(...a),t.rect(e,C,2,L,"F"),t.setFont("helvetica","bold"),t.setFontSize(14),t.setTextColor(...f),t.text(n.toString(),e+10,C+12),t.setFont("helvetica","bold"),t.setFontSize(7),t.setTextColor(148,163,184),t.text(o.toUpperCase(),e+10,C+20)};w(14,"Total Horas",h+" hrs",[59,130,246]),w(14+v+5,"Total Turnos",y,[16,185,129]),w(14+2*(v+5),"Mayor Colaborador",p.split(" ")[0],[245,158,11]),t.setFont("helvetica","italic"),t.setFontSize(7),t.setTextColor(150,150,150),t.text(`Generado: ${d}`,14,C+L+8),t.autoTable({startY:C+L+15,head:[["EMPLEADO","TURNOS","HORAS","ESTADO"]],body:S,theme:"grid",styles:{fontSize:9,cellPadding:8,lineColor:[226,232,240],lineWidth:.1,font:"helvetica",textColor:[71,85,105]},headStyles:{fillColor:[241,245,249],textColor:[30,41,59],fontStyle:"bold",halign:"left",lineWidth:0},columnStyles:{0:{cellWidth:"auto",fontStyle:"bold",textColor:[15,23,42]},1:{halign:"center",cellWidth:32},2:{halign:"center",cellWidth:35},3:{halign:"center",cellWidth:35,fontStyle:"bold"}},alternateRowStyles:{fillColor:[255,255,255]},didParseCell:function(e){if("body"===e.section&&3===e.column.index){const t=e.cell.raw;e.cell.styles.textColor="CR√çTICO"===t?[220,38,38]:"ALTO"===t?[217,119,6]:[22,163,74]}}});const A=t.lastAutoTable.finalY+10;t.setFontSize(8),t.setTextColor(150,150,150),t.text("PatagoniaIP - Conexi√≥n que transforma realidades",o/2,A+10,{align:"center"}),t.save(`Reporte_NOC_${n}_${a+1}.pdf`);const I=t.output("blob"),M=`Reporte_NOC_${n}_${a+1}.pdf`,x=new File([I],M,{type:"application/pdf"}),D=`Hola RRHH, adjunto reporte de horas extras del periodo ${i}.`;Swal.close(),navigator.canShare&&navigator.canShare({files:[x]})?Swal.fire({title:"Reporte Listo",text:"¬øDeseas enviarlo por WhatsApp a RRHH ahora?",icon:"success",showCancelButton:!0,confirmButtonText:"Enviar ahora üöÄ",cancelButtonText:"Solo guardar",confirmButtonColor:"#25D366"}).then(async e=>{if(e.isConfirmed)try{await navigator.share({files:[x],title:"Reporte Horas Extras",text:D})}catch(e){console.log("Compartir cancelado o error:",e)}}):Swal.fire({title:"Reporte Descargado",html:`El archivo se ha guardado en tu PC.<br>Para enviar a RRHH:<br>1. Presiona el bot√≥n abajo.<br>2. Adjunta el archivo <b>${M}</b>.`,icon:"success",showCancelButton:!0,confirmButtonText:"Abrir WhatsApp Web",cancelButtonText:"Cerrar",confirmButtonColor:"#25D366"}).then(e=>{if(e.isConfirmed){const e=`https://wa.me/?text=${encodeURIComponent(D)}`;window.open(e,"_blank")}})}catch(e){Swal.close(),console.error("Error al generar PDF:",e),Swal.fire("Error","No se pudo generar el reporte PDF: "+e.message,"error")}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("btnExportarExtras");e&&e.addEventListener("click",exportarReporteHorasExtras)});let isSelecting=!1,isDeselecting=!1;function adminMousedown(e,t){const o=t||this;if(0===e.button)isSelecting=!0,o.classList.contains("selected")||(o.classList.add("selected"),selectedDays.push(o));else if(2===e.button){isDeselecting=!0,o.classList.contains("selected")&&(o.classList.remove("selected"),selectedDays=selectedDays.filter(e=>e!==o)),o.textContent="",o.innerHTML="",o.removeAttribute("style"),o.className="calendar-day w-full h-full",o.removeAttribute("title");const e=o.closest("tr");e&&checkWeeklyHours(e),scheduleFirestoreUpdate()}}function adminMouseover(e,t){const o=t||this;if(usuarioEsAdmin)if(isSelecting)o.classList.contains("selected")||(o.classList.add("selected"),selectedDays.push(o));else if(isDeselecting){o.classList.contains("selected")&&(o.classList.remove("selected"),selectedDays=selectedDays.filter(e=>e!==o)),o.textContent="",o.innerHTML="",o.removeAttribute("style"),o.className="calendar-day w-full h-full",o.removeAttribute("title");const e=o.closest("tr");e&&checkWeeklyHours(e),scheduleFirestoreUpdate()}}function adminContextmenu(e){return e.preventDefault(),!1}function adminMouseup(e){usuarioEsAdmin&&(isSelecting=!1,isDeselecting=!1)}function setupAdminEventDelegation(){console.log("üîß setupAdminEventDelegation: Inicializando event delegation");const e=document.body;e.addEventListener("mousedown",e=>{if(console.log("üñ±Ô∏è Click detectado. usuarioEsAdmin =",usuarioEsAdmin),!usuarioEsAdmin)return void console.warn("‚õî Click bloqueado: usuario no es admin");const t=e.target.closest(".calendar-day");console.log("üéØ Target encontrado:",t),t&&(console.log("‚úÖ Ejecutando adminMousedown"),adminMousedown(e,t))}),e.addEventListener("mouseover",e=>{if(!usuarioEsAdmin)return;const t=e.target.closest(".calendar-day");t&&adminMouseover(e,t)}),e.addEventListener("contextmenu",e=>{e.target.closest(".calendar-day")&&usuarioEsAdmin&&e.preventDefault()}),document.addEventListener("mouseup",()=>{usuarioEsAdmin&&(isSelecting=!1,isDeselecting=!1)}),console.log("‚úÖ Event delegation configurado correctamente")}function attachAdminCellListeners(){}const btnGuardar=document.getElementById("btnGuardar"),btnCargar=document.getElementById("btnCargar"),btnEliminar=document.getElementById("btnEliminar"),selectMeses=document.getElementById("mesesGuardados"),modal=document.getElementById("modalCalendario"),modalContent=document.getElementById("contenidoModal"),cerrarModal=document.getElementById("cerrarModal"),btnVerHorarios=document.getElementById("btnVerHorarios"),modalHorarios=document.getElementById("modalHorarios"),cerrarHorarios=document.getElementById("cerrarHorarios"),btnVerEstadisticas=document.getElementById("btnVerEstadisticas"),modalEstadisticas=document.getElementById("modalEstadisticas"),cerrarEstadisticas=document.getElementById("cerrarEstadisticas"),estadisticasContenido=document.getElementById("estadisticas-contenido");function cargarListaCalendarios(){const e=document.getElementById("selectMeses");e&&db.collection("calendarios").get().then(t=>{e.innerHTML='<option value="">-- Seleccione un mes guardado --</option>',t.forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.id,e.appendChild(o)})}).catch(e=>{console.error("Error al cargar calendarios:",e)})}function cargarFotosEmpleados(){document.querySelectorAll(".employee-card").forEach(e=>{const t=e.querySelector("span"),o=e.querySelector(".employee-photo");if(!t||!o)return;const n=t.textContent.trim();db.collection("empleados").doc(n).get().then(e=>{if(e.exists){const t=e.data();t.photoURL&&(o.src=t.photoURL)}}).catch(e=>{console.error("Error al leer la foto de Firestore:",e)})})}function calcularEstadisticas(){const e=document.querySelectorAll("#general-calendar .calendar-day"),t={};return e.forEach(e=>{const o=e.textContent.trim();o&&(t[o]=(t[o]||0)+1)}),t}function calcularTurnosPorEmpleado(){const e={};return document.querySelectorAll("#general-calendar tbody tr").forEach(t=>{const o=t.querySelector("td")?.textContent.trim();o&&"Encargado de Bit√°cora"!==o&&(e[o]=e[o]||{},t.querySelectorAll("td button.calendar-day").forEach(t=>{const n=t.textContent.trim();n&&(e[o][n]=(e[o][n]||0)+1)}))}),Object.entries(e).map(([e,t])=>{let o="-",n="-",a=0,r=1/0;return Object.entries(t).forEach(([e,t])=>{t>a&&(a=t,o=e),t<r&&(r=t,n=e)}),{empleado:e,turnoMasAsignado:o,turnoMenosAsignado:n}})}function mostrarEstadisticas(){const e=calcularEstadisticas(),t=calcularTurnosPorEmpleado();let o="-",n="-",a=0,r=1/0;Object.entries(e).forEach(([e,t])=>{t>a&&(a=t,o=e),t<r&&(r=t,n=e)}),document.getElementById("total-turnos").textContent=Object.values(e).reduce((e,t)=>e+t,0),document.getElementById("turno-mas-usado").textContent=o,document.getElementById("turno-menos-usado").textContent=n;document.getElementById("tabla-turnos-empleados").innerHTML=t.map(({empleado:e,turnoMasAsignado:t,turnoMenosAsignado:o})=>`\n    <tr>\n      <td>${e}</td>\n      <td>${t}</td>\n      <td>${o}</td>\n    </tr>\n  `).join(""),generarGraficoBarras(e),generarGraficoPastel(t),generarGraficoLineas(e),modalEstadisticas.style.display="block"}async function analizarHistorialTurnos(){console.log("[AN√ÅLISIS] Iniciando an√°lisis de historial...");const e={},t=["dom","lun","mar","mie","jue","vie","sab"];try{const o=await db.collection("calendarios").get();return console.log(`[AN√ÅLISIS] Encontrados ${o.size} meses de datos`),o.forEach(o=>{const n=o.data(),a=o.id;let r,l;const s=a.toLowerCase().split(" ");if(2===s.length){l=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"].indexOf(s[0]),r=parseInt(s[1])}if(isNaN(r)||l<0)return void console.warn(`[AN√ÅLISIS] No se pudo parsear mes: ${a}`);let c={};if(n.assignments&&"object"==typeof n.assignments)c=n.assignments;else if(n.generalHTML){(new DOMParser).parseFromString(n.generalHTML,"text/html").querySelectorAll("tbody tr").forEach(e=>{const t=e.querySelector("td:first-child");if(!t)return;const o=t.textContent.trim();"Encargado de Bit√°cora"!==o&&(c[o]={},e.querySelectorAll("button.calendar-day").forEach(e=>{const t=e.getAttribute("data-day");let n=e.textContent.trim();(e.innerHTML.includes("tree-palm")||e.innerHTML.includes("lucide"))&&(n="V"),n&&t&&(c[o][t]=n)}))})}Object.entries(c).forEach(([o,n])=>{e[o]||(e[o]={totalDays:0,shiftCounts:{},dayPatterns:{},weeklyPatterns:[]});const a=e[o];Object.entries(n).forEach(([e,o])=>{const n=parseInt(e);if(isNaN(n))return;const s="object"==typeof o?o.code:o;if(!s||""===s||"V"===s||"L"===s||"DL"===s||"F"===s)return;const c=new Date(r,l,n),i=t[c.getDay()];a.totalDays++,a.shiftCounts[s]=(a.shiftCounts[s]||0)+1,a.dayPatterns[i]||(a.dayPatterns[i]={}),a.dayPatterns[i][s]=(a.dayPatterns[i][s]||0)+1})})}),Object.entries(e).forEach(([e,t])=>{const o=Object.entries(t.shiftCounts).sort((e,t)=>t[1]-e[1]);t.preferredShifts=o.slice(0,3).map(e=>e[0]),t.dayProbabilities={},Object.entries(t.dayPatterns).forEach(([e,o])=>{const n=Object.values(o).reduce((e,t)=>e+t,0);t.dayProbabilities[e]={},Object.entries(o).forEach(([o,a])=>{t.dayProbabilities[e][o]=a/n})})}),console.log("[AN√ÅLISIS] Perfiles generados:",e),window.EMPLOYEE_PROFILES=e,e}catch(e){return console.error("[AN√ÅLISIS] Error analizando historial:",e),{}}}function elegirTurnoPorPerfil(e,t,o){const n=(window.EMPLOYEE_PROFILES||{})[e];if(!n||!n.dayProbabilities||!n.dayProbabilities[t]){if(n&&n.preferredShifts&&n.preferredShifts.length>0){const e=n.preferredShifts.filter(e=>o.includes(e));if(e.length>0)return e[Math.floor(Math.random()*e.length)]}return o[Math.floor(Math.random()*o.length)]}const a=n.dayProbabilities[t],r=Math.random();let l=0;const s=Object.entries(a).filter(([e])=>o.includes(e));if(0===s.length)return o[Math.floor(Math.random()*o.length)];const c=s.reduce((e,[,t])=>e+t,0);for(const[e,t]of s)if(l+=t/c,r<=l)return e;return s[0][0]}let chartBarras,chartPastel,chartLineas;function generarGraficoBarras(e){const t=document.getElementById("graficoTurnos").getContext("2d");chartBarras&&chartBarras.destroy(),chartBarras=new Chart(t,{type:"bar",data:{labels:Object.keys(e),datasets:[{label:"Frecuencia de Turnos",data:Object.values(e),backgroundColor:"#7796cb"}]},options:{responsive:!0}})}function generarGraficoPastel(e){const t=document.getElementById("graficoEmpleados").getContext("2d");chartPastel&&chartPastel.destroy();const o=e.map(e=>e.empleado),n=e.map(()=>1);chartPastel=new Chart(t,{type:"pie",data:{labels:o,datasets:[{label:"Turnos por empleado",data:n,backgroundColor:["#8FBCBB","#88C0A6","#D77A7A","#7796cb","#b5e7a0","#ffcc99"]}]},options:{responsive:!0}})}function generarGraficoLineas(e){const t=document.getElementById("graficoTendencias").getContext("2d");chartLineas&&chartLineas.destroy(),chartLineas=new Chart(t,{type:"line",data:{labels:Object.keys(e),datasets:[{label:"Tendencia de Turnos",data:Object.values(e),borderColor:"#7796cb",fill:!1}]},options:{responsive:!0}})}async function actualizarTransicion(e,t,o){const n=db.collection("patronesTurnosMarkov").doc(e);try{const e=await n.get();let a={};e.exists&&(a=e.data()),a[t]||(a[t]={}),a[t][o]=(a[t][o]||0)+1,await n.set(a,{merge:!0})}catch(t){console.error(`Error actualizando transici√≥n para ${e}:`,t)}}async function obtenerMatrizTransiciones(e){try{const t=await db.collection("patronesTurnosMarkov").doc(e).get();if(t.exists)return t.data()}catch(t){console.error(`Error obteniendo matriz para ${e}:`,t)}return{}}function elegirSiguienteTurnoMarkov(e,t,o){if(!e[t]||0===Object.keys(e[t]).length)return o[Math.floor(Math.random()*o.length)];const n=e[t],a=Object.values(n).reduce((e,t)=>e+t,0),r=Math.random()*a;let l=0;for(let e of o)if(l+=n[e]||0,r<=l)return e;return o[0]}let unsubscribeCalendar=null;function subscribeCalendar(){const e=document.getElementById("current-month").textContent.trim();unsubscribeCalendar&&unsubscribeCalendar(),unsubscribeCalendar=db.collection("calendarios").doc(e).onSnapshot(e=>{if(e.exists){if(isSelecting||isDeselecting||saveCooldown)return void console.log("[SYNC] Bloqueado (selecci√≥n activa o cooldown post-guardado).");const t=e.data(),o=document.getElementById("general-calendar"),n=document.getElementById("nocturno-calendar"),a=document.getElementById("feriados-calendar"),r=selectedDays.map(e=>({date:e.getAttribute("data-date"),empleado:e.getAttribute("data-empleado"),day:e.getAttribute("data-day")}));o&&t.generalHTML&&(o.outerHTML=t.generalHTML),n&&t.nocturnoHTML&&(n.outerHTML=t.nocturnoHTML),a&&t.feriadosHTML&&(a.outerHTML=t.feriadosHTML),isMonthLocked=!!t.locked,updateLockUI(),isMonthLocked||(agregarEmpleadosFaltantes(),agregarEmpleadosNocturnosFaltantes()),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons(),usuarioEsAdmin&&attachAdminCellListeners(),calcularHorasExtras(currentDate);document.querySelectorAll("#general-calendar tbody tr").forEach(e=>checkWeeklyHours(e)),selectedDays=[],r.length>0&&r.forEach(e=>{const t=`button[data-date="${e.date}"][data-day="${e.day}"]`;document.querySelectorAll(t).forEach(t=>{t.getAttribute("data-empleado")===e.empleado&&(t.classList.add("selected"),selectedDays.push(t))})})}else renderCalendar(currentDate),usuarioEsAdmin&&attachAdminCellListeners()})}let updateTimeout=null,saveCooldown=!1;function scheduleFirestoreUpdate(){isMonthLocked?console.warn("El mes est√° cerrado. No se guardan cambios."):(saveCooldown=!0,clearTimeout(updateTimeout),updateTimeout=setTimeout(()=>{updateTimeout=null;const e=obtenerDatosCalendario();console.log(`[SAVE] Guardando ${e.mes}...`),db.collection("calendarios").doc(e.mes).set(e).then(()=>{console.log(`[SAVE] OK: ${e.mes}`),setTimeout(()=>{saveCooldown=!1},3e3)}).catch(e=>{console.error("[SAVE] Error:",e),saveCooldown=!1}),guardarCalendarioEnLocalStorage(),calcularHorasExtras(currentDate)},1500))}function aplicarAsignacionesV2(e){const t=document.getElementById("general-calendar");if(!t)return;new Set((window.empleados||[]).map(e=>e.nombre));Object.entries(e).forEach(([e,o])=>{const n=Array.from(t.querySelectorAll("tbody tr")).find(t=>t.querySelector("td")?.textContent.trim()===e);n&&Object.entries(o).forEach(([e,t])=>{const o=n.querySelector(`button[data-day="${e}"]`);if(o){const e="object"==typeof t?t.code:t,n="object"==typeof t?t.color:null;actualizarBotonTurno(o,e),n&&(o.style.backgroundColor=n,o.style.color="#000")}})})}function initPrevMonthPanel(){const e=document.getElementById("btn-preview-prev-month"),t=document.getElementById("prev-month-panel"),o=document.getElementById("close-prev-month-panel"),n=document.querySelector(".prev-month-panel-header");if(console.log("[initPrevMonthPanel] FAB button:",e),console.log("[initPrevMonthPanel] Panel:",t),e&&t){if(e.addEventListener("click",()=>{console.log("[FAB Click] Abriendo panel del mes anterior..."),openPrevMonthPanel()}),o?(console.log("[initPrevMonthPanel] Bot√≥n cerrar encontrado, agregando listener"),o.addEventListener("click",e=>{e.stopPropagation(),console.log("[Close Button] Cerrando panel..."),closePrevMonthPanel()})):console.warn("[initPrevMonthPanel] Bot√≥n cerrar NO encontrado"),document.addEventListener("keydown",e=>{"Escape"===e.key&&t.classList.contains("active")&&closePrevMonthPanel()}),n){let a,r,l,s,c=!1;function i(e){if(e.target.closest(".btn-close-panel"))return;c=!0;const o=e.touches?e.touches[0]:e;a=o.clientX,r=o.clientY;const n=t.getBoundingClientRect();l=n.left,s=n.top,t.style.transition="none",document.addEventListener("mousemove",d),document.addEventListener("mouseup",u),document.addEventListener("touchmove",d,{passive:!1}),document.addEventListener("touchend",u),e.preventDefault()}function d(e){if(!c)return;const o=e.touches?e.touches[0]:e,n=o.clientX-a,i=o.clientY-r;let d=l+n,u=s+i;const m=window.innerWidth-t.offsetWidth,g=window.innerHeight-t.offsetHeight;d=Math.max(0,Math.min(d,m)),u=Math.max(0,Math.min(u,g)),t.style.left=d+"px",t.style.top=u+"px",t.style.right="auto",e.preventDefault()}function u(){c=!1,t.style.transition="",document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",u),document.removeEventListener("touchmove",d),document.removeEventListener("touchend",u)}n.addEventListener("mousedown",i),n.addEventListener("touchstart",i,{passive:!1})}}else console.warn("[initPrevMonthPanel] FAB o Panel no encontrados, abortando init")}function openPrevMonthPanel(){const e=document.getElementById("prev-month-panel"),t=document.getElementById("prev-month-loading"),o=document.getElementById("prev-month-content");e.classList.add("active"),e.style.display="flex",t&&(t.style.display="flex"),o&&o.classList.remove("loaded"),loadPrevMonthData(),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}function closePrevMonthPanel(){const e=document.getElementById("prev-month-panel");e.classList.remove("active"),e.style.display="none"}function refreshPrevMonthPanelIfOpen(){const e=document.getElementById("prev-month-panel");e&&e.classList.contains("active")&&(console.log("[Prev Month Panel] Refrescando datos por cambio de mes"),loadPrevMonthData())}async function loadPrevMonthData(){const e=document.getElementById("prev-month-loading"),t=document.getElementById("prev-month-content"),o=document.getElementById("prev-month-title"),n=new Date(currentDate);n.setMonth(n.getMonth()-1);const a=n.getFullYear(),r=n.getMonth(),l=n.toLocaleString("es",{month:"long"}),s=l.charAt(0).toUpperCase()+l.slice(1);o.textContent=`${s} ${a}`;const c=`calendar_v3_${a}-${r+1}`;let i=null;console.log("[Prev Month Panel] Buscando datos con clave:",c);try{const e=localStorage.getItem(c);e&&(i=JSON.parse(e),console.log("[Prev Month Panel] Datos encontrados en localStorage"))}catch(e){console.warn("[Prev Month Panel] Error leyendo localStorage:",e)}if(!i||!i.assignments||0===Object.keys(i.assignments).length)try{const e=`${s} ${a}`,t=`${l} ${a}`;console.log("[Prev Month Panel] Buscando en Firestore con docId:",e,"o",t);let o=await db.collection("calendarios").doc(e).get();if(o.exists||(o=await db.collection("calendarios").doc(t).get()),o.exists){const e=o.data();if(console.log("[Prev Month Panel] Datos encontrados en Firestore"),e.generalHTML&&!e.assignments){console.log("[Prev Month Panel] Convirtiendo formato HTML a assignments..."),i={assignments:{}};const t=document.createElement("div");t.innerHTML=e.generalHTML,t.querySelectorAll("tbody tr").forEach(e=>{const t=e.querySelector("td:first-child");if(!t)return;const o=t.textContent.replace(/\s*\(Ex\)\s*$/,"").trim();if("Encargado de Bit√°cora"===o||!o)return;const n={};e.querySelectorAll("button.calendar-day").forEach(e=>{const t=e.getAttribute("data-day");let o=e.textContent.trim();(e.querySelector('[data-lucide="tree-palm"]')||e.innerHTML.includes("tree-palm")||e.innerHTML.includes("üå¥"))&&(o="V"),o&&t&&(n[t]=o)}),Object.keys(n).length>0&&(i.assignments[o]=n)}),console.log("[Prev Month Panel] Conversi√≥n completada. Empleados:",Object.keys(i.assignments).length)}else i=e}else console.log("[Prev Month Panel] No hay documento en Firestore para:",docId)}catch(e){console.warn("[Prev Month Panel] Error leyendo Firestore:",e)}e&&(e.style.display="none"),t&&t.classList.add("loaded"),renderMiniCalendar(t,i,a,r)}function renderMiniCalendar(e,t,o,n){const a=new Date(o,n+1,0).getDate();if(!t||!t.assignments||0===Object.keys(t.assignments).length)return e.innerHTML='\n      <div style="text-align:center; padding:2rem; color:var(--color-texto-secundario);">\n        <i data-lucide="calendar-x" style="width:48px;height:48px;margin-bottom:1rem;opacity:0.5;"></i>\n        <p>No hay datos guardados para este mes</p>\n      </div>\n    ',void("function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons());let r="<tr><th>Empleado</th>";for(let e=1;e<=a;e++){const t=new Date(o,n,e);t.toLocaleString("es",{weekday:"narrow"});r+=`<th title="${t.toLocaleDateString("es")}">${e}</th>`}r+="</tr>";let l="";const s=window.SHIFT_COLORS||{M0:"#648c9b",M0A:"#7b69a5",M1:"#557a5f",M1A:"#c49f87",M1B:"#ffaaa5",M2:"#ffcc99",M2A:"#d4a5a5",M2B:"#b5e7a0",M3:"#996a7f",V:"#88C0A6",L:"#8FBCBB",DL:"#D77A7A",N:"#cccccc",S:"#4A90E2",I:"#2C3E50"},c=(window.empleados||[]).map(e=>e.nombre),i=Object.keys(t.assignments).filter(e=>"Encargado de Bit√°cora"!==e).sort((e,t)=>{const o=c.indexOf(e),n=c.indexOf(t);return-1!==o&&-1!==n?o-n:-1!==o?-1:-1!==n?1:e.localeCompare(t)});i.forEach(e=>{const o=t.assignments[e];l+=`<tr><td title="${e}">${e.split(" ")[0]}</td>`;for(let e=1;e<=a;e++){const t=o[e]||"";let n="",a=t,r="";"object"==typeof t&&(a=t.code||"",t.color&&(r=`background-color:${t.color}; color:#000;`)),"DL"===a?n="domingo-libre":"F"===a?n="feriado":"V"===a?(n="vacaciones",a="üå¥",r=`background-color:${s.V||"#88C0A6"}; color:#000;`):"L"===a?(n="dia-libre",r=`background-color:${s.L||"#8FBCBB"}; color:#000;`):"N"===a?n="nocturno":a&&s[a]&&(r=`background-color:${s[a]}; color:#000;`),!r&&"object"==typeof t&&t.color&&(r=`background-color:${t.color}; color:#000;`),l+=`<td><span class="mini-shift ${n}" style="${r}">${a}</span></td>`}l+="</tr>"}),e.innerHTML=`\n    <table class="mini-calendar">\n      <thead>${r}</thead>\n      <tbody>${l}</tbody>\n    </table>\n    <div style="text-align:center; padding-top:0.5rem;">\n      <small style="color:var(--color-texto-secundario);">\n        ${i.length} empleados ¬∑ ${a} d√≠as\n      </small>\n    </div>\n  `}document.addEventListener("DOMContentLoaded",function(){setupAdminEventDelegation(),configurarSidebar(),configurarLogout();const e=localStorage.getItem("userRole");if(("admin"===e||"superadmin"===e)&&(console.log("Aplicando rol admin desde cach√© (NOC)"),usuarioEsAdmin=!0,document.querySelectorAll(".admin-only").forEach(e=>{e.classList.remove("admin-only")}),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons(),"superadmin"===e)){const e=document.getElementById("li-registros"),t=document.getElementById("li-turnos"),o=document.getElementById("li-usuarios"),n=document.getElementById("li-animaciones");e&&(e.style.display="block"),t&&(t.style.display="block"),o&&(o.style.display="block"),n&&(n.style.display="block")}verificarRolUsuario(function(e){if(usuarioEsAdmin=e,console.log("üîê Rol verificado. usuarioEsAdmin =",usuarioEsAdmin),d(),usuarioEsAdmin){document.querySelectorAll(".admin-only").forEach(e=>{e.style.display="block",e.classList.remove("admin-only")});const e=document.getElementById("btn-preview-prev-month");e&&(e.style.display="flex",console.log("‚úÖ FAB de calendario flotante activado para admin")),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons()}const t=document.getElementById("btnAutoAsignar");t&&t.addEventListener("click",async function(){if(usuarioEsAdmin){Swal.fire({title:"Analizando patrones hist√≥ricos...",text:"Esto puede tardar unos segundos. Analizando 14 meses de datos.",showConfirmButton:!1,allowOutsideClick:!1,willOpen:()=>{Swal.showLoading()}});try{const e={M0:"#648c9b",M0A:"#7b69a5",M1:"#557a5f",M1A:"#c49f87",M1B:"#ffaaa5",M2:"#ffcc99",M2A:"#d4a5a5",M2B:"#b5e7a0",M3:"#996a7f",L:"#8FBCBB",DL:"#D77A7A",N:"#cccccc",S:"#4A90E2",I:"#2C3E50"},t=["M0","M0A","M1","M1A","M1B","M2","M2A","M2B","M3"],o=["dom","lun","mar","mie","jue","vie","sab"];await analizarHistorialTurnos(),console.log("[AUTO-ASIGNAR] Perfiles cargados:",window.EMPLOYEE_PROFILES);const n=currentDate.getFullYear(),a=currentDate.getMonth(),r=new Date(n,a+1,0).getDate(),l=document.getElementById("general-calendar").querySelector("tbody").querySelectorAll("tr");let s={};const c=[];let i={start:1,days:[]};for(let e=1;e<=r;e++){const t=new Date(n,a,e).getDay();1===t&&i.days.length>0&&(c.push(i),i={start:e,days:[]}),i.days.push({day:e,dayOfWeek:t,dayName:o[t]})}i.days.length>0&&c.push(i),console.log("[AUTO-ASIGNAR] Semanas identificadas:",c);for(let e of l){const o=e.querySelector("td");if(!o)continue;const l=o.textContent.replace(/‚ö†Ô∏è/g,"").trim();if("Encargado de Bit√°cora"===l)continue;s[l]=new Array(r).fill("");const i=window.EMPLOYEE_PROFILES?.[l];for(let e=0;e<c.length;e++){const o=c[e];let r=[...t];let d;if(Object.entries(s).some(([e,t])=>o.days.some(e=>"M1B"===t[e.day-1]))&&(r=r.filter(e=>"M1B"!==e)),i?.preferredShifts&&i.preferredShifts.length>0){const t=e%i.preferredShifts.length,o=i.preferredShifts[t];if(r.includes(o))d=o;else{d=i.preferredShifts.filter(e=>r.includes(e))[0]||r[Math.floor(Math.random()*r.length)]}}else d=r[e%r.length];console.log(`[AUTO] ${l} Semana ${e+1}: ${d}`);for(const e of o.days){const{day:t,dayOfWeek:o,dayName:r}=e,c=`${n}-${String(a+1).padStart(2,"0")}-${String(t).padStart(2,"0")}`,i=feriadosChile.includes(c);s[l][t-1]=0===o?"Sergio Castillo"===l||"Ignacio Aburto"===l?"DL":"L":!i||"Sergio Castillo"!==l&&"Ignacio Aburto"!==l?6===o&&("M2"===d||"M2A"===d||"M2B"===d)?"M1":d:"F"}}}console.log("Asignaci√≥n semanal:",s),l.forEach(t=>{const o=t.querySelector("td");if(!o)return;const n=o.textContent.replace(/‚ö†Ô∏è/g,"").trim();if("Encargado de Bit√°cora"===n)return;t.querySelectorAll("td button.calendar-day").forEach((t,o)=>{const a=s[n][o];a&&""!==a&&(actualizarBotonTurno(t,a),e[a]&&(t.style.backgroundColor=e[a],t.style.color="#000"))})}),Swal.fire("√âxito","Turnos asignados usando patrones hist√≥ricos de cada empleado.","success"),guardarCalendarioEnLocalStorage(),scheduleFirestoreUpdate()}catch(e){console.error("Error en autoasignaci√≥n:",e),Swal.fire("Error","No se pudieron asignar los turnos.","error")}}});const o=document.getElementById("prev-month"),n=document.getElementById("next-month"),a=document.getElementById("today");o&&o.addEventListener("click",function(){clearTimeout(updateTimeout);const e=obtenerDatosCalendario(),t=e.mes;guardarCalendarioEnLocalStorage(),currentDate.setMonth(currentDate.getMonth()-1),renderCalendar(currentDate),subscribeCalendar(),refreshPrevMonthPanelIfOpen(),db.collection("calendarios").doc(t).set(e).then(()=>console.log(`[NAV] Background save: ${t}`)).catch(e=>console.error("[NAV] Background save error:",e)),saveCooldown=!1}),n&&n.addEventListener("click",function(){clearTimeout(updateTimeout);const e=obtenerDatosCalendario(),t=e.mes;guardarCalendarioEnLocalStorage(),currentDate.setMonth(currentDate.getMonth()+1),renderCalendar(currentDate),subscribeCalendar(),refreshPrevMonthPanelIfOpen(),db.collection("calendarios").doc(t).set(e).then(()=>console.log(`[NAV] Background save: ${t}`)).catch(e=>console.error("[NAV] Background save error:",e)),saveCooldown=!1}),a&&a.addEventListener("click",async function(){clearTimeout(updateTimeout);const e=obtenerDatosCalendario();try{await db.collection("calendarios").doc(e.mes).set(e),console.log(`[NAV] Guardado ${e.mes}`),await new Promise(e=>setTimeout(e,50))}catch(e){console.error("[NAV] Error:",e)}guardarCalendarioEnLocalStorage(),saveCooldown=!1,currentDate=new Date,renderCalendar(currentDate),subscribeCalendar(),refreshPrevMonthPanelIfOpen()}),renderCalendar(currentDate),subscribeCalendar(),cargarListaCalendarios(),cargarFotosEmpleados();document.querySelectorAll(".btn-turno").forEach(e=>{e.addEventListener("click",function(){if(usuarioEsAdmin)if(selectedDays.length>0){const e=this.getAttribute("data-turno"),t=this.getAttribute("data-color");selectedDays.forEach(o=>{"V"===e?(o.innerHTML=vacationIcon,o.style.backgroundColor=t,o.style.color="#000",o.setAttribute("title","Vacaciones")):(o.textContent=e,o.innerHTML=o.textContent,o.style.backgroundColor=t,o.style.color="#000",o.removeAttribute("title")),o.classList.remove("selected")});const o=new Set;selectedDays.forEach(e=>{const t=e.closest("tr");t&&o.add(t)}),o.forEach(e=>checkWeeklyHours(e)),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons(),selectedDays=[],scheduleFirestoreUpdate()}else Swal.fire({icon:"warning",title:"Sin selecci√≥n",text:"Por favor, selecciona al menos una celda antes de asignar un turno."})})}),btnGuardar&&btnGuardar.addEventListener("click",function(){if(!usuarioEsAdmin)return;if(!todosLosDiasRellenos())return void Swal.fire({icon:"error",title:"Datos incompletos",text:"Debes rellenar todos los d√≠as en los calendarios antes de guardar."});guardarCalendarioEnLocalStorage();const e=obtenerDatosCalendario(),t=db.collection("calendarios").doc(e.mes);t.get().then(o=>{o.exists?Swal.fire({icon:"question",title:"Ya existe un calendario",text:`¬øSobrescribir el calendario de ${e.mes}?`,showCancelButton:!0,confirmButtonText:"S√≠, sobrescribir",cancelButtonText:"No"}).then(o=>{o.isConfirmed?t.set(e).then(()=>{Swal.fire("Sobrescrito","Calendario sobrescrito exitosamente.","success"),cargarListaCalendarios()}).catch(e=>{console.error("Error al sobrescribir:",e)}):Swal.fire("Cancelado","No se sobrescribi√≥ el calendario.","info")}):t.set(e).then(()=>{Swal.fire({icon:"success",title:"Calendario guardado",text:"Calendario guardado exitosamente."}),cargarListaCalendarios()}).catch(e=>{console.error("Error al guardar:",e)})}).catch(e=>{console.error("Error al validar existencia:",e)})}),btnCargar&&btnCargar.addEventListener("click",function(){const e=document.getElementById("selectMeses"),t=e?e.value:"";t?db.collection("calendarios").doc(t).get().then(e=>{if(e.exists){const t=e.data();modalContent.innerHTML=`\n                <h3>Calendario General</h3>${t.generalHTML||""}\n                <h3>Calendario Nocturno</h3>${t.nocturnoHTML||""}\n                <h3>Calendario Feriados/Fines de Semana</h3>${t.feriadosHTML||""}\n              `,modal.style.display="block"}else Swal.fire({icon:"error",title:"No encontrado",text:`No se encontr√≥ el calendario para ${t}.`})}).catch(e=>{console.error("Error al cargar el calendario:",e)}):Swal.fire({icon:"warning",title:"Seleccione un mes",text:"Por favor, seleccione un mes guardado."})}),btnEliminar&&btnEliminar.addEventListener("click",function(){if(console.log("Clic en btnEliminar. Admin:",usuarioEsAdmin),!usuarioEsAdmin)return;const e=document.getElementById("selectMeses"),t=e?e.value:"";t?Swal.fire({icon:"warning",title:"¬øEliminar Calendario?",text:`¬øEst√°s seguro de eliminar el calendario de "${t}"?`,showCancelButton:!0,confirmButtonText:"S√≠, eliminar",cancelButtonText:"No"}).then(e=>{e.isConfirmed?db.collection("calendarios").doc(t).delete().then(()=>{Swal.fire("Eliminado",`El calendario de "${t}" fue eliminado.`,"success"),cargarListaCalendarios()}).catch(e=>{console.error("Error al eliminar calendario:",e)}):Swal.fire("Cancelado","No se elimin√≥ el calendario.","info")}):Swal.fire({icon:"warning",title:"Seleccione un mes",text:"Por favor, seleccione un mes guardado para eliminar."})}),cerrarModal&&cerrarModal.addEventListener("click",function(){modal.style.display="none"}),window.addEventListener("click",function(e){e.target===modal&&(modal.style.display="none")}),btnVerHorarios&&btnVerHorarios.addEventListener("click",function(){modalHorarios.style.display="block"}),cerrarHorarios&&cerrarHorarios.addEventListener("click",function(){modalHorarios.style.display="none"}),window.addEventListener("click",function(e){e.target===modalHorarios&&(modalHorarios.style.display="none")}),btnVerEstadisticas&&btnVerEstadisticas.addEventListener("click",function(){mostrarEstadisticas()}),cerrarEstadisticas&&cerrarEstadisticas.addEventListener("click",function(){modalEstadisticas.style.display="none"}),window.addEventListener("click",function(e){e.target===modalEstadisticas&&(modalEstadisticas.style.display="none")}),window.handlePhotoUpload=async function(e){if(e.files&&e.files[0]){const t=e.files[0],o=e.closest(".employee-card");if(!o)return void console.error("No se encontr√≥ la tarjeta del empleado.");const n=o.querySelector(".employee-name"),a=n?n.textContent.trim():"Empleado",r=`${a}_${Date.now()}_${t.name}`,{data:l,error:s}=await supabase.storage.from("documentos-noc").upload(r,t,{upsert:!0});if(s)return void console.error("Error al subir foto:",s);const c=l.path||r,{data:i,error:d}=supabase.storage.from("documentos-noc").getPublicUrl(c);if(d)return void console.error("Error al obtener URL:",d);if(!i)return void console.error("No se recibi√≥ URL p√∫blica.");const u=`${i.publicUrl}?ts=${Date.now()}`,m=o.querySelector(".employee-photo");m&&(m.src=u),db.collection("empleados").doc(a).set({photoURL:u},{merge:!0}).then(()=>{console.log(`Foto actualizada para ${a}`),Swal.fire("√âxito","Foto actualizada correctamente","success")}).catch(e=>{console.error("Error guardando URL:",e)})}else console.warn("No se seleccion√≥ ning√∫n archivo.")},window.attachPhotoUploadListeners=function(){if(!usuarioEsAdmin)return;console.log("Adjuntando listeners de fotos (attachPhotoUploadListeners)...");document.querySelectorAll(".upload-photo-btn").forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("click",()=>{const e=t.closest(".employee-card");if(!e)return;const o=e.querySelector(".photo-input");o&&o.click()})});document.querySelectorAll(".photo-input").forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("change",function(){window.handlePhotoUpload(this)})})},window.attachPhotoUploadListeners();const r=document.querySelector(".theme-toggle");r&&r.addEventListener("click",()=>{document.body.classList.toggle("dark-mode")});const l=document.getElementById("btnVerSugerencias"),s=document.getElementById("modalSugerencias"),c=document.getElementById("cerrarSugerencias"),i=document.getElementById("listaSugerencias");function d(){const e=document.getElementById("lockedIndicator"),t=document.getElementById("btnToggleLock"),o=localStorage.getItem("userRole");console.log("updateLockUI - Current Role:",o),"superadmin"===o&&t&&(t.style.display="inline-flex",t.innerHTML=isMonthLocked?'<i data-lucide="unlock"></i> Abrir Mes':'<i data-lucide="lock"></i> Cerrar Mes',t.className="btn-horarios superadmin-only",isMonthLocked?(t.style.backgroundColor="#7796cb",t.style.color="#fff"):(t.style.backgroundColor="#f39c12",t.style.color="#fff")),isMonthLocked?(document.body.classList.add("locked-mode"),e&&(e.style.display="flex")):(document.body.classList.remove("locked-mode"),e&&(e.style.display="none")),"function"==typeof refreshIcons?refreshIcons():lucide.createIcons()}l&&s&&c&&i&&(l.addEventListener("click",()=>{if(!usuarioEsAdmin)return;const e=function(){const e=calcularEstadisticas(),t=Object.values(e).reduce((e,t)=>e+t,0),o=Object.keys(e).length>0?t/Object.keys(e).length:0,n=[];for(const[t,a]of Object.entries(e)){if(0===o)break;a>1.5*o?n.push(`El turno "${t}" se asigna con mucha frecuencia (${a} veces). Considera re-distribuirlo.`):a<.5*o&&n.push(`El turno "${t}" tiene pocas asignaciones (${a} veces). Podr√≠as equilibrarlo con otros turnos.`)}0===n.length&&n.push("La distribuci√≥n de turnos se ve bastante equilibrada en este mes.");return n}();i.innerHTML=e.map(e=>`<li>${e}</li>`).join(""),s.style.display="block"}),c.addEventListener("click",()=>{s.style.display="none"}),window.addEventListener("click",e=>{e.target===s&&(s.style.display="none")})),document.addEventListener("DOMContentLoaded",async function(){const e=document.querySelectorAll(".employee-card");try{const t=await db.collection("empleados").get(),o={};t.forEach(e=>{const t=e.data();t.photoURL&&(o[e.id]=t.photoURL)}),e.forEach(e=>{const t=e.querySelector(".employee-name");if(t){const n=t.textContent.trim();if(o[n]){const t=e.querySelector(".employee-photo");t&&(t.src=o[n])}}}),"function"==typeof window.attachPhotoUploadListeners&&window.attachPhotoUploadListeners()}catch(e){console.error("Error cargando fotos:",e)}});const u=document.getElementById("btnToggleLock");u&&u.addEventListener("click",async function(){const e=document.getElementById("current-month").textContent.trim(),t=(obtenerClaveMes(currentDate),isMonthLocked?"ABRIR":"CERRAR");if((await Swal.fire({title:`¬ø${t} el mes de ${e}?`,text:isMonthLocked?"Al abrirlo, los administradores podr√°n volver a editar los turnos.":"Al cerrarlo, nadie podr√° editar turnos hasta que se vuelva a abrir.",icon:"warning",showCancelButton:!0,confirmButtonText:`S√≠, ${t}`,cancelButtonText:"Cancelar"})).isConfirmed){isMonthLocked=!isMonthLocked,d(),guardarCalendarioEnLocalStorage();try{await db.collection("calendarios").doc(e).set({locked:isMonthLocked},{merge:!0}),Swal.fire("√âxito",`El mes ha sido ${"CERRAR"===t?"cerrado":"abierto"}.`,"success")}catch(e){console.error("Error al cambiar estado de bloqueo:",e),Swal.fire("Error","No se pudo actualizar el estado del mes.","error"),isMonthLocked=!isMonthLocked,d()}}}),function(){const e=document.getElementById("btnToggleFloating"),t=document.querySelector(".turnos-section"),o=t?t.querySelector(".turnos-header"):null;if(!e||!t||!o)return;let n=!1,a=0,r=0,l=0,s=0,c=0,i=0,d=!1,u=null;function m(){t.style.transform=`translate3d(${a}px, ${r}px, 0)`,u=null}e.addEventListener("click",()=>{t.classList.toggle("floating"),n=t.classList.contains("floating"),e.classList.toggle("active"),n?(c=0,i=0,t.style.top="120px",t.style.right="20px",t.style.left="auto",t.style.transform="translate3d(0px, 0px, 0)",e.innerHTML='<i data-lucide="minimize-2"></i>'):(t.style.top="",t.style.right="",t.style.left="",t.style.transform="none",e.innerHTML='<i data-lucide="maximize-2"></i>'),"function"==typeof refreshIcons?refreshIcons():window.lucide&&lucide.createIcons()}),o.addEventListener("mousedown",function(e){if(!n)return;if(e.target.closest("button"))return;l=e.clientX-c,s=e.clientY-i,d=!0,t.classList.add("dragging"),o.style.cursor="grabbing"}),document.addEventListener("mouseup",function(e){if(!d)return;l=a,s=r,d=!1,t.classList.remove("dragging"),o.style.cursor="move",cancelAnimationFrame(u),u=null}),document.addEventListener("mousemove",function(e){d&&(e.preventDefault(),a=e.clientX-l,r=e.clientY-s,c=a,i=r,u||(u=requestAnimationFrame(m)))})}();const m=document.getElementById("btnExportarGeneral");m&&m.addEventListener("click",()=>{const e=document.getElementById("current-month"),t=document.getElementById("general-calendar"),o=e.textContent.trim().replace(/\s+/g,"_"),n={type:"backup_general_v2",version:"2.0",mes:e.textContent,timestamp:(new Date).toISOString(),assignments:{}};t&&t.querySelectorAll("tbody tr").forEach(e=>{const t=e.querySelector("td:first-child");if(!t)return;const o=t.textContent.replace(/\s*\(Ex\)\s*$/,"").trim();if("Encargado de Bit√°cora"===o||"Cristian Oyarzo"===o)return;const a={};e.querySelectorAll("button.calendar-day").forEach(e=>{const t=e.getAttribute("data-day");let o=e.textContent.trim(),n=e.style.backgroundColor;(e.querySelector('[data-lucide="tree-palm"]')||e.querySelector("svg.lucide-tree-palm"))&&(o="V"),o&&(a[t]={code:o,color:n})}),Object.keys(a).length>0&&(n.assignments[o]=a)});const a=JSON.stringify(n,null,2),r=new Blob([a],{type:"application/json"}),l=URL.createObjectURL(r),s=document.createElement("a");s.href=l,s.download=`Respaldo_General_${o}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(l),Swal.fire({icon:"success",title:"Respaldo Generado (V2)",text:"Se ha descargado el archivo con los colores exactos.",timer:2e3,showConfirmButton:!1})});const g=document.getElementById("btnImportarGeneral"),f=document.getElementById("jsonInput");g&&f&&(g.addEventListener("click",()=>{f.click()}),f.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=e=>{try{const o=JSON.parse(e.target.result);if(!("backup_general"===o.type||"backup_general_v2"===o.type)||!o.assignments)throw new Error("Formato de archivo inv√°lido.");Swal.fire({title:"¬øRestaurar Turnos Generales?",text:`Se cargar√°n los turnos del archivo "${t.name}". Esto sobrescribir√° lo que hay en pantalla (Solo Planilla General).`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#3498db",cancelButtonColor:"#d33",confirmButtonText:"S√≠, Restaurar"}).then(e=>{e.isConfirmed&&(aplicarAsignacionesV2(o.assignments),calcularHorasExtras(currentDate),guardarCalendarioEnLocalStorage(),scheduleFirestoreUpdate(),Swal.fire("Restaurado!","Los turnos se han cargado y guardado autom√°ticamente.","success")),f.value=""})}catch(e){console.error(e),Swal.fire("Error","No se pudo leer el archivo: "+e.message,"error"),f.value=""}},o.readAsText(t)}))})}),document.addEventListener("DOMContentLoaded",()=>{setTimeout(initPrevMonthPanel,500)});