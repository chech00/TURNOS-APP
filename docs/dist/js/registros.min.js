"use strict";const auth=window.auth,db=window.db;let allLogsCache=[];function showAdminElements(){["li-registros","li-turnos","li-usuarios","li-animaciones"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="block")}),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}function initFilters(){document.getElementById("btn-apply-filters").addEventListener("click",applyFilters),document.getElementById("btn-reset-filters").addEventListener("click",()=>{document.getElementById("filter-date-start").value="",document.getElementById("filter-date-end").value="",document.getElementById("filter-role").value="all",applyFilters()})}function applyFilters(){const e=document.getElementById("filter-date-start").value,t=document.getElementById("filter-date-end").value,n=document.getElementById("filter-role").value;let o=allLogsCache;if(e){const t=new Date(e+"T00:00:00");o=o.filter(e=>!!e.timestamp&&e.timestamp.toDate()>=t)}if(t){const e=new Date(t+"T23:59:59");o=o.filter(t=>!!t.timestamp&&t.timestamp.toDate()<=e)}"all"!==n&&(o=o.filter(e=>e.rol===n)),renderTable(o)}async function cargarRegistrosDeLogins(){try{const e=document.getElementById("table-loader"),t=document.getElementById("tabla-registros");e&&(e.style.display="flex"),t&&(t.style.display="none");const n=await db.collection("loginLogs").orderBy("timestamp","desc").limit(200).get();e&&(e.style.display="none"),t&&(t.style.display="table"),allLogsCache=[],n.forEach(e=>{const t=e.data();t.id=e.id,allLogsCache.push(t)}),renderTable(allLogsCache)}catch(e){console.error("Error al cargar registros de login:",e)}}function renderTable(e){const t=document.querySelector("#tabla-registros tbody");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=4,n.textContent="No hay registros que coincidan con los filtros.",e.appendChild(n),void t.appendChild(e)}e.forEach(e=>{const n=document.createElement("tr"),o=document.createElement("td");o.innerHTML=`<i data-lucide="mail" style="width:14px; vertical-align:middle; margin-right:5px; opacity:0.7"></i> ${e.email||"Sin email"}`;const a=document.createElement("td"),i=`<span class="user-role-badge ${"superadmin"===e.rol?"superadmin":"admin"===e.rol?"admin":""}" style="position:static; margin:0; font-size:0.75rem;">${e.rol||"N/A"}</span>`;a.innerHTML=i;const l=document.createElement("td"),r=e.authProvider||"email";l.innerHTML="google"===r?'<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(66,133,244,0.15);border:1px solid rgba(66,133,244,0.3);border-radius:4px;color:#4285f4;font-size:0.75rem;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google</span>':'<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(119,150,203,0.15);border:1px solid rgba(119,150,203,0.3);border-radius:4px;color:#7796cb;font-size:0.75rem;"><i data-lucide="mail" style="width:12px;height:12px;"></i> Email</span>';const s=document.createElement("td");if(e.timestamp&&e.timestamp.toDate){const t=e.timestamp.toDate();s.textContent=t.toLocaleString("es-CL")}else s.textContent="Sin fecha";n.appendChild(o),n.appendChild(a),n.appendChild(l),n.appendChild(s),t.appendChild(n)}),window.lucide&&window.lucide.createIcons()}}async function downloadSystemBackup(){await generatePDFBackup()}async function generatePDFBackup(){if(window.jspdf)try{Swal.fire({title:"Generando Reporte...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const{jsPDF:e}=window.jspdf,t=new e,n=(new Date).toLocaleString("es-CL");t.setFontSize(18),t.text("Reporte de Auditoría - Turnos App",14,20),t.setFontSize(10),t.text(`Generado: ${n}`,14,28),t.setFontSize(12),t.text("Filtros Aplicados:",14,40);const o=document.getElementById("filter-date-start").value||"Inicio",a=document.getElementById("filter-date-end").value||"Actualidad",i=document.getElementById("filter-role").value;t.setFontSize(10),t.text(`Fecha: ${o} a ${a} | Rol: ${i}`,14,46);let l=55;const r=[];document.querySelectorAll("#tabla-registros tbody tr").forEach(e=>{if(e.innerText.includes("No hay registros"))return;const t=e.querySelectorAll("td");t.length>=4&&r.push([t[0].innerText.trim(),t[1].innerText.trim(),t[2].innerText.trim(),t[3].innerText.trim()])}),t.autoTable({startY:l,head:[["Email","Rol","Método","Fecha/Hora"]],body:r,theme:"grid",styles:{fontSize:8},headStyles:{fillColor:[66,66,66]}}),t.save(`reporte_auditoria_${(new Date).toISOString().slice(0,10)}.pdf`),Swal.fire("Éxito","Reporte PDF generado.","success")}catch(e){console.error(e),Swal.fire("Error","Falló la generación del PDF.","error")}else Swal.fire("Error","Librería PDF no cargada.","error")}async function cleanOldLogs(){try{const e=new Date;e.setFullYear(e.getFullYear()-1);const t=await db.collection("loginLogs").where("timestamp","<",e).get(),n=t.size;if(0===n)return void Swal.fire("Limpieza","No hay registros antiguos (>1 año) para borrar.","info");if(!(await Swal.fire({title:"¿Limpiar Logs Antiguos?",text:`Se encontraron ${n} registros mayores a 1 año.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar",cancelButtonColor:"#d33"})).isConfirmed)return;const o=db.batch();t.docs.forEach(e=>o.delete(e.ref)),await o.commit(),Swal.fire("Limpieza Exitosa",`Se eliminaron ${n} registros antiguos.`,"success"),cargarRegistrosDeLogins()}catch(e){console.error("Error al limpiar logs:",e),Swal.fire("Error","Hubo un problema al intentar limpiar los logs.","error")}}document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("userRole");"superadmin"===e?(showAdminElements(),document.body.classList.add("is-admin")):"admin"===e&&document.body.classList.add("is-admin"),auth.onAuthStateChanged(async e=>{if(!e)return void(window.location.href="login.html");const t=await db.collection("userRoles").doc(e.uid).get();if(!t.exists)return void auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"});"superadmin"===t.data().rol?(document.body.classList.add("is-admin"),showAdminElements(),initFilters(),cargarRegistrosDeLogins()):window.location.href="index.html"});const t=document.getElementById("logout-btn");t&&t.addEventListener("click",()=>{auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"})});const n=document.getElementById("sidebar"),o=document.getElementById("main-content"),a=document.getElementById("menu-toggle");a&&n&&o&&a.addEventListener("click",()=>{n.classList.toggle("expanded"),o.classList.toggle("expanded")});const i=document.getElementById("btnDownloadBackup"),l=document.getElementById("btnCleanLogs");i&&i.addEventListener("click",downloadSystemBackup),l&&l.addEventListener("click",cleanOldLogs)});