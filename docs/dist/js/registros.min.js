"use strict";const auth=window.auth,db=window.db;let allLogsCache=[],chartLogins=null,chartMethods=null,unsubscribeSessions=null,currentUserUid=null;function showAdminElements(){["li-registros","li-turnos","li-usuarios","li-animaciones"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="block")}),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}function initFilters(){document.getElementById("btn-apply-filters").addEventListener("click",applyFilters),document.getElementById("btn-reset-filters").addEventListener("click",()=>{document.getElementById("filter-date-start").value="",document.getElementById("filter-date-end").value="",document.getElementById("filter-role").value="all",applyFilters()})}function applyFilters(){const e=document.getElementById("filter-date-start").value,t=document.getElementById("filter-date-end").value,n=document.getElementById("filter-role").value;let i=allLogsCache;if(e){const t=new Date(e+"T00:00:00");i=i.filter(e=>!!e.timestamp&&e.timestamp.toDate()>=t)}if(t){const e=new Date(t+"T23:59:59");i=i.filter(t=>!!t.timestamp&&t.timestamp.toDate()<=e)}"all"!==n&&(i=i.filter(e=>e.rol===n)),renderTable(i)}async function cargarRegistrosDeLogins(){try{const e=document.getElementById("table-loader"),t=document.getElementById("tabla-registros");e&&(e.style.display="flex"),t&&(t.style.display="none");const n=await db.collection("loginLogs").orderBy("timestamp","desc").limit(200).get();e&&(e.style.display="none"),t&&(t.style.display="table"),allLogsCache=[],n.forEach(e=>{const t=e.data();t.id=e.id,allLogsCache.push(t)}),renderTable(allLogsCache)}catch(e){console.error("Error al cargar registros de login:",e)}}function renderTable(e){const t=document.querySelector("#tabla-registros tbody");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("tr"),n=document.createElement("td");return n.colSpan=4,n.textContent="No hay registros que coincidan con los filtros.",e.appendChild(n),void t.appendChild(e)}e.forEach(e=>{const n=document.createElement("tr"),i=document.createElement("td");i.innerHTML=`<i data-lucide="mail" style="width:14px; vertical-align:middle; margin-right:5px; opacity:0.7"></i> ${e.email||"Sin email"}`;const o=document.createElement("td"),s=`<span class="user-role-badge ${"superadmin"===e.rol?"superadmin":"admin"===e.rol?"admin":""}" style="position:static; margin:0; font-size:0.75rem;">${e.rol||"N/A"}</span>`;o.innerHTML=s;const a=document.createElement("td"),r=e.authProvider||"email";a.innerHTML="google"===r?'<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(66,133,244,0.15);border:1px solid rgba(66,133,244,0.3);border-radius:4px;color:#4285f4;font-size:0.75rem;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google</span>':'<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(119,150,203,0.15);border:1px solid rgba(119,150,203,0.3);border-radius:4px;color:#7796cb;font-size:0.75rem;"><i data-lucide="mail" style="width:12px;height:12px;"></i> Email</span>';const l=document.createElement("td");if(e.timestamp&&e.timestamp.toDate){const t=e.timestamp.toDate();l.textContent=t.toLocaleString("es-CL")}else l.textContent="Sin fecha";n.appendChild(i),n.appendChild(o),n.appendChild(a),n.appendChild(l),t.appendChild(n)}),window.lucide&&window.lucide.createIcons()}}async function downloadSystemBackup(){await generatePDFBackup()}async function generatePDFBackup(){if(window.jspdf)try{Swal.fire({title:"Generando Reporte...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const{jsPDF:e}=window.jspdf,t=new e,n=(new Date).toLocaleString("es-CL");t.setFontSize(18),t.text("Reporte de Auditoría - Turnos App",14,20),t.setFontSize(10),t.text(`Generado: ${n}`,14,28),t.setFontSize(12),t.text("Filtros Aplicados:",14,40);const i=document.getElementById("filter-date-start").value||"Inicio",o=document.getElementById("filter-date-end").value||"Actualidad",s=document.getElementById("filter-role").value;t.setFontSize(10),t.text(`Fecha: ${i} a ${o} | Rol: ${s}`,14,46);let a=55;const r=[];document.querySelectorAll("#tabla-registros tbody tr").forEach(e=>{if(e.innerText.includes("No hay registros"))return;const t=e.querySelectorAll("td");t.length>=4&&r.push([t[0].innerText.trim(),t[1].innerText.trim(),t[2].innerText.trim(),t[3].innerText.trim()])}),t.autoTable({startY:a,head:[["Email","Rol","Método","Fecha/Hora"]],body:r,theme:"grid",styles:{fontSize:8},headStyles:{fillColor:[66,66,66]}}),t.save(`reporte_auditoria_${(new Date).toISOString().slice(0,10)}.pdf`),Swal.fire("Éxito","Reporte PDF generado.","success")}catch(e){console.error(e),Swal.fire("Error","Falló la generación del PDF.","error")}else Swal.fire("Error","Librería PDF no cargada.","error")}async function cleanOldLogs(){try{const e=new Date;e.setFullYear(e.getFullYear()-1);const t=await db.collection("loginLogs").where("timestamp","<",e).get(),n=t.size;if(0===n)return void Swal.fire("Limpieza","No hay registros antiguos (>1 año) para borrar.","info");if(!(await Swal.fire({title:"¿Limpiar Logs Antiguos?",text:`Se encontraron ${n} registros mayores a 1 año.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, borrar",cancelButtonColor:"#d33"})).isConfirmed)return;const i=db.batch();t.docs.forEach(e=>i.delete(e.ref)),await i.commit(),Swal.fire("Limpieza Exitosa",`Se eliminaron ${n} registros antiguos.`,"success"),cargarRegistrosDeLogins()}catch(e){console.error("Error al limpiar logs:",e),Swal.fire("Error","Hubo un problema al intentar limpiar los logs.","error")}}async function registerActiveSession(e,t){try{const n={uid:e.uid,email:e.email,role:t,loginTime:firebase.firestore.FieldValue.serverTimestamp(),lastActivity:firebase.firestore.FieldValue.serverTimestamp(),userAgent:navigator.userAgent.substring(0,100),page:"registros"};await db.collection("activeSessions").doc(e.uid).set(n),console.log("[Sessions] Sesión registrada"),setInterval(async()=>{try{await db.collection("activeSessions").doc(e.uid).update({lastActivity:firebase.firestore.FieldValue.serverTimestamp()})}catch(e){console.warn("[Sessions] Heartbeat failed:",e)}},3e4)}catch(e){console.error("[Sessions] Error registering session:",e)}}function initActiveSessions(){document.getElementById("sessions-grid")&&(unsubscribeSessions=db.collection("activeSessions").orderBy("loginTime","desc").onSnapshot(e=>{const t=[],n=new Date;e.forEach(e=>{const i=e.data();if(i.id=e.id,i.lastActivity){const o=i.lastActivity.toDate();n-o<3e5?t.push(i):db.collection("activeSessions").doc(e.id).delete().catch(()=>{})}}),renderSessionCards(t);const i=document.getElementById("stat-active-now");i&&(i.textContent=t.length),window.lucide&&lucide.createIcons()},e=>{console.error("[Sessions] Listener error:",e)}))}function renderSessionCards(e){const t=document.getElementById("sessions-grid");if(!t)return;if(0===e.length)return void(t.innerHTML='\n      <div class="no-sessions">\n        <i data-lucide="users"></i>\n        <p>No hay sesiones activas en este momento</p>\n      </div>\n    ');let n="";e.forEach(e=>{const t=e.uid===currentUserUid,i=e.email?e.email.charAt(0).toUpperCase():"?",o=e.loginTime?e.loginTime.toDate().toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"}):"--:--";n+=`\n      <div class="session-card ${t?"current-user":""}">\n        <div class="session-header">\n          <div class="session-avatar">${i}</div>\n          <div class="session-user-info">\n            <div class="session-email">${e.email||"Sin email"}</div>\n            <div class="session-role">${e.role||"user"}</div>\n          </div>\n          <div class="session-status">Activo</div>\n        </div>\n        <div class="session-meta">\n          <div class="session-time">\n            <i data-lucide="clock"></i>\n            Desde ${o}\n          </div>\n          ${t?'\n            <span style="font-size:0.75rem; color:var(--color-acento-primario);">Tu sesión</span>\n          ':`\n            <button class="btn-terminate" onclick="terminateSession('${e.uid}', '${e.email}')" title="Cerrar sesión remota">\n              <i data-lucide="power"></i> Terminar\n            </button>\n          `}\n        </div>\n      </div>\n    `}),t.innerHTML=n}async function terminateSession(e,t){if((await Swal.fire({title:"¿Cerrar esta sesión?",html:`Se cerrará la sesión de <strong>${t}</strong> de forma remota.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Sí, cerrar sesión",cancelButtonText:"Cancelar",confirmButtonColor:"#ef4444"})).isConfirmed)try{await db.collection("activeSessions").doc(e).update({terminated:!0,terminatedBy:currentUserUid,terminatedAt:firebase.firestore.FieldValue.serverTimestamp()}),await db.collection("activeSessions").doc(e).delete(),Swal.fire({icon:"success",title:"Sesión cerrada",text:`La sesión de ${t} ha sido terminada.`,timer:2e3,showConfirmButton:!1})}catch(e){console.error("Error terminating session:",e),Swal.fire("Error","No se pudo cerrar la sesión remota.","error")}}function initDashboard(){calculateStats()}function calculateStats(){if(0===allLogsCache.length)return void setTimeout(calculateStats,500);const e=new Date,t=new Date(e-6048e5),n=allLogsCache.filter(e=>!!e.timestamp&&e.timestamp.toDate()>=t);document.getElementById("stat-total-logins").textContent=n.length;const i=new Set(n.map(e=>e.email).filter(Boolean));document.getElementById("stat-unique-users").textContent=i.size;const o={};n.forEach(e=>{if(e.timestamp){const t=e.timestamp.toDate().getHours();o[t]=(o[t]||0)+1}});let s="--",a=0;Object.entries(o).forEach(([e,t])=>{t>a&&(a=t,s=`${e}:00`)}),document.getElementById("stat-peak-hour").textContent=s,renderCharts(n),renderTopUsers(n)}function renderCharts(e){const t={},n=[];for(let e=6;e>=0;e--){const i=new Date;i.setDate(i.getDate()-e);const o=i.toISOString().split("T")[0],s=i.toLocaleDateString("es-CL",{weekday:"short",day:"numeric"});n.push(s),t[o]=0}e.forEach(e=>{if(e.timestamp){const n=e.timestamp.toDate().toISOString().split("T")[0];t.hasOwnProperty(n)&&t[n]++}});const i=document.getElementById("chartLoginsPerDay");i&&(chartLogins&&chartLogins.destroy(),chartLogins=new Chart(i,{type:"bar",data:{labels:n,datasets:[{label:"Logins",data:Object.values(t),backgroundColor:"rgba(119, 150, 203, 0.7)",borderColor:"rgba(119, 150, 203, 1)",borderWidth:1,borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{color:"#9ca3af"},grid:{color:"rgba(255,255,255,0.05)"}},x:{ticks:{color:"#9ca3af"},grid:{display:!1}}}}}));const o={email:0,google:0};e.forEach(e=>{"google"===(e.authProvider||"email")?o.google++:o.email++});const s=document.getElementById("chartAuthMethods");s&&(chartMethods&&chartMethods.destroy(),chartMethods=new Chart(s,{type:"doughnut",data:{labels:["Email/Contraseña","Google"],datasets:[{data:[o.email,o.google],backgroundColor:["rgba(119, 150, 203, 0.8)","rgba(234, 67, 53, 0.8)"],borderColor:["rgba(119, 150, 203, 1)","rgba(234, 67, 53, 1)"],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:"#9ca3af",padding:15}}}}}))}function renderTopUsers(e){const t=document.getElementById("top-users-list");if(!t)return;const n={};e.forEach(e=>{e.email&&(n[e.email]=(n[e.email]||0)+1)});const i=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,5);if(0===i.length)return void(t.innerHTML='<p style="color:var(--color-texto-secundario);">No hay datos suficientes</p>');let o="";i.forEach(([e,t],n)=>{o+=`\n      <div class="top-user-item">\n        <span class="top-user-rank ${0===n?"gold":1===n?"silver":2===n?"bronze":""}">#${n+1}</span>\n        <div class="top-user-info">\n          <span class="top-user-email" title="${e}">${e}</span>\n          <span class="top-user-count">${t} logins</span>\n        </div>\n      </div>\n    `}),t.innerHTML=o}document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("userRole");"superadmin"===e?(showAdminElements(),document.body.classList.add("is-admin")):"admin"===e&&document.body.classList.add("is-admin"),auth.onAuthStateChanged(async e=>{if(!e)return void(window.location.href="login.html");currentUserUid=e.uid;const t=await db.collection("userRoles").doc(e.uid).get();if(!t.exists)return void auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"});"superadmin"===t.data().rol?(document.body.classList.add("is-admin"),showAdminElements(),initFilters(),cargarRegistrosDeLogins(),initDashboard(),initActiveSessions()):window.location.href="index.html"});const t=document.getElementById("logout-btn");t&&t.addEventListener("click",async()=>{"function"==typeof window.cleanupActiveSession&&await window.cleanupActiveSession(),auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"})});const n=document.getElementById("sidebar"),i=document.getElementById("main-content"),o=document.getElementById("menu-toggle");o&&n&&i&&o.addEventListener("click",()=>{n.classList.toggle("expanded"),i.classList.toggle("expanded")});const s=document.getElementById("btnDownloadBackup"),a=document.getElementById("btnCleanLogs"),r=document.getElementById("btnRefreshSessions");s&&s.addEventListener("click",downloadSystemBackup),a&&a.addEventListener("click",cleanOldLogs),r&&r.addEventListener("click",()=>{r.classList.add("spinning"),setTimeout(()=>r.classList.remove("spinning"),1e3)})}),window.terminateSession=terminateSession;