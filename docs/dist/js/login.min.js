"use strict";const auth=window.auth,db=window.db;document.getElementById("login-form").addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("email").value.trim(),t=document.getElementById("password").value.trim(),a=document.getElementById("error-message");try{const e=(await auth.signInWithEmailAndPassword(o,t)).user;a.style.display="none",a.textContent="";const[n,r]=await Promise.all([db.collection("userRoles").doc(e.uid).get(),db.collection("userStatus").doc(e.uid).get().catch(e=>(console.warn("Error verificando estado:",e),null))]);if(!n.exists)return await auth.signOut(),void Swal.fire("Error","No tienes un rol asignado. Contacta al administrador.","error");const i=n.data(),s=i.rol;if(r&&r.exists){const e=r.data();if(!0===e.suspended){await auth.signOut();let o=e.suspendedReason||"Raz√≥n no especificada";return void("undefined"!=typeof Swal?Swal.fire({icon:"error",title:"Cuenta Suspendida",text:o,confirmButtonColor:"#3b82f6"}):alert("CUENTA SUSPENDIDA: "+o))}}if(!0===i.mustChangePassword)return void(window.location.href="change-password.html");try{const o=Date.now();await Promise.all([db.collection("loginLogs").add({email:e.email,rol:s,authProvider:"email",timestamp:firebase.firestore.FieldValue.serverTimestamp()}),db.collection("userRoles").doc(e.uid).update({lastActivity:o,lastLogin:firebase.firestore.FieldValue.serverTimestamp()})])}catch(e){console.error("‚ö†Ô∏è Error guardando log o actualizando lastActivity:",e)}localStorage.setItem("userRole",s),window.location.href="directorio.html"}catch(e){console.error("Error en el inicio de sesi√≥n:",e),a.style.display="block";let t=e.code,n=e.message;if(n&&n.includes("INVALID_LOGIN_CREDENTIALS")&&(t="auth/invalid-login-credentials"),"auth/wrong-password"===t||"auth/invalid-login-credentials"===t||"auth/user-not-found"===t)try{const e=await auth.fetchSignInMethodsForEmail(o),t=e.includes("google.com"),a=e.includes("password");if(t&&!a)return void Swal.fire({icon:"info",title:"Cuenta verificada con Google",html:'\n              <p>Tu cuenta est√° vinculada a Google.</p>\n              <ul style="text-align: left; margin-top: 10px; font-size: 0.9em; color: #555;">\n                <li>Para entrar ahora, usa el bot√≥n <strong>"Continuar con Google"</strong>.</li>\n                <br>\n                <li>Si prefieres usar una clave manual, haz clic en <strong>"¬øOlvidaste tu contrase√±a?"</strong> para crear una nueva.</li>\n              </ul>\n            ',confirmButtonText:"Entendido",confirmButtonColor:"#7796CB"})}catch(e){console.error("Error verificando m√©todos de inicio:",e)}switch(t){case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-login-credentials":a.textContent="Usuario o contrase√±a incorrectos.";break;case"auth/invalid-email":a.textContent="El formato del correo no es v√°lido.";break;case"auth/too-many-requests":a.textContent="Demasiados intentos fallidos. Intenta m√°s tarde.";break;default:a.textContent="Error al iniciar sesi√≥n. Verifica tus datos."}}});const googleLoginBtn=document.getElementById("google-login-btn");googleLoginBtn&&googleLoginBtn.addEventListener("click",async()=>{const e=new firebase.auth.GoogleAuthProvider;e.addScope("https://www.googleapis.com/auth/gmail.send");try{const o=await auth.signInWithPopup(e),t=o.credential,a=t?.accessToken||null,n=o.user,r="@patagoniaip.cl",i=["sergio.cb87@gmail.com"],s=n.email.toLowerCase(),l=s.endsWith(r),d=i.includes(s);if(!l&&!d)return console.warn("Dominio no permitido:",n.email),await auth.signOut(),void Swal.fire({icon:"error",title:"Dominio no permitido",html:`Solo se permite el acceso con cuentas <strong>@patagoniaip.cl</strong>.<br><br>Tu cuenta: ${n.email}`,confirmButtonColor:"#7796CB"});let c=await db.collection("userRoles").doc(n.uid).get(),u=null,g=!1;if(!c.exists){console.log("üîç Buscando cuenta existente por email...");const e=await db.collection("userRoles").where("email","==",n.email).limit(1).get();if(e.empty)return console.warn("Usuario no registrado en el sistema:",n.email),await auth.signOut(),void Swal.fire({icon:"warning",title:"Usuario no registrado",html:`El correo <strong>${n.email}</strong> no est√° registrado en el sistema.<br><br>Contacta al administrador para obtener acceso.`,confirmButtonColor:"#7796CB"});u=e.docs[0].id,c=e.docs[0],g=!0,console.log("‚úÖ Cuenta encontrada por email, documento antiguo:",u)}const m=c.data(),p=m.rol;if(g&&u&&u!==n.uid){console.log("üîó Iniciando migraci√≥n de cuenta a Google UID...");try{const e={...m,googleLinked:!0,googleLinkedAt:firebase.firestore.FieldValue.serverTimestamp(),previousUid:u},o=db.batch();o.set(db.collection("userRoles").doc(n.uid),e),o.delete(db.collection("userRoles").doc(u));const t=await db.collection("userStatus").doc(u).get();t.exists&&(o.set(db.collection("userStatus").doc(n.uid),t.data()),o.delete(db.collection("userStatus").doc(u))),await o.commit(),console.log("‚úÖ Cuenta migrada exitosamente al UID de Google:",n.uid);try{await auth.sendPasswordResetEmail(n.email),console.log("üìß Email de reset enviado para preservar m√©todo de contrase√±a"),localStorage.setItem("showPasswordPreservationNotice","true"),localStorage.setItem("passwordPreservationEmail",n.email)}catch(e){console.warn("No se pudo enviar email de reset:",e)}}catch(e){console.error("‚ö†Ô∏è Error en migraci√≥n (login contin√∫a):",e)}}const w=await db.collection("userStatus").doc(n.uid).get().catch(()=>null);if(w&&w.exists&&!0===w.data().suspended)return await auth.signOut(),void Swal.fire({icon:"error",title:"Cuenta Suspendida",text:w.data().suspendedReason||"Contacta al administrador.",confirmButtonColor:"#3b82f6"});const f={lastActivity:Date.now(),lastLogin:firebase.firestore.FieldValue.serverTimestamp()};a&&(f.gmailAccessToken=a,f.gmailTokenUpdatedAt=firebase.firestore.FieldValue.serverTimestamp(),console.log("üíæ Gmail access token guardado en Firestore")),await Promise.all([db.collection("loginLogs").add({email:n.email,rol:p,authProvider:"google",timestamp:firebase.firestore.FieldValue.serverTimestamp()}),db.collection("userRoles").doc(n.uid).update(f)]),localStorage.setItem("userRole",p),window.location.href="directorio.html"}catch(e){console.error("Error en Google Sign-In:",e),"auth/popup-closed-by-user"===e.code?console.log("Usuario cerr√≥ el popup"):"auth/cancelled-popup-request"===e.code?console.log("Popup cancelado"):Swal.fire({icon:"error",title:"Error de autenticaci√≥n",text:"No se pudo iniciar sesi√≥n con Google. Intenta de nuevo.",confirmButtonColor:"#3b82f6"})}});const passwordInput=document.getElementById("password"),formGroupPassword=passwordInput.parentElement,passwordContainer=document.createElement("div");passwordContainer.className="password-container",formGroupPassword.appendChild(passwordContainer),passwordContainer.appendChild(passwordInput);const togglePasswordIcon=document.createElement("span");togglePasswordIcon.className="toggle-password",togglePasswordIcon.innerHTML="&#128065;",passwordContainer.appendChild(togglePasswordIcon),togglePasswordIcon.addEventListener("click",()=>{"password"===passwordInput.type?(passwordInput.type="text",togglePasswordIcon.innerHTML="&#128064;",togglePasswordIcon.style.color="#8e44ad"):(passwordInput.type="password",togglePasswordIcon.innerHTML="&#128065;",togglePasswordIcon.style.color="#ccc")});const emailInput=document.getElementById("email");emailInput.addEventListener("input",()=>{emailInput.style.borderColor=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)?"#8e44ad":"#ff4d4f"}),passwordInput.addEventListener("input",()=>{passwordInput.style.borderColor=passwordInput.value.length>=6?"#8e44ad":"#ff4d4f"}),document.querySelectorAll(".form-group input").forEach(e=>{e.style.width="100%",e.style.boxSizing="border-box"});