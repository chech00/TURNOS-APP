import{auth,db}from"./firebase.js";import{formatDate,calcularPascua,obtenerFeriadosMoviles,obtenerSemanaActual}from"./modules/utils/dateUtils.js";import{generarListaFeriados}from"./modules/logic/holidayLogic.js";window.onerror=function(e,n,t,a,o){console.error("Global Error:",e,"Line:",t,"Error:",o),"Script error."===e&&0===t||(e.includes("Cannot read properties of undefined")?console.warn("Firebase may not be initialized yet"):console.error("Error en script.js:",e,"LÃ­nea:",t))};let currentMonth=(new Date).getMonth(),currentYear=(new Date).getFullYear(),tecnicosRed=[],ingenieros=[],plantaExterna=[],additionalTelegram={};const employeeColors={"Fabian H.":"#2e5e7e","Marco V.":"#2e5e7e","Guillermo.":"#2e5e7e","Gonzalo S.":"#1b448b","Patricio G.":"#1b448b","Cristian V.":"#176fe1"},employeesTelegram={};let semanaActual=0,asignacionesManual={},feriadosCache=null;async function cargarFeriadosScript(){try{const e=await db.collection("Config").doc("feriados").get();if(e.exists){const n=e.data();n.lista&&Array.isArray(n.lista)&&(feriadosCache=n.lista)}}catch(e){console.error("Error cargando feriados en script.js:",e)}}function generarFeriados(e){return generarListaFeriados(e,feriadosCache)}function asignarTurnos(){const e=document.querySelectorAll("#calendar tbody tr");if(semanaActual>=e.length)return;e.forEach((e,n)=>{if(n!==semanaActual){e.querySelectorAll(".nombre").forEach(e=>{e.textContent="",e.style.backgroundColor=""}),e.classList.remove("assigned-week")}});const n=tecnicosRed[semanaActual%tecnicosRed.length],t=ingenieros[semanaActual%ingenieros.length],a=plantaExterna[semanaActual%plantaExterna.length],o=e[semanaActual],r=o.querySelectorAll("td");r.forEach(e=>{const o=e.querySelectorAll(".nombre");3===o.length&&(o[0].textContent=n,o[0].style.backgroundColor=employeeColors[n]||"#FFFFFF",o[1].textContent=t,o[1].style.backgroundColor=employeeColors[t]||"#FFFFFF",o[2].textContent=a,o[2].style.backgroundColor=employeeColors[a]||"#FFFFFF")}),o.classList.add("assigned-week"),asignacionesManual[semanaActual]={tecnico:n,ingeniero:t,planta:a};const c=[];r.forEach(e=>{const n=e.getAttribute("data-fecha");c.push(n)}),guardarAsignacionEnFirestore({tecnico:n,ingeniero:t,planta:a},semanaActual,currentYear,currentMonth,c),sendEmailNotification({tecnico:n,ingeniero:t,planta:a}),semanaActual++,resaltarSemanaActual(),"block"===document.querySelector(".linear-container")?.style.display&&generarVistaLineal();const l=document.getElementById("open-edit-modal");l&&(l.disabled=!1)}function guardarAsignacionEnFirestore(e,n,t,a,o){if(!o||!o.length)return;const r=o[0],c=o[o.length-1];db.collection("AsignacionesSemanales").doc(`${t}-${a}-${n+1}`).set({tecnico:e.tecnico,ingeniero:e.ingeniero,planta:e.planta,semana:n+1,"aÃ±o":t,mes:a,fechaInicio:r,fechaFin:c}).then(()=>{}).catch(e=>console.error("Error al guardar asignaciÃ³n:",e))}function sendEmailNotification(e){cargarContactosDesdeFirestore().then(n=>{additionalTelegram=n;const t=`Hola ${e.tecnico},\nSe te ha asignado el turno de esta semana.\nIngeniero: ${e.ingeniero}\nPlanta: ${e.planta}`;sendTelegramNotification(e.tecnico,t),sendTelegramNotification(e.ingeniero,`Hola ${e.ingeniero}, Se te ha asignado el turno de esta semana.`),sendTelegramNotification(e.planta,`Hola ${e.planta}, Se te ha asignado el turno de esta semana.`),Object.keys(additionalTelegram).forEach(n=>{sendTelegramNotificationConChatId(additionalTelegram[n],`${n}: Los encargados del turno de la semana actual son:\nTÃ©cnico: ${e.tecnico}\nIngeniero: ${e.ingeniero}\nPlanta: ${e.planta}`)})}).catch(e=>console.error("Error cargando contactos:",e))}function sendTelegramNotification(e,n){const t=employeesTelegram[e];console.log("ðŸ“¢ Intentando enviar mensaje a:",e),console.log("ðŸ“¨ Mensaje:",n),console.log("ðŸ“¬ chatId:",t),t?fetch("https://turnos-app-8viu.onrender.com/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:t,message:n})}).then(e=>e.json()).then(e=>console.log("âœ… Respuesta de Telegram:",e)).catch(e=>console.error("ðŸš¨ Error enviando mensaje:",e)):console.error("ðŸš¨ ERROR: No se encontrÃ³ chat ID para",e)}function sendTelegramNotificationConChatId(e,n){console.log(`ðŸ“¢ Intentando enviar mensaje con chatId: ${e}`),console.log(`ðŸ“¨ Mensaje: ${n}`),e?fetch("https://turnos-app-8viu.onrender.com/send-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,message:n})}).then(e=>e.json()).then(n=>console.log(`âœ… Mensaje enviado al chat ${e}:`,n)).catch(n=>console.error(`ðŸš¨ Error enviando mensaje al chat ${e}:`,n)):console.error("ðŸš¨ ERROR: El chatId es requerido para enviar el mensaje.")}function actualizarUltimaSemana(){console.log("actualizarUltimaSemana invocado");const e=Object.keys(asignacionesManual);if(console.log("Asignaciones manuales:",asignacionesManual,"assignedWeeks:",e),!e.length)return void showCustomAlert("No hay semanas asignadas.");const n=e[e.length-1],t=parseInt(n,10),a=document.getElementById("edit-tecnico")?.value,o=document.getElementById("edit-ingeniero")?.value,r=document.getElementById("edit-planta")?.value;console.log("Valores ingresados:",{nuevoTecnico:a,nuevoIngeniero:o,nuevaPlanta:r});const c=document.querySelectorAll("#calendar tbody tr");if(t<0||t>=c.length)return void showCustomAlert("Semana invÃ¡lida.");const l=asignacionesManual[t]||{},{tecnico:i,ingeniero:s,planta:d}=l,m=c[t],u=m.querySelectorAll("td");u.forEach(e=>{const n=e.querySelectorAll(".nombre");3===n.length&&(n[0].textContent=a,n[0].style.backgroundColor=employeeColors[a]||"#FFFFFF",n[1].textContent=o,n[1].style.backgroundColor=employeeColors[o]||"#FFFFFF",n[2].textContent=r,n[2].style.backgroundColor=employeeColors[r]||"#FFFFFF")}),asignacionesManual[t]={tecnico:a,ingeniero:o,planta:r},m.classList.add("assigned-week");const g=[];u.forEach(e=>{const n=e.getAttribute("data-fecha");g.push(n)}),guardarAsignacionEnFirestore({tecnico:a,ingeniero:o,planta:r},t,currentYear,currentMonth,g);const y=document.getElementById("edit-modal");y?y.style.display="none":console.error("No se encontrÃ³ el elemento 'edit-modal'. AsegÃºrate de haberlo agregado en tu HTML."),showCustomAlert(`La Semana #${t+1} se ha actualizado correctamente.`),resaltarSemanaActual(),"block"===document.querySelector(".linear-container")?.style.display&&generarVistaLineal();let h=`Se ha actualizado la Semana #${t+1}.\n`;h+=a!==i?`Nuevo TÃ©cnico: ${a}\n`:`TÃ©cnico sin cambios (${a})\n`,h+=o!==s?`Nuevo Ingeniero: ${o}\n`:`Ingeniero sin cambios (${o})\n`,h+=r!==d?`Nueva Planta: ${r}\n`:`Planta sin cambios (${r})\n`,sendTelegramNotification(a,h),sendTelegramNotification(o,h),sendTelegramNotification(r,h),Object.keys(additionalTelegram).forEach(e=>{sendTelegramNotificationConChatId(additionalTelegram[e],h)})}function generarVistaLineal(){const e=document.getElementById("linear-list");if(!e)return;e.innerHTML="";const n=Object.keys(asignacionesManual);if(!n.length){const n=document.createElement("p");return n.textContent="No hay turnos asignados para mostrar en la Vista Lineal.",void e.appendChild(n)}n.forEach(n=>{const t=asignacionesManual[n],a=document.querySelector(`#calendar tbody tr:nth-child(${parseInt(n)+1})`);if(!a)return;const o=[];a.querySelectorAll("td").forEach(e=>{const n=e.getAttribute("data-fecha");o.push(n)});const r=new Date(o[0]),c=new Date(o[o.length-1]),l={year:"numeric",month:"short",day:"numeric"},i=r.toLocaleDateString("es-ES",l),s=c.toLocaleDateString("es-ES",l),d=document.createElement("li");d.classList.add("linear-item"),safeInnerHTML(d,`\n      <h3>Semana ${parseInt(n)+1}: ${i} - ${s}</h3>\n      <p><strong>TÃ©cnico:</strong> ${t.tecnico}</p>\n      <p><strong>Ingeniero:</strong> ${t.ingeniero}</p>\n      <p><strong>Planta Externa:</strong> ${t.planta}</p>\n    `),e.appendChild(d)})}function resaltarSemanaActual(){const e=document.getElementById("external-arrow");if(!e)return;const n=obtenerSemanaActual();document.querySelectorAll("#calendar tbody tr").forEach((t,a)=>{if(a===n){const n=t.getBoundingClientRect(),a=document.querySelector(".calendar-container")?.getBoundingClientRect()||{top:0},o=n.top-a.top+n.height/2-10;e.style.top=`${o}px`,e.style.display="block"}})}document.addEventListener("DOMContentLoaded",()=>{cargarFeriadosScript();const e=localStorage.getItem("sidebarOpacity");e&&document.documentElement.style.setProperty("--sidebar-opacity",e);const n=localStorage.getItem("userRole");if((window.location.pathname.endsWith("index.html")||"/"===window.location.pathname)&&n&&"admin"!==n&&"superadmin"!==n&&(window.location.href="directorio.html"),"superadmin"===n){const e=document.getElementById("li-registros"),n=document.getElementById("li-turnos"),t=document.getElementById("li-usuarios"),a=document.getElementById("li-animaciones");e&&(e.style.display="block"),n&&(n.style.display="block"),t&&(t.style.display="block"),a&&(a.style.display="block"),document.body.classList.add("is-admin"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}else if("admin"===n){const e=document.getElementById("li-turnos");e&&(e.style.display="block"),document.body.classList.add("is-admin"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}if("true"===localStorage.getItem("showPasswordPreservationNotice")){localStorage.removeItem("showPasswordPreservationNotice");const e=localStorage.getItem("passwordPreservationEmail")||"tu correo";localStorage.removeItem("passwordPreservationEmail"),setTimeout(()=>{"undefined"!=typeof Swal&&Swal.fire({icon:"info",title:"Â¡Cuenta vinculada con Google!",html:`\n            <p>Ahora puedes iniciar sesiÃ³n con Google.</p>\n            <p style="margin-top: 10px;">Te enviamos un email a <strong>${e}</strong> para que tambiÃ©n puedas usar contraseÃ±a si lo prefieres.</p>\n            <p style="margin-top: 10px; font-size: 0.85em; color: #888;">\n              Revisa tu bandeja de entrada (o spam) y haz clic en el link para establecer tu contraseÃ±a.\n            </p>\n          `,confirmButtonText:"Entendido",confirmButtonColor:"#7796CB"})},500)}}),window.generarCalendario=function(e,n){const t=document.querySelector("#calendar tbody"),a=document.getElementById("calendar-title"),o=document.getElementById("linear-view"),r=document.getElementById("linear-view-btn"),c=(document.getElementById("open-edit-modal"),document.getElementById("calendar-view-btn"));if(!t||!a)return void console.error("Elementos de calendario no encontrados en el DOM.");t.innerHTML="";const l=generarFeriados(n),i=new Date(n,e,1).getDay(),s=new Date(n,e+1,0).getDate(),d=new Date(n,e,0).getDate(),m=0===i?7:i,u=1-(m-1),g=7*Math.ceil((s+m-1)/7);let y=u;for(let a=0;a<g;a++){if(a%7==0){const e=document.createElement("tr");t.appendChild(e)}const o=t.lastChild,r=document.createElement("td");let c;if(r.classList.add("calendario-celda"),y<1){c=new Date(0===e?n-1:n,0===e?11:e-1,d+y),r.classList.add("fuera-de-mes")}else if(y>s){c=new Date(11===e?n+1:n,11===e?0:e+1,y-s),r.classList.add("fuera-de-mes")}else c=new Date(n,e,y);const i=formatDate(c);r.setAttribute("data-fecha",i);const m=l.find(e=>e.fecha===i),u=c.getDate();m?(r.classList.add("feriado"),safeInnerHTML(r,`\n        <div class="dia">${u}</div>\n        <div class="feriado-nombre">${m.nombre}</div>\n        <div class="nombres">\n          <div class="nombre"></div>\n          <div class="nombre"></div>\n          <div class="nombre"></div>\n        </div>`)):safeInnerHTML(r,`\n        <div class="dia">${u}</div>\n        <div class="nombres">\n          <div class="nombre"></div>\n          <div class="nombre"></div>\n          <div class="nombre"></div>\n        </div>`),o.appendChild(r),y++}a.textContent=`${new Intl.DateTimeFormat("es-ES",{month:"long"}).format(new Date(n,e))} ${n}`,semanaActual=0,asignacionesManual={},c&&(c.disabled=!0),r&&(r.disabled=!1),o&&"block"===o.style.display&&generarVistaLineal(),resaltarSemanaActual()},window.cargarAsignacionesGuardadas=function(e,n){return db.collection("AsignacionesSemanales").where("mes","==",e).where("aÃ±o","==",n).get().then(e=>{let n=-1;e.forEach(e=>{const t=e.data(),a=t.semana-1;asignacionesManual[a]={tecnico:t.tecnico,ingeniero:t.ingeniero,planta:t.planta};const o=document.querySelectorAll("#calendar tbody tr");if(o[a]){const e=o[a];e.querySelectorAll("td").forEach(e=>{const n=e.querySelectorAll(".nombre");3===n.length&&(n[0].textContent=t.tecnico,n[0].style.backgroundColor=employeeColors[t.tecnico]||"#FFFFFF",n[1].textContent=t.ingeniero,n[1].style.backgroundColor=employeeColors[t.ingeniero]||"#FFFFFF",n[2].textContent=t.planta,n[2].style.backgroundColor=employeeColors[t.planta]||"#FFFFFF")}),e.classList.add("assigned-week")}a>n&&(n=a)}),semanaActual=n+1;const t=document.getElementById("open-edit-modal");t&&Object.keys(asignacionesManual).length>0&&(t.disabled=!1)}).catch(e=>console.error("Error al cargar asignaciones guardadas:",e))};const HORA_ASIGNACION=9,MINUTO_ASIGNACION=0;function asignacionAutomaticaTurnos(){const e=new Date,n=e.getDay(),t=e.getHours(),a=e.getMinutes();if(1===n&&9===t&&0===a){const e=obtenerSemanaActual();if(asignacionesManual.hasOwnProperty(e)){const e=document.getElementById("open-edit-modal");e&&(e.disabled=!1,console.log("âœ… BotÃ³n 'Editar Semanas' habilitado (auto) porque ya existe asignaciÃ³n."))}else semanaActual=e,asignarTurnos(),console.log("âœ… AsignaciÃ³n automÃ¡tica de turnos ejecutada a las 9:0")}}function inicializarAutomatizacion(){resaltarSemanaActual(),setInterval(asignacionAutomaticaTurnos,6e4);const e=new Date,n=e.getDay(),t=e.getHours(),a=e.getMinutes();if(1===n&&(t>9||9===t&&a>=0)){const e=obtenerSemanaActual();asignacionesManual.hasOwnProperty(e)||(semanaActual=e,asignarTurnos(),console.log("âœ… AsignaciÃ³n automÃ¡tica de turnos al cargar la pÃ¡gina (9:0)"))}const o=document.querySelector("#calendar tbody");if(o){new MutationObserver(resaltarSemanaActual).observe(o,{childList:!0,subtree:!0})}}function buscarAsignacionPorFecha(){const e=document.getElementById("search-date"),n=document.getElementById("search-result");if(!e||!n)return;const t=e.value;if(n.innerHTML="",!t)return void(n.textContent="Por favor, ingrese una fecha vÃ¡lida.");const a=new Date(t);db.collection("AsignacionesSemanales").get().then(e=>{let t=!1;e.forEach(e=>{const o=e.data(),r=new Date(o.fechaInicio),c=new Date(o.fechaFin);a>=r&&a<=c&&(t=!0,safeInnerHTML(n,`\n            <h3>Semana ${o.semana} (${o.fechaInicio} - ${o.fechaFin})</h3>\n            <p><strong>TÃ©cnico:</strong> ${o.tecnico}</p>\n            <p><strong>Ingeniero:</strong> ${o.ingeniero}</p>\n            <p><strong>Planta:</strong> ${o.planta}</p>\n          `))}),t||(n.textContent="No se encontrÃ³ ninguna asignaciÃ³n para la fecha ingresada.")}).catch(e=>{console.error("Error al buscar asignaciÃ³n:",e),n.textContent="OcurriÃ³ un error al buscar la asignaciÃ³n."})}function cargarContactosDesdeFirestore(){return db.collection("ContactosAdicionales").get().then(e=>{const n={};return e.forEach(e=>{n[e.id]=e.data().chatId}),n})}function guardarContactoEnFirestore(e,n){return db.collection("ContactosAdicionales").doc(e).set({chatId:n})}async function eliminarContactoEnFirestore(e){await requireAdmin("eliminar contactos"),await db.collection("ContactosAdicionales").doc(e).delete(),await auditLog("CONTACT_DELETED",{contactName:e})}function leerEmpleados(){return db.collection("Empleados").get().then(e=>{const n=[];return e.forEach(e=>{n.push(e.data())}),n})}async function guardarEmpleadoEnFirestore(e,n,t){await requireAdmin("crear/modificar empleados"),await db.collection("Empleados").doc(e).set({nombre:e,rol:n,telegramChatId:t}),await auditLog("EMPLOYEE_SAVED",{employeeName:e,role:n})}async function eliminarEmpleado(e){await requireAdmin("eliminar empleados"),await requireRecentAuth(5),await db.collection("Empleados").doc(e).delete(),await auditLog("EMPLOYEE_DELETED",{employeeName:e})}function showCustomAlert(e){const n=document.getElementById("custom-alert"),t=document.getElementById("alert-message"),a=document.getElementById("close-alert");n&&t&&a?(t.textContent=e,n.style.display="flex",a.onclick=()=>{n.style.display="none"},window.onclick=e=>{e.target===n&&(n.style.display="none")}):"undefined"!=typeof Swal?Swal.fire("Aviso",e,"info"):console.warn(e)}function callback(){console.log("callback() llamado (dummy)")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("update-week");e&&e.addEventListener("click",actualizarUltimaSemana);const n=document.getElementById("logout-btn");n&&n.addEventListener("click",()=>{auth.signOut().then(()=>{console.log("SesiÃ³n cerrada."),localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>console.error("Error al cerrar sesiÃ³n:",e))}),db.collection("userRoles").get().then(e=>{e.forEach(e=>{console.log(`ðŸ“„ Documento ID: ${e.id}`,e.data())})});const t=document.getElementById("elemento-id");t&&t.addEventListener("click",callback);const a=document.getElementById("prev-month"),o=document.getElementById("next-month");a&&a.addEventListener("click",()=>{currentMonth--,currentMonth<0&&(currentMonth=11,currentYear--),generarCalendario(currentMonth,currentYear),cargarAsignacionesGuardadas(currentMonth,currentYear)}),o&&o.addEventListener("click",()=>{currentMonth++,currentMonth>11&&(currentMonth=0,currentYear++),generarCalendario(currentMonth,currentYear),cargarAsignacionesGuardadas(currentMonth,currentYear)});const r=document.getElementById("assign-turns");r&&r.addEventListener("click",asignarTurnos);const c=document.getElementById("search-button");c&&c.addEventListener("click",buscarAsignacionPorFecha);const l=document.getElementById("calendar-view-btn"),i=document.getElementById("linear-view-btn");l&&l.addEventListener("click",()=>{document.querySelector(".calendar-container").style.display="block",document.querySelector(".linear-container").style.display="none",l.disabled=!0,i.disabled=!1}),i&&i.addEventListener("click",()=>{document.querySelector(".calendar-container").style.display="none",document.querySelector(".linear-container").style.display="block",l.disabled=!1,i.disabled=!0,generarVistaLineal()});const s=document.getElementById("open-edit-modal");s&&s.addEventListener("click",()=>{k().then(()=>{T("edit-tecnico",tecnicosRed),T("edit-ingeniero",ingenieros),T("edit-planta",plantaExterna);const e=document.getElementById("edit-modal");e?e.style.display="flex":console.error("No se encontrÃ³ el elemento con id 'edit-modal'. Agrega el modal correspondiente en tu HTML.")}).catch(e=>console.error("Error al cargar empleados:",e))});const d=document.getElementById("close-edit-modal"),m=document.getElementById("edit-modal");d&&m?(d.addEventListener("click",()=>{m.style.display="none"}),window.addEventListener("click",e=>{e.target===m&&(m.style.display="none")})):console.error("No se encontrÃ³ el botÃ³n o el modal de ediciÃ³n (close-edit-modal / edit-modal)."),inicializarAutomatizacion(),cargarContactosDesdeFirestore().then(e=>{additionalTelegram=e,F()}).catch(e=>console.error("Error al cargar contactos:",e)),k().then(()=>(generarCalendario(currentMonth,currentYear),cargarAsignacionesGuardadas(currentMonth,currentYear))).catch(e=>console.error("Error al inicializar calendario:",e));const u=document.getElementById("manage-additional-btn"),g=document.getElementById("manage-additional-modal"),y=document.getElementById("close-additional-modal");u&&g&&(u.addEventListener("click",()=>{cargarContactosDesdeFirestore().then(e=>{additionalTelegram=e,F(),g.style.display="flex"}).catch(e=>console.error("Error al cargar contactos:",e))}),y&&y.addEventListener("click",()=>{g.style.display="none"}),window.addEventListener("click",e=>{e.target===g&&(g.style.display="none")}));const h=document.getElementById("contact-select"),p=document.getElementById("edit-contact-btn"),E=document.getElementById("delete-contact-btn"),f=document.getElementById("contact-name"),b=document.getElementById("contact-id");h&&p&&E&&(h.addEventListener("change",()=>{h.value?(p.disabled=!1,E.disabled=!1):(p.disabled=!0,E.disabled=!0)}),E&&E.addEventListener("click",()=>{const e=h.value;e&&eliminarContactoEnFirestore(e).then(()=>(showCustomAlert("Contacto eliminado correctamente."),cargarContactosDesdeFirestore())).then(e=>{additionalTelegram=e,F(),h.value="",p.disabled=!0,E.disabled=!0}).catch(e=>console.error("Error al eliminar contacto:",e))}),p&&p.addEventListener("click",()=>{const e=h.value;e&&(f.value=e,b.value=additionalTelegram[e]||"")}));const I=document.getElementById("save-contact");I&&I.addEventListener("click",()=>{const e=document.getElementById("contact-name"),n=document.getElementById("contact-id"),t=document.getElementById("contact-select"),a=document.getElementById("edit-contact-btn"),o=document.getElementById("delete-contact-btn"),r=e.value.trim(),c=n.value.trim();r&&c?guardarContactoEnFirestore(r,c).then(()=>(showCustomAlert("Contacto guardado correctamente."),cargarContactosDesdeFirestore())).then(r=>{additionalTelegram=r,F(),e.value="",n.value="",t.value="",a&&(a.disabled=!0),o&&(o.disabled=!0)}).catch(e=>console.error("Error al guardar contacto:",e)):Swal.fire("Campos requeridos","Por favor, ingrese nombre y chat ID.","warning")});const v=document.getElementById("manage-empleados-btn"),C=document.getElementById("manage-empleados-modal"),w=document.getElementById("close-empleados-modal");v&&C&&(v.addEventListener("click",()=>{M(),C.style.display="flex"}),w&&w.addEventListener("click",()=>{C.style.display="none"}));const A=document.getElementById("empleados-select"),S=document.getElementById("edit-employee-btn"),B=document.getElementById("delete-employee-btn");A&&S&&B&&(A.addEventListener("change",()=>{const e=A.value;S.disabled=!e,B.disabled=!e}),S.addEventListener("click",()=>{const e=A.value;e&&leerEmpleados().then(n=>{const t=n.find(n=>n.nombre===e);t&&(document.getElementById("empleado-name").value=t.nombre,document.getElementById("empleado-rol").value=t.rol,document.getElementById("empleado-chatid").value=t.telegramChatId)}).catch(e=>console.error(e))}),B.addEventListener("click",()=>{const e=A.value;e&&eliminarEmpleado(e).then(()=>(showCustomAlert("Empleado eliminado correctamente."),k())).then(()=>{M(),"flex"===document.getElementById("edit-modal")?.style.display&&(T("edit-tecnico",tecnicosRed),T("edit-ingeniero",ingenieros),T("edit-planta",plantaExterna))}).catch(e=>console.error("Error al eliminar empleado:",e))}));const L=document.getElementById("save-empleado");function F(){const e=document.getElementById("contact-select");if(!e)return;const n=document.createElement("option");n.value="",n.textContent="-- Seleccione un contacto --",e.innerHTML="",e.appendChild(n),Object.keys(additionalTelegram).forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)});const t=document.getElementById("edit-contact-btn"),a=document.getElementById("delete-contact-btn");t&&(t.disabled=!0),a&&(a.disabled=!0)}function k(){return leerEmpleados().then(e=>{tecnicosRed=[],ingenieros=[],plantaExterna=[],e.forEach(e=>{switch(e.rol){case"TÃ©cnico de Red":tecnicosRed.push(e.nombre);break;case"Ingeniero":ingenieros.push(e.nombre);break;case"Planta Externa":plantaExterna.push(e.nombre)}employeesTelegram[e.nombre]=e.telegramChatId,e.color&&(employeeColors[e.nombre]=e.color)})})}function T(e,n){const t=document.getElementById(e);t&&(t.innerHTML="",n.forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}))}function M(){const e=document.getElementById("empleados-select");if(!e)return;const n=document.createElement("option");n.value="",n.textContent="-- Seleccione un empleado --",e.innerHTML="",e.appendChild(n),leerEmpleados().then(n=>{n.forEach(n=>{const t=document.createElement("option");t.value=n.nombre,t.textContent=`${n.nombre} - ${n.rol}`,e.appendChild(t)})}).catch(e=>console.error("Error al cargar empleados en select:",e))}function x(e){const n=document.getElementById("li-registros"),t=(document.getElementById("li-turnos"),document.getElementById("li-usuarios")),a=document.getElementById("li-animaciones");n&&(n.style.display="superadmin"===e?"block":"none"),t&&(t.style.display="superadmin"===e?"block":"none"),a&&(a.style.display="superadmin"===e?"block":"none"),"admin"!==e&&"superadmin"!==e||document.querySelectorAll(".admin-only").forEach(e=>{e.style.display="block"}),"admin"!==e&&"superadmin"!==e&&window.location.pathname.includes("index.html")&&(window.location.href="directorio.html")}L&&L.addEventListener("click",()=>{const e=document.getElementById("empleado-name").value.trim(),n=document.getElementById("empleado-rol").value,t=document.getElementById("empleado-chatid").value.trim();e&&t?guardarEmpleadoEnFirestore(e,n,t).then(()=>(showCustomAlert("Empleado guardado correctamente."),document.getElementById("empleado-name").value="",document.getElementById("empleado-chatid").value="",C.style.display="none",k())).then(()=>{M(),"flex"===document.getElementById("edit-modal")?.style.display&&(T("edit-tecnico",tecnicosRed),T("edit-ingeniero",ingenieros),T("edit-planta",plantaExterna))}).catch(e=>console.error("Error al guardar empleado:",e)):showCustomAlert("Por favor, ingrese nombre y chat ID.")}),document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("lastPage");auth.onAuthStateChanged(n=>{n&&db.collection("userRoles").doc(n.uid).get().then(n=>{if(n.exists){const t=n.data().rol;if("admin"!==t&&"superadmin"!==t&&window.location.pathname.includes("index.html")&&(window.location.href=e||"user.html"),"superadmin"===t){const e=document.getElementById("li-registros");document.getElementById("li-turnos");e&&(e.style.display="block")}}})})}),auth.onAuthStateChanged(e=>{if(e){const n=document.getElementById("welcome-message");n&&(n.textContent=e.email)}else console.warn("Usuario no autenticado. Redirigiendo al login."),window.location.href="login.html"}),document.querySelectorAll(".view-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelector(".active").classList.remove("active","fade"),document.querySelector(`#${e.dataset.target}`).classList.add("active","fade")})});const D=()=>{const e=document.getElementById("sidebar"),n=document.getElementById("main-content");document.querySelectorAll("#menu-toggle").forEach(t=>{t.addEventListener("click",()=>{e.classList.toggle("expanded"),n&&n.classList.toggle("expanded")})}),lucide.createIcons();const t=localStorage.getItem("userRole");t&&(console.log("Aplicando rol desde cachÃ©:",t),x(t)),auth.onAuthStateChanged(e=>{if(e){const n=document.getElementById("welcome-message");n&&(n.textContent=e.email),db.collection("userRoles").doc(e.uid).get().then(e=>{if(e.exists){const n=e.data().rol;n!==t&&(console.log("Rol actualizado desde Firestore:",n),localStorage.setItem("userRole",n),x(n))}}).catch(e=>console.error("Error verificando rol:",e))}else console.warn("Usuario no autenticado. Redirigiendo al login."),window.location.href="login.html"});let a=null;function o(){a&&clearTimeout(a),a=setTimeout(()=>{console.log("Cerrando sesiÃ³n por inactividad en el frontend"),firebase.auth().signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"})},3e6)}window.addEventListener("mousemove",o),window.addEventListener("keydown",o),window.addEventListener("scroll",o),o(),document.getElementById("calendar")&&(console.log("Inicializando calendario..."),generarCalendario(currentMonth,currentYear),k().then(()=>{console.log("Empleados cargados. Cargando asignaciones..."),cargarAsignacionesGuardadas(currentMonth,currentYear),inicializarAutomatizacion()}).catch(e=>{console.error("Error cargando empleados:",e),cargarAsignacionesGuardadas(currentMonth,currentYear)}),document.getElementById("empleados-select")&&M())};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",D):D()});