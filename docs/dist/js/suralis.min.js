import{db}from"./firebase.js";import{showToast}from"./modules/ui/toast.js";document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("categoriesContainer"),t=document.getElementById("selectedSummary"),n=document.querySelector("#emailContentDiv"),o=document.querySelector("#onlineContentDiv"),a=document.getElementById("serviceSearchInput"),r=document.getElementById("clearSearchBtn"),s=document.querySelector(".search-container"),i=new Set;let c={},l="",d=[],u=null,m={};db.collection("suralis_states").doc("current_status").onSnapshot(e=>{e.exists&&(m=e.data()||{},h())},e=>{console.error("Error listening to service states:",e)}),firebase.auth().onAuthStateChanged(e=>{e?(console.log("üë§ Usuario detectado en suralis.js:",e.email),w()):console.warn("üë§ No hay usuario activo en suralis.js")});const p=e=>{const t=document.querySelectorAll(".category-panel");t.forEach(t=>{const n=t.querySelectorAll(".service-item");let o=!1;n.forEach(t=>{const n=t.querySelector(".service-name"),a=n.textContent.toLowerCase(),r=n.textContent;if(""===e||a.includes(e))if(t.style.display="flex",o=!0,""!==e){const t=new RegExp(`(${e})`,"gi");n.innerHTML=r.replace(t,'<span class="highlight-match">$1</span>')}else n.innerHTML=r;else t.style.display="none"}),""===e?(t.style.display="block",t.classList.remove("expanded")):o?(t.style.display="block",t.classList.add("expanded")):t.style.display="none"})},g=async()=>{try{e.innerHTML='<div style="padding:1rem;color:var(--color-texto-secundario);text-align:center;"><i class="fas fa-spinner fa-spin"></i> Cargando servicios...</div>';const t=await db.collection("suralis_services").orderBy("order").get();if(t.empty)return console.warn("No Suralis services found in Firestore. Using fallback data."),c=f(),h(),void v();c={},t.forEach(e=>{const t=e.data();c[t.name]={id:e.id,icon:t.icon||"fa-server",services:t.services||[]}}),h(),E(),S()}catch(e){console.error("Error loading services from Firestore:",e),c=f(),h(),Swal.fire({icon:"warning",title:"Error de conexi√≥n",text:"No se pudieron cargar los servicios. Usando datos de respaldo.",confirmButtonColor:"#7796CB"})}},f=()=>({"Nodo Osorno":{icon:"fa-server",services:["Nodo Osorno - Enlace 1","Nodo Osorno - Enlace 2","Nodo Rahue","Nodo Centro","Nodo Industrial"]},"Enlaces Starlink":{icon:"fa-satellite-dish",services:["Starlink - Sector Norte","Starlink - Sector Sur","Starlink - Respaldo"]}}),v=()=>{const t=document.createElement("div");t.className="setup-hint",t.innerHTML='\n            <i class="fas fa-info-circle"></i>\n            <span>Usando datos de ejemplo. <a href="#" id="populateFirestore">Poblar Firestore con datos iniciales</a></span>\n        ',t.style.cssText="background:rgba(232,194,126,0.15);border:1px solid rgba(232,194,126,0.3);color:var(--color-advertencia);padding:0.75rem 1rem;border-radius:8px;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;",e.parentElement.insertBefore(t,e),document.getElementById("populateFirestore")?.addEventListener("click",async e=>{e.preventDefault(),await y(),t.remove()})},y=async()=>{const e=[{name:"Nodo Osorno",icon:"fa-server",order:1,services:["16765 Suralis Peas Las Quemas","16707 Suralis Peas Rahue Alto","24009 Suralis Peas Virgen Del Socorro","16775 Suralis Peas Hollstein","16576 Suralis Peas Murrimuno","24012 Suralis Peas Angulo Padilla","20008 Suralis Peas Haza√±a Indigena","16731 Suralis Peas Max Kolbe","24003 Suralis Peas Reina Luisa","16737 Suralis Peas Los Clasicos","24005 Suralis Peas Antofagasta","24010 Suralis Peas Kansas","30214 Suralis Aliviadero San Pedro","28004 Suralis Presurizadora Francke","28002 Suralis Peas Kolbe Osorno"]},{name:"Enlaces Starlink",icon:"fa-satellite-dish",order:2,services:["16777 Suralis Oficina Quellon","23994 Suralis Pap/Peap Chaiten","23995 Suralis Oficinal Futaleuf√∫","24039 Suralis Captacion Lajas Blancas","24039 Suralis Parque Castro","24035 Suralis Oficina Paillaco","24004 Suralis Oficina Los Lagos","24038 Suralis Peas O'Higgins- Mafil","24004 Suralis Oficina La Union -Letelier S/N","28000 Suralis Sondaje 2049 La Union","24015 Suralis Peas Los Copihues","24011 Suralis Estanque AP Purranque","24025 Suralis Sondaje 2111 Chonchi","27995 Suralis Sondaje 1940 La Union","24014-Suralis Peas Puerta Sur","26675 Suralis Parque Castro"]}];try{Swal.fire({title:"Guardando...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});for(const t of e)await db.collection("suralis_services").add(t);showToast("Servicios cargados correctamente","success"),await g()}catch(e){console.error("Error populating Firestore:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudieron guardar los datos en Firestore.",confirmButtonColor:"#7796CB"})}},h=()=>{const t=new Set;document.querySelectorAll(".category-panel.expanded").forEach(e=>{const n=e.querySelector(".category-name")?.textContent;n&&t.add(n)}),e.innerHTML="";for(const[n,o]of Object.entries(c)){const a=document.createElement("div");a.className="category-panel "+(t.has(n)?"expanded":"");const r=o.services.filter(e=>i.has(e)).length,s=r>0?"has-selected":"",c=r>0?`${r}/${o.services.length}`:o.services.length;a.innerHTML=`\n                <div class="category-header">\n                    <div class="category-icon"><i class="fas ${o.icon}"></i></div>\n                    <span class="category-name">${n}</span>\n                    <button class="add-service-btn" data-category="${n}" data-id="${o.id||""}" title="Agregar servicio"><i class="fas fa-plus"></i></button>\n                    <span class="category-count ${s}">${c}</span>\n                    <i class="fas fa-chevron-down category-chevron"></i>\n                </div>\n                <div class="category-body">\n                    <div class="category-actions">\n                        <button class="bulk-btn select-all">Seleccionar Todo</button>\n                        <button class="bulk-btn deselect-all">Deseleccionar</button>\n                    </div>\n                    <div class="services-list"></div>\n                </div>\n            `;const l=o.services.length>0?r/o.services.length*100:0,d=a.querySelector(".category-header");d.style.setProperty("--progress",`${l}%`),d.addEventListener("click",e=>{e.target.closest(".add-service-btn")||a.classList.toggle("expanded")});a.querySelector(".add-service-btn").addEventListener("click",e=>{e.stopPropagation(),I(n,o.id)});const u=[...o.services].sort((e,t)=>{const n=m[e],o=m[t],a=n&&"down"===n.status,r=o&&"down"===o.status;return a&&!r?-1:!a&&r?1:0}),p=a.querySelector(".services-list");u.forEach(e=>{const t=i.has(e),n=m[e],o=n&&"down"===n.status,a=document.createElement("div");if(a.className=`service-item ${t?"selected":""} ${o?"is-down":""}`,o){const e=n.by?n.by.split("@")[0]:"Alguien";let t="";if(n.at&&n.at.toDate){const e=n.at.toDate();t=` a las ${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`}a.title=`üî¥ Reportado ca√≠do por ${e}${t}`}a.innerHTML=`\n                    <div class="custom-checkbox"><i class="fas fa-check"></i></div>\n                    <span class="service-name">${e}</span>\n                    ${o?'<i class="fas fa-exclamation-triangle" style="color:#ef4444;margin-left:auto;font-size:0.8rem;"></i>':""}\n                `,a.addEventListener("click",t=>{t.stopPropagation(),b(e)}),p.appendChild(a)});const g=a.querySelector(".select-all"),f=a.querySelector(".deselect-all");g.addEventListener("click",e=>{e.stopPropagation(),o.services.forEach(e=>i.add(e)),h(),E(),S()}),f.addEventListener("click",e=>{e.stopPropagation(),o.services.forEach(e=>i.delete(e)),h(),E(),S()}),e.appendChild(a)}},b=e=>{i.has(e)?i.delete(e):i.add(e),h(),E(),S()},E=()=>{0!==i.size?(t.innerHTML=`\n            <span class="summary-count">\n                <i class="fas fa-check-circle"></i>\n                ${i.size} servicio${i.size>1?"s":""} seleccionado${i.size>1?"s":""}\n            </span>\n            <button class="clear-all-btn">Limpiar todo</button>\n        `,t.querySelector(".clear-all-btn").addEventListener("click",()=>{i.clear(),h(),E(),S()})):t.innerHTML='<span class="summary-placeholder">Ning√∫n servicio seleccionado</span>'};(()=>{const e=document.querySelectorAll(".toolbar-btn");e.forEach(e=>{e.addEventListener("click",n=>{n.preventDefault();const o=e.dataset.command;if("createLink"===o){const e=prompt("Ingrese el enlace:","https://");e&&document.execCommand(o,!1,e)}else o&&document.execCommand(o,!1,null);const a=document.querySelector(".preview-panel.active");if(a){a.querySelector(".email-body")}t()})});const t=()=>{e.forEach(e=>{const t=e.dataset.command;t&&"createLink"!==t&&(document.queryCommandState(t)?(e.classList.add("active"),e.style.color="#7796CB",e.style.background="rgba(119, 150, 203, 0.1)"):(e.classList.remove("active"),e.style.color="",e.style.background=""))})};document.addEventListener("selectionchange",t);document.querySelectorAll(".email-body").forEach(e=>{e.addEventListener("keyup",t),e.addEventListener("mouseup",t)})})();const S=()=>{const e=Array.from(i).map(e=>`‚Ä¢ ${e}`).join("<br>");(()=>{const e=(new Date).getHours()})();n&&(n.innerHTML=`Estimados,<br><br>\nInformamos que nuestro sistema de monitoreo ha detectado una <strong>interrupci√≥n de servicio</strong> afectando a los siguientes enlaces de Suralis:<br><br>\n<strong>Enlaces afectados:</strong><br>\n${e||"<em>(Ninguno seleccionado)</em>"}<br><br>\nPersonal t√©cnico ya ha tomado conocimiento y se encuentra gestionando la incidencia para su pronta soluci√≥n.<br>\nSe mantendr√° informado ante novedades relevantes.<br><br>\nSaludos cordiales,<br>\n${l}`),o&&(o.innerHTML=`Estimados,<br><br>\nConfirmamos el <strong>restablecimiento total</strong> de los servicios afectados. Los siguientes enlaces operan nuevamente dentro de sus par√°metros normales:<br><br>\n<strong>Enlaces restaurados:</strong><br>\n${e||"<em>(Ninguno seleccionado)</em>"}<br><br>\nHemos verificado la estabilidad de la conexi√≥n. Damos por cerrado este incidente.<br><br>\nSaludos cordiales,<br>\n${l}`)},w=()=>{const e=document.querySelectorAll("#signaturesData span"),t=firebase.auth().currentUser;if(!t)return void console.warn("‚ö†Ô∏è setupSignatures: Usuario no autenticado todav√≠a.");const n=t.email?.toLowerCase().trim()||"";console.log("üìù Buscando firma para:",n);let o=null;e.forEach(e=>{(e.dataset.email?.toLowerCase().trim()||"")===n&&(o={url:e.dataset.url,name:e.dataset.name})}),o?(l=`<br><img src="${o.url}" alt="Firma ${o.name}" style="max-height:70px; margin-top:8px;">`,console.log("‚úÖ Firma configurada:",o.name)):(l="",console.warn("‚ö†Ô∏è No se encontr√≥ firma para:",n)),S()};let C=null,B=null;const L=document.getElementById("addServiceModal"),x=document.getElementById("modalCategoryName"),k=document.getElementById("newServiceName"),A=document.getElementById("closeAddServiceModal"),$=document.getElementById("cancelAddService"),T=document.getElementById("saveNewService"),I=(e,t)=>{C=e,B=t,x.textContent=e,k.value="",L.classList.add("active"),setTimeout(()=>k.focus(),100)},P=()=>{L.classList.remove("active"),C=null,B=null},N=async()=>{const e=k.value.trim();if(e)if(B)try{Swal.fire({title:"Guardando...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const t=db.collection("suralis_services").doc(B),n=(await t.get()).data().services||[];if(n.includes(e))return void showToast("Este servicio ya existe","warning");await t.update({services:[...n,e]}),P(),showToast(`Servicio "${e}" agregado`,"success"),await g()}catch(e){console.error("Error saving service:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo guardar el servicio."})}else Swal.fire({icon:"error",title:"Error",text:"No se encontr√≥ la categor√≠a en Firestore.",confirmButtonColor:"#7796CB"});else showToast("Ingresa un nombre para el servicio","warning")};A&&A.addEventListener("click",P),$&&$.addEventListener("click",P),T&&T.addEventListener("click",N),L&&L.addEventListener("click",e=>{e.target===L&&P()}),k&&k.addEventListener("keydown",e=>{"Enter"===e.key&&N()});const M=document.getElementById("forcePopulateBtn");function D(){const e=document.getElementById("recipientsDisplayCaida"),t=document.getElementById("recipientsDisplayOnline"),n=d.length>0?d.map(e=>`<span class="recipient-chip">${e}</span>`).join(""):'<span style="color: var(--color-texto-secundario);">Sin destinatarios</span>';e&&(e.innerHTML=n),t&&(t.innerHTML=n)}function q(){const e=document.getElementById("recipientsList");e&&(e.innerHTML=d.map(e=>`\n            <div class="recipient-item" data-email="${e}">\n                <i class="fas fa-envelope"></i>\n                <span class="recipient-email">${e}</span>\n                <button class="remove-recipient-btn" title="Eliminar"><i class="fas fa-trash-alt"></i></button>\n            </div>\n        `).join(""),e.querySelectorAll(".remove-recipient-btn").forEach(e=>{e.addEventListener("click",async e=>{const t=e.target.closest(".recipient-item").dataset.email;await async function(e){try{d=d.filter(t=>t!==e),await db.collection("suralis_config").doc("recipients").set({emails:d}),D(),q()}catch(e){console.error("Error removing recipient:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo eliminar el email.",confirmButtonColor:"#7796CB"})}}(t)})}))}async function z(e){const t=e.trim().toLowerCase();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return Swal.fire({icon:"error",title:"Email inv√°lido",text:"Por favor ingresa un email v√°lido.",confirmButtonColor:"#7796CB"}),!1;if(d.includes(t))return Swal.fire({icon:"warning",title:"Duplicado",text:"Este email ya est√° en la lista.",confirmButtonColor:"#7796CB"}),!1;try{return d.push(t),await db.collection("suralis_config").doc("recipients").set({emails:d}),D(),q(),showToast(`${t} agregado`,"success"),!0}catch(e){return console.error("Error adding recipient:",e),d.pop(),Swal.fire({icon:"error",title:"Error",text:"No se pudo agregar el email.",confirmButtonColor:"#7796CB"}),!1}}M&&M.addEventListener("click",async()=>{if((await Swal.fire({icon:"question",title:"¬øReiniciar servicios?",text:"Esto eliminar√° los servicios actuales en Firestore y los reemplazar√° con la lista predefinida.",showCancelButton:!0,confirmButtonText:"S√≠, reiniciar",cancelButtonText:"Cancelar",confirmButtonColor:"#7796CB"})).isConfirmed){try{const e=(await db.collection("suralis_services").get()).docs.map(e=>e.ref.delete());await Promise.all(e)}catch(e){console.log("No existing docs to delete or error:",e)}await y()}}),a&&(a.addEventListener("input",e=>{const t=e.target.value.toLowerCase().trim();p(t),t.length>0?s?.classList.add("has-text"):s?.classList.remove("has-text")}),r?.addEventListener("click",()=>{a.value="",p(""),a.focus(),s?.classList.remove("has-text")})),g(),async function(){try{const e=await db.collection("suralis_config").doc("recipients").get();e.exists&&e.data().emails?d=e.data().emails:(d=["contactos.suralis@patagoniaip.cl"],await db.collection("suralis_config").doc("recipients").set({emails:d})),D()}catch(e){console.error("Error loading recipients:",e),d=["contactos.suralis@patagoniaip.cl"],D()}}(),E(),S(),(()=>{const e=document.getElementById("enviarReporteButton"),t=window.location.hostname,a="localhost"===t||"127.0.0.1"===t?"http://localhost:3000":"https://turnos-app-8viu.onrender.com",r=async()=>{try{const e=new firebase.auth.GoogleAuthProvider;e.addScope("https://www.googleapis.com/auth/gmail.send"),e.setCustomParameters({prompt:"consent"});const t=await firebase.auth().signInWithPopup(e),n=t.user,o=t.credential,a=o?.accessToken;a&&(console.log("‚úÖ Re-autorizaci√≥n exitosa. Nuevo token obtenido."),await db.collection("userRoles").doc(n.uid).update({gmailAccessToken:a,gmailTokenUpdatedAt:firebase.firestore.FieldValue.serverTimestamp()}),Swal.fire({icon:"success",title:"Conectado",text:"Permisos de Gmail actualizados. Intenta enviar el reporte nuevamente.",timer:2e3,showConfirmButton:!1}))}catch(e){console.error("Error re-authorizing:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo re-conectar con Google."})}};e&&e.addEventListener("click",()=>{(async e=>{if(0===i.size)return void Swal.fire({icon:"warning",title:"Atenci√≥n",text:"Debes seleccionar al menos un servicio.",confirmButtonColor:"#7796CB"});if(0===d.length)return void Swal.fire({icon:"warning",title:"Sin destinatarios",text:"No hay destinatarios configurados.",confirmButtonColor:"#7796CB"});const t=firebase.auth().currentUser;if("google"!==localStorage.getItem("authProvider"))return void Swal.fire({icon:"info",title:"Inicio de sesi√≥n con Google requerido",html:'\n                        <p style="margin-bottom: 1rem;">Para enviar correos de notificaci√≥n, necesitas estar conectado con tu <strong>cuenta de Google</strong>.</p>\n                        <p style="font-size: 0.9rem; color: #9CA3AF;">Esto permite que el correo se env√≠e desde tu Gmail personal.</p>\n                        <hr style="border-color: rgba(255,255,255,0.1); margin: 1rem 0;">\n                        <p style="font-size: 0.85rem; color: #A1A9B5;">\n                            <strong>¬øC√≥mo hacerlo?</strong><br>\n                            1. Cierra tu sesi√≥n actual<br>\n                            2. Inicia sesi√≥n con el bot√≥n "Google"\n                        </p>\n                    ',confirmButtonText:"Entendido",confirmButtonColor:"#7796CB",background:"#1f2937",customClass:{popup:"swal-dark-popup",title:"swal-dark-title",htmlContainer:"swal-dark-content"}});S();const s="caida"===e?n:o;let c=s?.innerHTML||"";if(!c||""===c.trim()){const t=Array.from(i).map(e=>`‚Ä¢ ${e}`).join("<br>");c="caida"===e?`Estimados,<br><br>\nInformamos que nuestro sistema de monitoreo ha detectado una <strong>interrupci√≥n de servicio</strong> afectando a los siguientes enlaces de Suralis:<br><br>\n<strong>Enlaces afectados:</strong><br>\n${t}<br><br>\nPersonal t√©cnico ya ha tomado conocimiento y se encuentra gestionando la incidencia para su pronta soluci√≥n.<br>\nSe mantendr√° informado ante novedades relevantes.<br><br>\nSaludos cordiales,<br>\n${l}`:`Estimados,<br><br>\nConfirmamos el <strong>restablecimiento total</strong> de los servicios afectados. Los siguientes enlaces operan nuevamente dentro de sus par√°metros normales:<br><br>\n<strong>Enlaces restaurados:</strong><br>\n${t}<br><br>\nHemos verificado la estabilidad de la conexi√≥n. Damos por cerrado este incidente.<br><br>\nSaludos cordiales,<br>\n${l}`}const u="caida"===e?"‚ö†Ô∏è Ca√≠da de Enlaces - Suralis":"‚úÖ Enlaces Normalizados - Suralis";try{if("caida"===e){const e=[];if(i.forEach(t=>{const n=m[t];n&&"down"===n.status&&e.push(t)}),e.length>0&&!(await Swal.fire({icon:"warning",title:"‚ö†Ô∏è ¬øReportar nuevamente?",html:`\n                                <p>Los siguientes servicios ya est√°n marcados como <strong>CA√çDOS</strong>:</p>\n                                <ul style="text-align:left; font-size:0.9rem; color:#ef4444; margin:1rem 0;">\n                                    ${e.map(e=>`<li>${e}</li>`).join("")}\n                                </ul>\n                                <p>¬øEst√°s seguro de que quieres enviar otro reporte?</p>\n                            `,showCancelButton:!0,confirmButtonText:"S√≠, reportar igual",cancelButtonText:"Cancelar",confirmButtonColor:"#ef4444",cancelButtonColor:"#7796CB"})).isConfirmed)return}Swal.fire({title:"Enviando correo...",text:"Contactando con el servidor de correo",html:'\n                        <div class="mail-animation-container">\n                            \x3c!-- Background Elements --\x3e\n                            <div class="wind-line wind-1"></div>\n                            <div class="wind-line wind-2"></div>\n                            <div class="wind-line wind-3"></div>\n                            <div class="wind-line wind-4"></div>\n                            <div class="wind-line wind-5"></div>\n                            \n                            \x3c!-- Main Combine --\x3e\n                            <div class="plane-wrapper">\n                                <i class="fas fa-paper-plane paper-plane"></i>\n                                <div class="exhaust-trail"></div>\n                                <div class="particle p1"></div>\n                                <div class="particle p2"></div>\n                                <div class="particle p3"></div>\n                            </div>\n                        </div>\n                        <h3 style="color:#e5e7eb; font-weight:600; margin-top:15px; margin-bottom:5px;">Enviando Correo...</h3>\n                        <p style="color:#9ca3af; font-size:0.9rem;">Conectando con SMTP seguro</p>\n                    ',allowOutsideClick:!1,showConfirmButton:!1,background:"#1f2937",customClass:{popup:"swal-dark-popup",title:"swal-dark-title",content:"swal-dark-content"},didOpen:()=>{}});const n=await t.getIdToken();console.log("üìß DEBUG - htmlContent length:",c?.length),console.log("üìß DEBUG - htmlContent preview:",c?.substring(0,100));const o=await fetch(`${a}/send-email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({to:[t.email],bcc:d,subject:u,html:c})}),r=await o.json();if(!o.ok||!r.success){if(r.error&&r.error.includes("token"))return void Swal.fire({icon:"warning",title:"Sesi√≥n expirada",html:'<p>Tu sesi√≥n de Google ha expirado.</p><p style="font-size:0.9rem;margin-top:0.5rem;">Por favor, <strong>cierra sesi√≥n</strong> y vuelve a iniciar sesi√≥n con Google para renovar los permisos de env√≠o.</p>',confirmButtonText:"Entendido",confirmButtonColor:"#E8C27E"});throw new Error(r.error||"Error desconocido")}try{const n=db.batch(),o=db.collection("suralisIncidents").doc();n.set(o,{type:e,services:Array.from(i),servicesCount:i.size,sentBy:t?.email||"Sistema",sentAt:firebase.firestore.FieldValue.serverTimestamp(),recipientsCount:d.length});const a=db.collection("suralis_states").doc("current_status"),r={};i.forEach(n=>{r[n]="caida"===e?{status:"down",by:t?.email||"Sistema",at:firebase.firestore.Timestamp.now()}:firebase.firestore.FieldValue.delete()}),n.set(a,r,{merge:!0}),await n.commit(),i.forEach(n=>{"caida"===e?m[n]={status:"down",by:t?.email||"Sistema",at:firebase.firestore.Timestamp.now()}:delete m[n]}),h(),i.clear(),E(),S()}catch(e){console.warn("No se pudo guardar el incidente o estado:",e)}Swal.fire({icon:"success",title:"¬°Correo enviado!",html:`<p>Se envi√≥ correctamente a <strong>${d.length}</strong> destinatario(s).</p><p style="font-size:0.85rem;color:#A1A9B5;margin-top:0.5rem;">Desde: ${t?.email||"Sistema"}</p>`,confirmButtonColor:"#88C0A6"})}catch(e){if(console.error("Error sending email:",e),e.message&&(e.message.includes("NO_GMAIL_TOKEN")||e.message.includes("GMAIL_TOKEN_EXPIRED")))return void Swal.fire({icon:"warning",title:"Permisos de Gmail Requeridos",html:'\n                            <p>Para enviar correos, necesitamos renovar tu permiso de Gmail.</p>\n                            <p style="font-size:0.9rem;margin-top:0.5rem;color:#A1A9B5;">Esto sucede cuando la sesi√≥n expira o no se concedieron permisos inicialmente.</p>\n                        ',showCancelButton:!0,confirmButtonText:"Re-conectar Google",cancelButtonText:"Cancelar",confirmButtonColor:"#E8C27E"}).then(e=>{e.isConfirmed&&r()});Swal.fire({icon:"error",title:"Error al enviar",text:e.message||"No se pudo enviar el correo. Verifica tu conexi√≥n.",confirmButtonColor:"#7796CB"})}})(window.currentReportMode||"caida")})})(),function(){const e=document.getElementById("recipientsModal"),t=document.getElementById("manageRecipientsBtn"),n=document.getElementById("closeRecipientsModal"),o=document.getElementById("cancelRecipients"),a=document.getElementById("addRecipientBtn"),r=document.getElementById("newRecipientEmail");t&&t.addEventListener("click",()=>{q(),e.classList.add("active")});n&&n.addEventListener("click",()=>e.classList.remove("active"));o&&o.addEventListener("click",()=>e.classList.remove("active"));e&&e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")});a&&r&&(a.addEventListener("click",async()=>{await z(r.value)&&(r.value="")}),r.addEventListener("keydown",async e=>{if("Enter"===e.key){await z(r.value)&&(r.value="")}}));firebase.auth().onAuthStateChanged(async e=>{if(e&&t)try{const n=await db.collection("usuarios").doc(e.uid).get();n.exists&&(u=n.data().rol,t.style.display="superadmin"===u?"flex":"none")}catch(e){console.error("Error checking user role:",e),t.style.display="none"}})}(),firebase.auth().onAuthStateChanged(async e=>{if(e){console.log("üìù Usuario autenticado, configurando firma para:",e.email),w();try{const t=await db.collection("userRoles").doc(e.uid).get();if(t.exists){u=t.data().rol,console.log("üîë Rol del usuario:",u);const e=document.querySelector(".manage-recipients-btn");e&&(e.style.display="superadmin"===u?"flex":"none")}}catch(e){console.error("Error checking user role:",e)}}});const O=document.getElementById("dashboardToggle"),H=document.getElementById("dashboardContent");document.getElementById("step-dashboard");let R=null,j=!1;O&&H&&O.addEventListener("click",()=>{const e="none"!==H.style.display;H.style.display=e?"none":"block",O.classList.toggle("expanded",!e),e||j||(!async function(){try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),n=new Date(e.getTime()-2592e6),o=await db.collection("suralisIncidents").orderBy("sentAt","desc").limit(200).get(),a=[];o.forEach(e=>{const t=e.data();a.push({id:e.id,...t,sentAt:t.sentAt?.toDate()||new Date})});const r=a.filter(e=>e.sentAt>=t),s=r.filter(e=>"caida"===e.type).length,i=r.filter(e=>"caida"!==e.type).length,c={};a.filter(e=>"caida"===e.type).forEach(e=>{(e.services||[]).forEach(e=>{const t=e.length>20?e.substring(0,20)+"...":e;c[t]=(c[t]||0)+1})});const l=Object.entries(c).sort((e,t)=>t[1]-e[1])[0];a.forEach((e,t)=>{if("caida"!==e.type)for(let n=t+1;n<a.length;n++){const t=a[n];if("caida"===t.type){if(e.services.some(e=>t.services.includes(e))){const n=e.sentAt-t.sentAt,o=Math.floor(n/6e4),a=Math.floor(o/60),r=o%60;e.durationFormatted=`${a}h ${r}m`;break}}}}),document.getElementById("statCaidasMes").textContent=s,document.getElementById("statNormalizaciones").textContent=i,document.getElementById("statTopServicio").textContent=l?l[0]:"N/A",document.getElementById("statTotalIncidentes").textContent=a.length,function(e){const t=document.getElementById("incidentsTableBody");if(!t)return;if(0===e.length)return void(t.innerHTML='<tr><td colspan="5" style="text-align:center;color:#A1A9B5;">No hay incidentes registrados</td></tr>');t.innerHTML=e.map(e=>{const t=e.sentAt.toLocaleDateString("es-CL",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),n="caida"===e.type?"type-caida":"type-normalizacion",o="caida"===e.type?"‚ö†Ô∏è Ca√≠da":"‚úÖ Normal",a=(e.services||[]).slice(0,2).join(", ")+(e.servicesCount>2?` (+${e.servicesCount-2})`:""),r=e.sentBy?.split("@")[0]||"Sistema";let s="-";return"caida"!==e.type&&e.duration?s=e.duration:"caida"!==e.type&&(s="--"),`\n                <tr>\n                    <td>${t}</td>\n                    <td><span class="incident-type ${n}">${o}</span></td>\n                    <td title="${(e.services||[]).join(", ")}">${a||"N/A"}</td>\n                    <td style="font-family:'Consolas',monospace;font-size:0.9em;color:#A1A9B5;">${e.durationFormatted||"-"}</td>\n                    <td>${r}</td>\n                </tr>\n            `}).join("")}(a.slice(0,10)),function(e){const t=document.getElementById("incidentsChart");if(!t)return;const n={};for(let e=29;e>=0;e--){const t=new Date;t.setDate(t.getDate()-e);const o=t.toLocaleDateString("es-CL",{day:"2-digit",month:"short"});n[o]={caidas:0,normalizaciones:0}}e.forEach(e=>{const t=e.sentAt.toLocaleDateString("es-CL",{day:"2-digit",month:"short"});n[t]&&("caida"===e.type?n[t].caidas++:n[t].normalizaciones++)});const o=Object.keys(n),a=o.map(e=>n[e].caidas),r=o.map(e=>n[e].normalizaciones);R&&R.destroy();R=new Chart(t,{type:"bar",data:{labels:o,datasets:[{label:"Ca√≠das",data:a,backgroundColor:"rgba(239, 68, 68, 0.7)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:1},{label:"Normalizaciones",data:r,backgroundColor:"rgba(34, 197, 94, 0.7)",borderColor:"rgba(34, 197, 94, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#A1A9B5",stepSize:1},grid:{color:"rgba(255,255,255,0.1)"}},x:{ticks:{color:"#A1A9B5",maxRotation:45},grid:{display:!1}}},plugins:{legend:{labels:{color:"#E0E4EA"}}}}})}(a.filter(e=>e.sentAt>=n)),function(e){const t=document.getElementById("incidentsHeatmap");if(!t)return;const n=Array(7).fill().map(()=>Array(24).fill(0));e.forEach(e=>{if("caida"===e.type){const t=e.sentAt,o=t.getDay(),a=t.getHours();n[o][a]++}});const o=["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];let a="";a+='<div class="heatmap-header-cell"></div>';for(let e=0;e<24;e++)a+=`<div class="heatmap-header-cell">${e}h</div>`;for(let e=0;e<7;e++){a+=`<div class="heatmap-row-label">${o[e]}</div>`;for(let t=0;t<24;t++){const r=n[e][t];let s=0;r>0&&(s=1),r>2&&(s=2),r>5&&(s=3),r>10&&(s=4),r>20&&(s=5),a+=`<div class="heatmap-cell intensity-${s}" \n                              data-tooltip="${o[e]} ${t}:00 - ${r} ca√≠das">\n                         </div>`}}t.innerHTML=a}(a)}catch(e){console.error("Error loading dashboard stats:",e)}}(),j=!0)})});