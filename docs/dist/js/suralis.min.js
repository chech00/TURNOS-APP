import{db}from"./firebase.js";import{showToast}from"./modules/ui/toast.js";document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("categoriesContainer"),t=document.getElementById("selectedSummary"),a=document.querySelector("#emailContentDiv"),n=document.querySelector("#onlineContentDiv"),o=document.getElementById("serviceSearchInput"),i=document.getElementById("clearSearchBtn"),s=document.querySelector(".search-container"),r=new Set;let c={},l="",d=[],u=null,m={};db.collection("suralis_states").doc("current_status").onSnapshot(e=>{e.exists&&(m=e.data()||{},h())},e=>{console.error("Error listening to service states:",e)});const p=e=>{const t=document.querySelectorAll(".category-panel");t.forEach(t=>{const a=t.querySelectorAll(".service-item");let n=!1;a.forEach(t=>{const a=t.querySelector(".service-name"),o=a.textContent.toLowerCase(),i=a.textContent;if(""===e||o.includes(e))if(t.style.display="flex",n=!0,""!==e){const t=new RegExp(`(${e})`,"gi");a.innerHTML=i.replace(t,'<span class="highlight-match">$1</span>')}else a.innerHTML=i;else t.style.display="none"}),""===e?(t.style.display="block",t.classList.remove("expanded")):n?(t.style.display="block",t.classList.add("expanded")):t.style.display="none"})},g=async()=>{try{e.innerHTML='<div style="padding:1rem;color:var(--color-texto-secundario);text-align:center;"><i class="fas fa-spinner fa-spin"></i> Cargando servicios...</div>';const t=await db.collection("suralis_services").orderBy("order").get();if(t.empty)return console.warn("No Suralis services found in Firestore. Using fallback data."),c=f(),h(),void v();c={},t.forEach(e=>{const t=e.data();c[t.name]={id:e.id,icon:t.icon||"fa-server",services:t.services||[]}}),h(),S(),b()}catch(e){console.error("Error loading services from Firestore:",e),c=f(),h(),Swal.fire({icon:"warning",title:"Error de conexi√≥n",text:"No se pudieron cargar los servicios. Usando datos de respaldo.",confirmButtonColor:"#7796CB"})}},f=()=>({"Nodo Osorno":{icon:"fa-server",services:["Nodo Osorno - Enlace 1","Nodo Osorno - Enlace 2","Nodo Rahue","Nodo Centro","Nodo Industrial"]},"Enlaces Starlink":{icon:"fa-satellite-dish",services:["Starlink - Sector Norte","Starlink - Sector Sur","Starlink - Respaldo"]}}),v=()=>{const t=document.createElement("div");t.className="setup-hint",t.innerHTML='\n            <i class="fas fa-info-circle"></i>\n            <span>Usando datos de ejemplo. <a href="#" id="populateFirestore">Poblar Firestore con datos iniciales</a></span>\n        ',t.style.cssText="background:rgba(232,194,126,0.15);border:1px solid rgba(232,194,126,0.3);color:var(--color-advertencia);padding:0.75rem 1rem;border-radius:8px;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;",e.parentElement.insertBefore(t,e),document.getElementById("populateFirestore")?.addEventListener("click",async e=>{e.preventDefault(),await y(),t.remove()})},y=async()=>{const e=[{name:"Nodo Osorno",icon:"fa-server",order:1,services:["16765 Suralis Peas Las Quemas","16707 Suralis Peas Rahue Alto","24009 Suralis Peas Virgen Del Socorro","16775 Suralis Peas Hollstein","16576 Suralis Peas Murrimuno","24012 Suralis Peas Angulo Padilla","20008 Suralis Peas Haza√±a Indigena","16731 Suralis Peas Max Kolbe","24003 Suralis Peas Reina Luisa","16737 Suralis Peas Los Clasicos","24005 Suralis Peas Antofagasta","24010 Suralis Peas Kansas","30214 Suralis Aliviadero San Pedro","28004 Suralis Presurizadora Francke","28002 Suralis Peas Kolbe Osorno"]},{name:"Enlaces Starlink",icon:"fa-satellite-dish",order:2,services:["16777 Suralis Oficina Quellon","23994 Suralis Pap/Peap Chaiten","23995 Suralis Oficinal Futaleuf√∫","24039 Suralis Captacion Lajas Blancas","24039 Suralis Parque Castro","24035 Suralis Oficina Paillaco","24004 Suralis Oficina Los Lagos","24038 Suralis Peas O'Higgins- Mafil","24004 Suralis Oficina La Union -Letelier S/N","28000 Suralis Sondaje 2049 La Union","24015 Suralis Peas Los Copihues","24011 Suralis Estanque AP Purranque","24025 Suralis Sondaje 2111 Chonchi","27995 Suralis Sondaje 1940 La Union","24014-Suralis Peas Puerta Sur","26675 Suralis Parque Castro"]}];try{Swal.fire({title:"Guardando...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});for(const t of e)await db.collection("suralis_services").add(t);showToast("Servicios cargados correctamente","success"),await g()}catch(e){console.error("Error populating Firestore:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudieron guardar los datos en Firestore.",confirmButtonColor:"#7796CB"})}},h=()=>{const t=new Set;document.querySelectorAll(".category-panel.expanded").forEach(e=>{const a=e.querySelector(".category-name")?.textContent;a&&t.add(a)}),e.innerHTML="";for(const[a,n]of Object.entries(c)){const o=document.createElement("div");o.className="category-panel "+(t.has(a)?"expanded":"");const i=n.services.filter(e=>r.has(e)).length,s=i>0?"has-selected":"",c=i>0?`${i}/${n.services.length}`:n.services.length;o.innerHTML=`\n                <div class="category-header">\n                    <div class="category-icon"><i class="fas ${n.icon}"></i></div>\n                    <span class="category-name">${a}</span>\n                    <button class="add-service-btn" data-category="${a}" data-id="${n.id||""}" title="Agregar servicio"><i class="fas fa-plus"></i></button>\n                    <span class="category-count ${s}">${c}</span>\n                    <i class="fas fa-chevron-down category-chevron"></i>\n                </div>\n                <div class="category-body">\n                    <div class="category-actions">\n                        <button class="bulk-btn select-all">Seleccionar Todo</button>\n                        <button class="bulk-btn deselect-all">Deseleccionar</button>\n                    </div>\n                    <div class="services-list"></div>\n                </div>\n            `;const l=n.services.length>0?i/n.services.length*100:0,d=o.querySelector(".category-header");d.style.setProperty("--progress",`${l}%`),d.addEventListener("click",e=>{e.target.closest(".add-service-btn")||o.classList.toggle("expanded")});o.querySelector(".add-service-btn").addEventListener("click",e=>{e.stopPropagation(),T(a,n.id)});const u=o.querySelector(".services-list");n.services.forEach(e=>{const t=r.has(e),a=m[e],n=a&&"down"===a.status,o=document.createElement("div");if(o.className=`service-item ${t?"selected":""} ${n?"is-down":""}`,n){const e=a.by?a.by.split("@")[0]:"Alguien";let t="";if(a.at&&a.at.toDate){const e=a.at.toDate();t=` a las ${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`}o.title=`üî¥ Reportado ca√≠do por ${e}${t}`}o.innerHTML=`\n                    <div class="custom-checkbox"><i class="fas fa-check"></i></div>\n                    <span class="service-name">${e}</span>\n                    ${n?'<i class="fas fa-exclamation-triangle" style="color:#ef4444;margin-left:auto;font-size:0.8rem;"></i>':""}\n                `,o.addEventListener("click",t=>{t.stopPropagation(),E(e)}),u.appendChild(o)});const p=o.querySelector(".select-all"),g=o.querySelector(".deselect-all");p.addEventListener("click",e=>{e.stopPropagation(),n.services.forEach(e=>r.add(e)),h(),S(),b()}),g.addEventListener("click",e=>{e.stopPropagation(),n.services.forEach(e=>r.delete(e)),h(),S(),b()}),e.appendChild(o)}},E=e=>{r.has(e)?r.delete(e):r.add(e),h(),S(),b()},S=()=>{0!==r.size?(t.innerHTML=`\n            <span class="summary-count">\n                <i class="fas fa-check-circle"></i>\n                ${r.size} servicio${r.size>1?"s":""} seleccionado${r.size>1?"s":""}\n            </span>\n            <button class="clear-all-btn">Limpiar todo</button>\n        `,t.querySelector(".clear-all-btn").addEventListener("click",()=>{r.clear(),h(),S(),b()})):t.innerHTML='<span class="summary-placeholder">Ning√∫n servicio seleccionado</span>'},b=()=>{const e=Array.from(r).map(e=>`‚Ä¢ ${e}`).join("<br>");(()=>{const e=(new Date).getHours()})();a&&(a.innerHTML=`Estimados,<br><br>\nInformamos que nuestro sistema de monitoreo ha detectado una <strong>interrupci√≥n de servicio</strong> afectando a los siguientes enlaces de Suralis:<br><br>\n<strong>Enlaces afectados:</strong><br>\n${e||"<em>(Ninguno seleccionado)</em>"}<br><br>\nPersonal t√©cnico ya ha tomado conocimiento y se encuentra gestionando la incidencia para su pronta soluci√≥n.<br>\nSe mantendr√° informado ante novedades relevantes.<br><br>\nSaludos cordiales,<br>\n${l}`),n&&(n.innerHTML=`Estimados,<br><br>\nConfirmamos el <strong>restablecimiento total</strong> de los servicios afectados. Los siguientes enlaces operan nuevamente dentro de sus par√°metros normales:<br><br>\n<strong>Enlaces restaurados:</strong><br>\n${e||"<em>(Ninguno seleccionado)</em>"}<br><br>\nHemos verificado la estabilidad de la conexi√≥n. Damos por cerrado este incidente.<br><br>\nSaludos cordiales,<br>\n${l}`)};let w=null,C=null;const B=document.getElementById("addServiceModal"),L=document.getElementById("modalCategoryName"),x=document.getElementById("newServiceName"),k=document.getElementById("closeAddServiceModal"),$=document.getElementById("cancelAddService"),A=document.getElementById("saveNewService"),T=(e,t)=>{w=e,C=t,L.textContent=e,x.value="",B.classList.add("active"),setTimeout(()=>x.focus(),100)},I=()=>{B.classList.remove("active"),w=null,C=null},P=async()=>{const e=x.value.trim();if(e)if(C)try{Swal.fire({title:"Guardando...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const t=db.collection("suralis_services").doc(C),a=(await t.get()).data().services||[];if(a.includes(e))return void showToast("Este servicio ya existe","warning");await t.update({services:[...a,e]}),I(),showToast(`Servicio "${e}" agregado`,"success"),await g()}catch(e){console.error("Error saving service:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo guardar el servicio."})}else Swal.fire({icon:"error",title:"Error",text:"No se encontr√≥ la categor√≠a en Firestore.",confirmButtonColor:"#7796CB"});else showToast("Ingresa un nombre para el servicio","warning")};k&&k.addEventListener("click",I),$&&$.addEventListener("click",I),A&&A.addEventListener("click",P),B&&B.addEventListener("click",e=>{e.target===B&&I()}),x&&x.addEventListener("keydown",e=>{"Enter"===e.key&&P()});const N=document.getElementById("forcePopulateBtn");function M(){const e=document.getElementById("recipientsDisplayCaida"),t=document.getElementById("recipientsDisplayOnline"),a=d.length>0?d.map(e=>`<span class="recipient-chip">${e}</span>`).join(""):'<span style="color: var(--color-texto-secundario);">Sin destinatarios</span>';e&&(e.innerHTML=a),t&&(t.innerHTML=a)}function D(){const e=document.getElementById("recipientsList");e&&(e.innerHTML=d.map(e=>`\n            <div class="recipient-item" data-email="${e}">\n                <i class="fas fa-envelope"></i>\n                <span class="recipient-email">${e}</span>\n                <button class="remove-recipient-btn" title="Eliminar"><i class="fas fa-trash-alt"></i></button>\n            </div>\n        `).join(""),e.querySelectorAll(".remove-recipient-btn").forEach(e=>{e.addEventListener("click",async e=>{const t=e.target.closest(".recipient-item").dataset.email;await async function(e){try{d=d.filter(t=>t!==e),await db.collection("suralis_config").doc("recipients").set({emails:d}),M(),D()}catch(e){console.error("Error removing recipient:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo eliminar el email.",confirmButtonColor:"#7796CB"})}}(t)})}))}async function q(e){const t=e.trim().toLowerCase();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return Swal.fire({icon:"error",title:"Email inv√°lido",text:"Por favor ingresa un email v√°lido.",confirmButtonColor:"#7796CB"}),!1;if(d.includes(t))return Swal.fire({icon:"warning",title:"Duplicado",text:"Este email ya est√° en la lista.",confirmButtonColor:"#7796CB"}),!1;try{return d.push(t),await db.collection("suralis_config").doc("recipients").set({emails:d}),M(),D(),showToast(`${t} agregado`,"success"),!0}catch(e){return console.error("Error adding recipient:",e),d.pop(),Swal.fire({icon:"error",title:"Error",text:"No se pudo agregar el email.",confirmButtonColor:"#7796CB"}),!1}}N&&N.addEventListener("click",async()=>{if((await Swal.fire({icon:"question",title:"¬øReiniciar servicios?",text:"Esto eliminar√° los servicios actuales en Firestore y los reemplazar√° con la lista predefinida.",showCancelButton:!0,confirmButtonText:"S√≠, reiniciar",cancelButtonText:"Cancelar",confirmButtonColor:"#7796CB"})).isConfirmed){try{const e=(await db.collection("suralis_services").get()).docs.map(e=>e.ref.delete());await Promise.all(e)}catch(e){console.log("No existing docs to delete or error:",e)}await y()}}),o&&(o.addEventListener("input",e=>{const t=e.target.value.toLowerCase().trim();p(t),t.length>0?s?.classList.add("has-text"):s?.classList.remove("has-text")}),i?.addEventListener("click",()=>{o.value="",p(""),o.focus(),s?.classList.remove("has-text")})),g(),async function(){try{const e=await db.collection("suralis_config").doc("recipients").get();e.exists&&e.data().emails?d=e.data().emails:(d=["contactos.suralis@patagoniaip.cl"],await db.collection("suralis_config").doc("recipients").set({emails:d})),M()}catch(e){console.error("Error loading recipients:",e),d=["contactos.suralis@patagoniaip.cl"],M()}}(),S(),b(),(()=>{const e=document.getElementById("enviarReporteButton"),t=window.location.hostname,o="localhost"===t||"127.0.0.1"===t?"http://localhost:3000":"https://turnos-app-8viu.onrender.com";e&&e.addEventListener("click",()=>{(async e=>{if(0===r.size)return void Swal.fire({icon:"warning",title:"Atenci√≥n",text:"Debes seleccionar al menos un servicio.",confirmButtonColor:"#7796CB"});if(0===d.length)return void Swal.fire({icon:"warning",title:"Sin destinatarios",text:"No hay destinatarios configurados.",confirmButtonColor:"#7796CB"});const t=firebase.auth().currentUser,i="caida"===e?a:n,s=i?.innerHTML||"",c="caida"===e?"‚ö†Ô∏è Ca√≠da de Enlaces - Suralis":"‚úÖ Enlaces Normalizados - Suralis";try{if("caida"===e){const e=[];if(r.forEach(t=>{const a=m[t];a&&"down"===a.status&&e.push(t)}),e.length>0&&!(await Swal.fire({icon:"warning",title:"‚ö†Ô∏è ¬øReportar nuevamente?",html:`\n                                <p>Los siguientes servicios ya est√°n marcados como <strong>CA√çDOS</strong>:</p>\n                                <ul style="text-align:left; font-size:0.9rem; color:#ef4444; margin:1rem 0;">\n                                    ${e.map(e=>`<li>${e}</li>`).join("")}\n                                </ul>\n                                <p>¬øEst√°s seguro de que quieres enviar otro reporte?</p>\n                            `,showCancelButton:!0,confirmButtonText:"S√≠, reportar igual",cancelButtonText:"Cancelar",confirmButtonColor:"#ef4444",cancelButtonColor:"#7796CB"})).isConfirmed)return}Swal.fire({title:"Enviando correo...",text:"Contactando con el servidor de correo",html:'\n                        <div class="mail-animation-container">\n                            \x3c!-- Background Elements --\x3e\n                            <div class="wind-line wind-1"></div>\n                            <div class="wind-line wind-2"></div>\n                            <div class="wind-line wind-3"></div>\n                            <div class="wind-line wind-4"></div>\n                            <div class="wind-line wind-5"></div>\n                            \n                            \x3c!-- Main Combine --\x3e\n                            <div class="plane-wrapper">\n                                <i class="fas fa-paper-plane paper-plane"></i>\n                                <div class="exhaust-trail"></div>\n                                <div class="particle p1"></div>\n                                <div class="particle p2"></div>\n                                <div class="particle p3"></div>\n                            </div>\n                        </div>\n                        <h3 style="color:#e5e7eb; font-weight:600; margin-top:15px; margin-bottom:5px;">Enviando Correo...</h3>\n                        <p style="color:#9ca3af; font-size:0.9rem;">Conectando con SMTP seguro</p>\n                    ',allowOutsideClick:!1,showConfirmButton:!1,background:"#1f2937",customClass:{popup:"swal-dark-popup",title:"swal-dark-title",content:"swal-dark-content"},didOpen:()=>{}});const a=await t.getIdToken(),n=await fetch(`${o}/send-email`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({to:d,subject:c,html:s})}),i=await n.json();if(!n.ok||!i.success){if(i.error&&i.error.includes("token"))return void Swal.fire({icon:"warning",title:"Sesi√≥n expirada",html:'<p>Tu sesi√≥n de Google ha expirado.</p><p style="font-size:0.9rem;margin-top:0.5rem;">Por favor, <strong>cierra sesi√≥n</strong> y vuelve a iniciar sesi√≥n con Google para renovar los permisos de env√≠o.</p>',confirmButtonText:"Entendido",confirmButtonColor:"#E8C27E"});throw new Error(i.error||"Error desconocido")}try{const a=db.batch(),n=db.collection("suralisIncidents").doc();a.set(n,{type:e,services:Array.from(r),servicesCount:r.size,sentBy:t?.email||"Sistema",sentAt:firebase.firestore.FieldValue.serverTimestamp(),recipientsCount:d.length});const o=db.collection("suralis_states").doc("current_status"),i={};r.forEach(a=>{i[a]="caida"===e?{status:"down",by:t?.email||"Sistema",at:firebase.firestore.Timestamp.now()}:firebase.firestore.FieldValue.delete()}),a.set(o,i,{merge:!0}),await a.commit()}catch(e){console.warn("No se pudo guardar el incidente o estado:",e)}Swal.fire({icon:"success",title:"¬°Correo enviado!",html:`<p>Se envi√≥ correctamente a <strong>${d.length}</strong> destinatario(s).</p><p style="font-size:0.85rem;color:#A1A9B5;margin-top:0.5rem;">Desde: ${t?.email||"Sistema"}</p>`,confirmButtonColor:"#88C0A6"})}catch(e){console.error("Error sending email:",e),Swal.fire({icon:"error",title:"Error al enviar",text:e.message||"No se pudo enviar el correo. Verifica tu conexi√≥n.",confirmButtonColor:"#7796CB"})}})(window.currentReportMode||"caida")})})(),function(){const e=document.getElementById("recipientsModal"),t=document.getElementById("manageRecipientsBtn"),a=document.getElementById("closeRecipientsModal"),n=document.getElementById("cancelRecipients"),o=document.getElementById("addRecipientBtn"),i=document.getElementById("newRecipientEmail");t&&t.addEventListener("click",()=>{D(),e.classList.add("active")});a&&a.addEventListener("click",()=>e.classList.remove("active"));n&&n.addEventListener("click",()=>e.classList.remove("active"));e&&e.addEventListener("click",t=>{t.target===e&&e.classList.remove("active")});o&&i&&(o.addEventListener("click",async()=>{await q(i.value)&&(i.value="")}),i.addEventListener("keydown",async e=>{if("Enter"===e.key){await q(i.value)&&(i.value="")}}));firebase.auth().onAuthStateChanged(async e=>{if(e&&t)try{const a=await db.collection("usuarios").doc(e.uid).get();a.exists&&(u=a.data().rol,t.style.display="superadmin"===u?"flex":"none")}catch(e){console.error("Error checking user role:",e),t.style.display="none"}})}(),firebase.auth().onAuthStateChanged(async e=>{if(e){console.log("üìù Usuario autenticado, configurando firma para:",e.email),(()=>{const e=document.querySelectorAll("#signaturesData span"),t=firebase.auth().currentUser,a=t?.email?.toLowerCase()||"";console.log("üìù Buscando firma para:",a);let n=null;e.forEach(e=>{(e.dataset.email?.toLowerCase()||"")===a&&(n={url:e.dataset.url,name:e.dataset.name})}),n?(l=`<br><img src="${n.url}" alt="Firma ${n.name}" style="max-height:70px; margin-top:8px;">`,console.log("‚úÖ Firma configurada:",n.name)):(l="",console.warn("‚ö†Ô∏è No se encontr√≥ firma para:",a)),b()})();try{const t=await db.collection("userRoles").doc(e.uid).get();t.exists&&(u=t.data().rol,console.log("üîë Rol del usuario:",u),"superadmin"!==u?document.querySelectorAll(".superadmin-only").forEach(e=>{e.style.display="none"}):document.querySelectorAll(".superadmin-only").forEach(e=>{e.classList.contains("manage-recipients-btn")?e.style.display="flex":e.style.display="block"}))}catch(e){console.error("Error checking user role:",e),document.querySelectorAll(".superadmin-only").forEach(e=>{e.style.display="none"})}}});const H=document.getElementById("dashboardToggle"),z=document.getElementById("dashboardContent");document.getElementById("step-dashboard");let O=null,j=!1;H&&z&&H.addEventListener("click",()=>{const e="none"!==z.style.display;z.style.display=e?"none":"block",H.classList.toggle("expanded",!e),e||j||(!async function(){try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),a=new Date(e.getTime()-2592e6),n=await db.collection("suralisIncidents").orderBy("sentAt","desc").limit(200).get(),o=[];n.forEach(e=>{const t=e.data();o.push({id:e.id,...t,sentAt:t.sentAt?.toDate()||new Date})});const i=o.filter(e=>e.sentAt>=t),s=i.filter(e=>"caida"===e.type).length,r=i.filter(e=>"caida"!==e.type).length,c={};o.filter(e=>"caida"===e.type).forEach(e=>{(e.services||[]).forEach(e=>{const t=e.length>20?e.substring(0,20)+"...":e;c[t]=(c[t]||0)+1})});const l=Object.entries(c).sort((e,t)=>t[1]-e[1])[0];o.forEach((e,t)=>{if("caida"!==e.type)for(let a=t+1;a<o.length;a++){const t=o[a];if("caida"===t.type){if(e.services.some(e=>t.services.includes(e))){const a=e.sentAt-t.sentAt,n=Math.floor(a/6e4),o=Math.floor(n/60),i=n%60;e.durationFormatted=`${o}h ${i}m`;break}}}}),document.getElementById("statCaidasMes").textContent=s,document.getElementById("statNormalizaciones").textContent=r,document.getElementById("statTopServicio").textContent=l?l[0]:"N/A",document.getElementById("statTotalIncidentes").textContent=o.length,function(e){const t=document.getElementById("incidentsTableBody");if(!t)return;if(0===e.length)return void(t.innerHTML='<tr><td colspan="5" style="text-align:center;color:#A1A9B5;">No hay incidentes registrados</td></tr>');t.innerHTML=e.map(e=>{const t=e.sentAt.toLocaleDateString("es-CL",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),a="caida"===e.type?"type-caida":"type-normalizacion",n="caida"===e.type?"‚ö†Ô∏è Ca√≠da":"‚úÖ Normal",o=(e.services||[]).slice(0,2).join(", ")+(e.servicesCount>2?` (+${e.servicesCount-2})`:""),i=e.sentBy?.split("@")[0]||"Sistema";let s="-";return"caida"!==e.type&&e.duration?s=e.duration:"caida"!==e.type&&(s="--"),`\n                <tr>\n                    <td>${t}</td>\n                    <td><span class="incident-type ${a}">${n}</span></td>\n                    <td title="${(e.services||[]).join(", ")}">${o||"N/A"}</td>\n                    <td style="font-family:'Consolas',monospace;font-size:0.9em;color:#A1A9B5;">${e.durationFormatted||"-"}</td>\n                    <td>${i}</td>\n                </tr>\n            `}).join("")}(o.slice(0,10)),function(e){const t=document.getElementById("incidentsChart");if(!t)return;const a={};for(let e=29;e>=0;e--){const t=new Date;t.setDate(t.getDate()-e);const n=t.toLocaleDateString("es-CL",{day:"2-digit",month:"short"});a[n]={caidas:0,normalizaciones:0}}e.forEach(e=>{const t=e.sentAt.toLocaleDateString("es-CL",{day:"2-digit",month:"short"});a[t]&&("caida"===e.type?a[t].caidas++:a[t].normalizaciones++)});const n=Object.keys(a),o=n.map(e=>a[e].caidas),i=n.map(e=>a[e].normalizaciones);O&&O.destroy();O=new Chart(t,{type:"bar",data:{labels:n,datasets:[{label:"Ca√≠das",data:o,backgroundColor:"rgba(239, 68, 68, 0.7)",borderColor:"rgba(239, 68, 68, 1)",borderWidth:1},{label:"Normalizaciones",data:i,backgroundColor:"rgba(34, 197, 94, 0.7)",borderColor:"rgba(34, 197, 94, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#A1A9B5",stepSize:1},grid:{color:"rgba(255,255,255,0.1)"}},x:{ticks:{color:"#A1A9B5",maxRotation:45},grid:{display:!1}}},plugins:{legend:{labels:{color:"#E0E4EA"}}}}})}(o.filter(e=>e.sentAt>=a)),function(e){const t=document.getElementById("incidentsHeatmap");if(!t)return;const a=Array(7).fill().map(()=>Array(24).fill(0));e.forEach(e=>{if("caida"===e.type){const t=e.sentAt,n=t.getDay(),o=t.getHours();a[n][o]++}});const n=["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];let o="";o+='<div class="heatmap-header-cell"></div>';for(let e=0;e<24;e++)o+=`<div class="heatmap-header-cell">${e}h</div>`;for(let e=0;e<7;e++){o+=`<div class="heatmap-row-label">${n[e]}</div>`;for(let t=0;t<24;t++){const i=a[e][t];let s=0;i>0&&(s=1),i>2&&(s=2),i>5&&(s=3),i>10&&(s=4),i>20&&(s=5),o+=`<div class="heatmap-cell intensity-${s}" \n                              data-tooltip="${n[e]} ${t}:00 - ${i} ca√≠das">\n                         </div>`}}t.innerHTML=o}(o)}catch(e){console.error("Error loading dashboard stats:",e)}}(),j=!0)})});