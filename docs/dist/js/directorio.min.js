const CONFIG={names:{nightShiftSpecial:"Cristian Oyarzo",holidaySpecial1:"Sergio Castillo",holidaySpecial2:"Ignacio Aburto"}};let allEmployees=[],onlineUnsubscribe=null,currentFilter="all",searchTerm="",currentViewMode="grid",sortableInstance=null,employeeOrder=[];function waitForFirebase(e,t=50,a=100){let o=0;const n=()=>{o++,window.db?(console.log("[DIRECTORIO] Firebase ready after",o,"attempts"),e()):o<t?setTimeout(n,a):(console.warn("[DIRECTORIO] Firebase not available, using fallback"),e())};n()}async function loadEmployees(){const e=document.getElementById("employees-grid");if(e)try{let e=[];if(window.db)try{const t=await window.db.collection("Config").doc("empleados_noc").get();t.exists&&t.data().lista&&(e=t.data().lista),e.some(e=>e.nombre===CONFIG.names.nightShiftSpecial)||(console.log(`[DIRECTORIO] Agregando empleado especial faltante: ${CONFIG.names.nightShiftSpecial}`),e.push({nombre:CONFIG.names.nightShiftSpecial,cargo:"Operador NOC (Noche)",telefono:"",email:"",telegram:""}));const a=await window.db.collection("empleados").get(),o={};a.forEach(e=>{o[e.id]=e.data()}),e=e.map(e=>({...e,...o[e.nombre]||{}}))}catch(e){console.warn("[DIRECTORIO] Error cargando desde Firestore:",e)}0===e.length&&console.warn("[DIRECTORIO] No employees found in database.");const t=await getCalendarData();e=e.map(e=>{const a=getEmployeeStatus(e.nombre,t),o=getNextVacation(e.nombre,t);return{...e,...a,rawShift:a.shift,proximaVacacion:o}}),allEmployees=e,renderEmployees(e),updateStats(e),startOnlineStatusListener()}catch(t){console.error("[DIRECTORIO] Error fatal:",t),e.innerHTML='<div class="no-results"><i data-lucide="alert-circle"></i><h3>Error al cargar</h3><p>No se pudo cargar el directorio de empleados</p></div>',window.lucide&&lucide.createIcons()}}async function getCalendarData(){const e=new Date,t=e.getFullYear(),a=`calendar_v3_${t}-${e.getMonth()+1}`,o=localStorage.getItem(a);if(o){console.log("[DIRECTORIO] Calendario cargado desde localStorage");const e=JSON.parse(o);return e._debugSource="Local",e}const n=["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"][e.getMonth()],i=[`${n} ${t}`,`${n.charAt(0).toUpperCase()+n.slice(1)} ${t}`,n.toUpperCase()+` ${t}`];if(console.log("[DIRECTORIO] localStorage vac√≠o. Buscando en Firestore:",i),window.db||(console.log("[DIRECTORIO] Esperando Firebase..."),await new Promise(e=>{let t=0;const a=setInterval(()=>{t++,(window.db||t>30)&&(clearInterval(a),e())},100)})),window.db)try{for(const e of i){const t=await window.db.collection("calendarios").doc(e).get();if(t.exists){console.log(`[DIRECTORIO] Calendario encontrado en Firestore: ${e}`);const o=t.data();return localStorage.setItem(a,JSON.stringify(o)),o._debugSource=`Fire:${e}`,o}}console.warn("[DIRECTORIO] No se encontr√≥ calendario en Firestore para:",i)}catch(e){console.warn("[DIRECTORIO] Error buscando en Firestore:",e)}else console.warn("[DIRECTORIO] Firebase no disponible despu√©s de esperar");return{_debugSource:"None"}}function getEmployeeStatus(e,t){try{const a=(new Date).getDate().toString(),o=a.padStart(2,"0");if(!t||!t.assignments)return{status:"free",shift:`NoCalData (${t?._debugSource||"Null"})`};let n;if(n=e===CONFIG.names.nightShiftSpecial?t.nocturno:t.assignments[e],!n)return{status:"free",shift:`NoEmp (${t._debugSource})`};const i={M0:{start:"09:00",end:"19:00"},M0A:{start:"09:00",end:"19:00"},M1:{start:"08:30",end:"17:30",sat:{start:"08:30",end:"13:30"}},M1A:{start:"08:30",end:"18:30"},M1B:{start:"07:00",end:"17:00"},M2:{start:"11:00",end:"20:00",sat:{start:"13:00",end:"18:00"}},M2A:{start:"10:00",end:"20:00"},M2B:{start:"10:00",end:"20:00"},M3:{start:"11:00",end:"21:00"},T:{start:"15:00",end:"23:00"},S:{start:"09:00",end:"18:00"},I:{start:"09:00",end:"18:00"}};if(e===CONFIG.names.nightShiftSpecial){const e=new Date,a=e.getHours(),o=e.getDay();let n=!1,i=!1;if(t&&t.feriados){const a=e.getDate().toString(),o=a.padStart(2,"0");(t.feriados[a]||t.feriados[o])&&(n=!0);const r=new Date(e);r.setDate(e.getDate()-1);const l=r.getDate().toString(),s=l.padStart(2,"0");(t.feriados[l]||t.feriados[s])&&(i=!0)}let r="free",l="Libre",s="coffee";return o>=2&&o<=6&&a<7&&!i||0===o&&a<2&&!i||1===o&&a<2&&!i||o>=1&&o<=5&&a>=21&&!n||6===o&&a>=21&&!n||0===o&&a>=21&&!n?(r="night",l="De Turno (Noche)",s="moon"):a>=19&&a<21&&!n&&(r="upcoming",l="Entra 21:00",s="clock"),{status:r,shift:"Nocturno",customLabel:l,customIcon:s}}if(t.feriados){const n=t.feriados[a]||t.feriados[o];if(n){let t=!1;if("S"===n&&e===CONFIG.names.holidaySpecial1&&(t=!0),"I"===n&&e===CONFIG.names.holidaySpecial2&&(t=!0),t){const e=new Date,t=e.getHours(),a=e.getDay();let o=!1;if(o=6===a?t>=19:0===a?t<2||t>=19:1===a?t<2:t>=19||t<2,o){let e="Libre",o="coffee",n="free";return 6===a&&t>=21?(e="De Turno (Feriado)",o="moon",n="night"):6===a&&t>=19?(e="Entra 21:00",o="clock",n="upcoming"):0===a&&t<2||0===a&&t>=21?(e="De Turno (Feriado)",o="moon",n="night"):0===a&&t>=19?(e="Entra 21:00",o="clock",n="upcoming"):1===a&&t<2||t>=21||t<2?(e="De Turno (Feriado)",o="moon",n="night"):t>=19&&(e="Entra 21:00",o="clock",n="upcoming"),{status:n,shift:"Feriado (21:00 - 02:00)",customLabel:e,customIcon:o}}}}}const r=n[a]||n[o];if(r){if(["L","DL","F"].includes(r))return{status:"free",shift:r};if("V"===r)return{status:"vacation",shift:r};if("N"===r)return{status:"night",shift:"N (21:00 - 07:00)"};{let e="De Turno",t="briefcase",a="working";const o=i[r];if(o){const n=new Date,i=n.getDay();let r=o;6===i&&o.sat&&(r=o.sat);const[l,s]=r.start.split(":").map(Number),[c,d]=r.end.split(":").map(Number),m=60*n.getHours()+n.getMinutes();m>60*c+d?(e="Turno Finalizado",t="check-circle",a="free"):m<60*l+s&&(e=`Entra ${r.start}`,t="clock",a="upcoming")}return"Turno Finalizado"===e?{status:"free",shift:r,customLabel:e,customIcon:t}:{status:a,shift:r,customLabel:e,customIcon:t}}}return{status:"free",shift:`Empty (Day:${a}/${o}, Keys:[${Object.keys(n).slice(0,5).join(",")}]...)`}}catch(e){return{status:"free",shift:"Error"}}}function getNextVacation(e,t){if(!t)return null;let a;if(e===CONFIG.names.nightShiftSpecial?a=t.nocturno:t.assignments&&(a=t.assignments[e]),!a)return null;const o=new Date,n=o.getDate(),i=new Date(o.getFullYear(),o.getMonth()+1,0).getDate();for(let e=n+1;e<=i;e++){const t=e.toString(),n=t.padStart(2,"0");if("V"===(a[t]||a[n]))return`${n}/${(o.getMonth()+1).toString().padStart(2,"0")}`}return null}function renderEmployees(e){const t=document.getElementById("employees-grid");if(!t)return;let a=e;if(searchTerm){const e=searchTerm.toLowerCase();a=a.filter(t=>t.nombre?.toLowerCase().includes(e)||t.cargo?.toLowerCase().includes(e))}"all"!==currentFilter&&(a=a.filter(e=>e.status===currentFilter));const o=JSON.parse(localStorage.getItem("directoryOrder")||"[]");if(o.length>0&&"all"===currentFilter&&!searchTerm&&a.sort((e,t)=>{const a=o.indexOf(e.nombre),n=o.indexOf(t.nombre);return-1===a&&-1===n?0:-1===a?1:-1===n?-1:a-n}),0===a.length)return t.innerHTML='\n      <div class="no-results">\n        <i data-lucide="search-x"></i>\n        <h3>Sin resultados</h3>\n        <p>No se encontraron empleados con los filtros aplicados</p>\n      </div>\n    ',void(window.lucide&&lucide.createIcons());t.innerHTML="";const n=document.createDocumentFragment();a.forEach((e,t)=>{const a=createEmployeeCard(e,t);n.appendChild(a)}),t.appendChild(n),window.lucide&&lucide.createIcons(),initSortable()}function createEmployeeCard(e,t){const a=document.createElement("div");a.className="employee-card",a.style.animationDelay=.05*t+"s";const o=e.photoURL||e.fotoUrl||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.nombre)}&background=7796cb&color=fff&size=120`,n=e.cargo||"Operador NOC",i=e.status||"free",r={working:{label:"De Turno",icon:"briefcase"},upcoming:{label:"Pr√≥ximo",icon:"clock"},free:{label:"Libre",icon:"coffee"},vacation:{label:"Vacaciones",icon:"palm-tree"},next:{label:"Pr√≥ximo Turno",icon:"clock"},night:{label:"Turno Noche",icon:"moon"}};let l=r[i]||r.free;e.customLabel&&(l={...l,label:e.customLabel,icon:e.customIcon||l.icon});const s=localStorage.getItem("userRole"),c="superadmin"===s,d="admin"===s||"superadmin"===s?`<button class="action-btn edit" title="Editar" data-name="${e.nombre}"><i data-lucide="edit-2"></i></button>`:"",m=`<span style="font-size:9px; color:#aaa; display:block; margin-top:4px;">${e.rawShift||"None"}</span>`,u=c?'<div class="drag-handle" title="Arrastrar para reordenar"><i data-lucide="grip-vertical"></i></div>':"";return a.innerHTML=`\n    ${u}\n    <button class="expand-toggle" title="Ver m√°s">\n      <i data-lucide="chevron-down"></i>\n    </button>\n    <div class="employee-card-header">\n      <div class="employee-photo-container">\n        <img src="${o}" alt="${e.nombre}" class="employee-photo" \n             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(e.nombre)}&background=7796cb&color=fff&size=120'" />\n        <div class="online-indicator" id="online-${t}" data-email="${e.email||""}"></div>\n    </div>\n    </div>\n    <div class="employee-card-body">\n      <h3 class="employee-name">${e.nombre}</h3>\n      <p class="employee-role">${n}</p>\n      <div class="employee-status ${i}">\n        <i data-lucide="${l.icon}"></i>\n        ${l.label}\n      </div>\n      <div class="employee-meta">\n          ${e.fechaNacimiento?`<div class="meta-item"><i data-lucide="cake"></i> <span>${e.fechaNacimiento}</span></div>`:""}\n          ${e.proximaVacacion?`<div class="meta-item highlight"><i data-lucide="plane"></i> <span>Vacaciones: ${e.proximaVacacion}</span></div>`:""}\n      </div>\n      ${m} \n      <div class="employee-actions">\n        ${e.telegram?`<button class="action-btn telegram" title="Telegram" data-telegram="${e.telegram}"><i data-lucide="send"></i></button>`:""}\n        ${e.telefono?`<button class="action-btn phone" title="Llamar" data-phone="${e.telefono}"><i data-lucide="phone"></i></button>`:""}\n        ${e.email?`<button class="action-btn email" title="Email" data-email="${e.email}"><i data-lucide="mail"></i></button>`:""}\n        ${d}\n      </div>\n    </div>\n    <div class="expand-content">\n      <div class="detail-row">\n        <i data-lucide="briefcase"></i>\n        <span class="detail-label">Turno:</span>\n        <span class="detail-value">${e.rawShift||"Sin asignar"}</span>\n      </div>\n      <div class="detail-row">\n        <i data-lucide="user"></i>\n        <span class="detail-label">Cargo:</span>\n        <span class="detail-value">${n}</span>\n      </div>\n      ${e.telefono?`<div class="detail-row"><i data-lucide="phone"></i><span class="detail-label">Tel√©fono:</span><span class="detail-value">${e.telefono}</span></div>`:""}\n      ${e.email?`<div class="detail-row"><i data-lucide="mail"></i><span class="detail-label">Email:</span><span class="detail-value">${e.email}</span></div>`:""}\n    </div>\n  `,a.querySelector(".action-btn.telegram")?.addEventListener("click",e=>{const t=e.currentTarget.dataset.telegram;t&&window.open(`https://t.me/${t}`,"_blank")}),a.querySelector(".action-btn.phone")?.addEventListener("click",e=>{const t=e.currentTarget.dataset.phone;t&&(window.location.href=`tel:${t}`)}),a.querySelector(".action-btn.email")?.addEventListener("click",e=>{const t=e.currentTarget.dataset.email;t&&(window.location.href=`mailto:${t}`)}),a.querySelector(".action-btn.edit")?.addEventListener("click",e=>{editEmployee(e.currentTarget.dataset.name)}),a.querySelector(".expand-toggle")?.addEventListener("click",e=>{e.stopPropagation(),a.classList.toggle("expanded"),window.lucide&&lucide.createIcons()}),a}function updateStats(e){const t=e.length,a=e.filter(e=>"working"===e.status).length,o=e.filter(e=>"free"===e.status).length,n=e.filter(e=>"vacation"===e.status).length;document.getElementById("stat-total").textContent=t,document.getElementById("stat-working").textContent=a,document.getElementById("stat-free").textContent=o,document.getElementById("stat-vacation").textContent=n}function editEmployee(e){const t=allEmployees.find(t=>t.nombre===e);if(!t)return void Swal.fire("Error","Empleado no encontrado","error");const a=t.photoURL||t.fotoUrl||`https://ui-avatars.com/api/?name=${encodeURIComponent(e)}&background=7796cb&color=fff&size=120`;Swal.fire({title:"Editar Empleado",html:`\n            <div class="edit-employee-form" style="display: grid; grid-template-columns: 120px 1fr; gap: 20px; align-items: start; text-align: left;">\n                \n                \x3c!-- Left Column: Photo --\x3e\n                <div class="edit-photo-container" style="text-align:center;">\n                    <label for="edit-photo-input" style="cursor:pointer; display:inline-block; position:relative; transition: transform 0.2s;" \n                           onmouseover="this.style.transform='scale(1.05)'" \n                           onmouseout="this.style.transform='scale(1)'">\n                        \n                        <img src="${a}" alt="${e}" id="edit-photo-preview" \n                             style="width:120px; height:120px; border-radius:12px; object-fit:cover; border:2px solid #7796cb; background-color:#2a2d3e; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);" />\n                        \n                        <div style="position:absolute; bottom:-10px; right:-10px; background:#7796cb; color:white; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border:2px solid #1a1d2d; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">\n                            <i data-lucide="camera" style="width:16px; height:16px;"></i>\n                        </div>\n                    </label>\n                    <input type="file" id="edit-photo-input" accept="image/*" style="display:none" />\n                </div>\n\n                \x3c!-- Right Column: Fields --\x3e\n                <div class="edit-fields-container" style="display: flex; flex-direction: column; gap: 15px;">\n                    <div class="swal2-input-group" style="margin:0;">\n                        <label style="display:block; text-align:left; margin-bottom:6px; font-weight:500; font-size: 0.9em; color: #a1a1aa;">Nombre Completo</label>\n                        <input type="text" id="edit-nombre" class="swal2-input" value="${t.nombre||""}" placeholder="Nombre" style="margin:0; width:100%; font-size: 1rem; padding: 10px; background: #27272a; border: 1px solid #3f3f46; color: white;" />\n                    </div>\n                    \n                    <div class="swal2-input-group" style="margin:0;">\n                        <label style="display:block; text-align:left; margin-bottom:6px; font-weight:500; font-size: 0.9em; color: #a1a1aa;">Cargo / Rol</label>\n                        <input type="text" id="edit-cargo" class="swal2-input" value="${t.cargo||"Operador NOC"}" placeholder="Cargo" style="margin:0; width:100%; font-size: 1rem; padding: 10px; background: #27272a; border: 1px solid #3f3f46; color: white;" />\n                    </div>\n\n                    \x3c!-- New Fields for Birthday --\x3e\n                    <div class="swal2-input-group" style="margin:0;">\n                        <label style="display:block; text-align:left; margin-bottom:6px; font-weight:500; font-size: 0.9em; color: #a1a1aa;">üéÇ Cumplea√±os (DD/MM)</label>\n                        <input type="text" id="edit-cumple" class="swal2-input" value="${t.fechaNacimiento||""}" placeholder="Ej: 15/05" style="margin:0; width:100%; font-size: 0.95rem; padding: 10px; background: #27272a; border: 1px solid #3f3f46; color: white;" />\n                    </div>\n                </div>\n            </div>\n            \n            <p style="font-size:0.8rem; color:#52525b; margin-top:1.5rem; text-align: center;">\n                Solo se necesitan estos datos para la tarjeta del directorio.\n            </p>\n        `,showCancelButton:!0,confirmButtonText:'<i class="lucide-save"></i> Guardar Cambios',cancelButtonText:"Cancelar",confirmButtonColor:"#7796cb",cancelButtonColor:"#3f3f46",width:"550px",padding:"2em",background:"#18181b",color:"#fff",didOpen:()=>{lucide.createIcons({root:Swal.getPopup()});const e=document.getElementById("edit-photo-input"),t=document.getElementById("edit-photo-preview");e&&e.addEventListener("change",e=>{const a=e.target.files[0];if(a){if(a.size>5242880)return void Swal.showValidationMessage("La imagen es muy grande (m√°x 5MB)");const e=new FileReader;e.onload=e=>{t.src=e.target.result},e.readAsDataURL(a)}})},preConfirm:()=>({nombre:document.getElementById("edit-nombre").value.trim(),cargo:document.getElementById("edit-cargo").value.trim(),fechaNacimiento:document.getElementById("edit-cumple").value.trim(),photoFile:document.getElementById("edit-photo-input").files[0]||null,photoPreviewSrc:document.getElementById("edit-photo-preview").src})}).then(async t=>{t.isConfirmed&&t.value&&await saveEmployeeData(e,t.value)})}async function saveEmployeeData(e,t){try{Swal.fire({title:"Guardando...",text:"Subiendo datos y foto...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const a=window.firebase||firebase;if(!a)throw new Error("Firebase SDK no cargado.");if(!window.db)throw new Error("No hay conexi√≥n con la base de datos (window.db undefined).");let o=t.photoPreviewSrc;if(t.photoFile)if(a.storage)try{const e=a.storage().ref(),n=t.nombre.replace(/[^a-zA-Z0-9]/g,"_"),i=t.photoFile.name.split(".").pop().toLowerCase()||"jpg",r=e.child(`empleados/${n}_${Date.now()}.${i}`);await r.put(t.photoFile),o=await r.getDownloadURL(),console.log("[DIRECTORIO] Foto subida:",o)}catch(e){console.error("[DIRECTORIO] Error subiendo foto:",e),Swal.fire("Advertencia","No se pudo subir la foto, pero se guardar√°n los datos.","warning")}else console.warn("[DIRECTORIO] storage no disponible");const n={nombre:t.nombre,cargo:t.cargo,fechaNacimiento:t.fechaNacimiento,photoURL:o,updatedAt:new Date};if(window.db){const e=window.db.collection("empleados").doc(t.nombre);await e.set(n,{merge:!0})}if(window.db){const a=window.db.collection("Config").doc("empleados_noc"),n=await a.get();if(n.exists){let i=n.data().lista||[];i=i.map(a=>a.nombre===e?{...a,nombre:t.nombre,cargo:t.cargo,fechaNacimiento:t.fechaNacimiento,photoURL:o}:a),await a.update({lista:i}),console.log("[DIRECTORIO] Lista Config actualizada")}}Swal.fire({icon:"success",title:"¬°Guardado!",text:"Datos actualizados correctamente.",timer:1500,showConfirmButton:!1}),loadEmployees()}catch(e){console.error("[DIRECTORIO] Error guardando:",e),Swal.fire({icon:"error",title:"Error",text:"No se pudo guardar: "+e.message})}}function setupSearchAndFilters(){const e=document.getElementById("search-employee"),t=document.querySelectorAll(".filter-btn"),a=document.querySelectorAll(".view-btn");e?.addEventListener("input",e=>{searchTerm=e.target.value,renderEmployees(allEmployees)}),t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("active")),e.classList.add("active"),currentFilter=e.dataset.filter,renderEmployees(allEmployees)})}),a.forEach(e=>{e.addEventListener("click",()=>{a.forEach(e=>e.classList.remove("active")),e.classList.add("active"),currentViewMode=e.dataset.view;const t=document.getElementById("employees-grid");t&&t.setAttribute("data-view",currentViewMode)})})}function initSortable(){const e=document.getElementById("employees-grid");if(!e||!window.Sortable)return;"superadmin"===localStorage.getItem("userRole")&&(sortableInstance&&sortableInstance.destroy(),sortableInstance=new Sortable(e,{animation:200,handle:".drag-handle",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onEnd:function(t){const a=e.querySelectorAll(".employee-card"),o=Array.from(a).map(e=>{const t=e.querySelector(".employee-name");return t?t.textContent:""});localStorage.setItem("directoryOrder",JSON.stringify(o)),console.log("[DIRECTORIO] Orden guardado:",o)}}))}function startOnlineStatusListener(){window.db&&!onlineUnsubscribe&&(console.log("[DIRECTORIO] Iniciando listener de presencia..."),onlineUnsubscribe=window.db.collection("activeSessions").onSnapshot(e=>{const t={};e.forEach(e=>{const a=e.data();a.email&&(t[a.email.toLowerCase()]=a.lastActivity)}),updateOnlineIndicators(t)},e=>{console.warn("[DIRECTORIO] Error escuchando presencia:",e)}))}function updateOnlineIndicators(e){const t=document.querySelectorAll(".online-indicator"),a=new Date;t.forEach(t=>{const o=t.dataset.email?.toLowerCase();if(!o)return;const n=e[o];if(n){let e;e=n.toDate?n.toDate():n.seconds?new Date(1e3*n.seconds):new Date(n);const o=(a-e)/1e3/60;o<5?(t.className="online-indicator active",t.title="En l√≠nea ahora"):o<30?(t.className="online-indicator active idle",t.title=`Ausente (${Math.floor(o)} min)`):t.className="online-indicator"}else t.className="online-indicator"})}document.addEventListener("DOMContentLoaded",()=>{console.log("[DIRECTORIO] Iniciando..."),setupSearchAndFilters();if("superadmin"===localStorage.getItem("userRole")){const e=document.getElementById("li-registros"),t=document.getElementById("li-turnos"),a=document.getElementById("li-usuarios"),o=document.getElementById("li-animaciones");e&&(e.style.display="block"),t&&(t.style.display="block"),a&&(a.style.display="block"),o&&(o.style.display="block")}waitForFirebase(()=>{console.log("[DIRECTORIO] Cargando empleados..."),loadEmployees()})});