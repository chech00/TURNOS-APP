const auth=window.auth,db=window.db;document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("userRole");if("superadmin"===e){const e=document.getElementById("li-registros"),o=document.getElementById("li-turnos"),n=document.getElementById("li-usuarios");e&&(e.style.display="block"),o&&(o.style.display="block"),n&&(n.style.display="block"),document.body.classList.add("is-admin")}else"admin"===e&&document.body.classList.add("is-admin")});let usuarioEsAdmin=!1,currentNodoName="";function verificarRolUsuario(){auth.onAuthStateChanged(e=>{e?db.collection("userRoles").doc(e.uid).get().then(e=>{if(e.exists){const o=e.data().rol;localStorage.setItem("userRole",o),usuarioEsAdmin="admin"===o||"superadmin"===o,usuarioEsAdmin?document.body.classList.add("is-admin"):document.body.classList.remove("is-admin");const n=document.getElementById("li-registros"),a=document.getElementById("li-turnos"),t=document.getElementById("li-usuarios");if("superadmin"===o){n&&(n.style.display="block"),a&&(a.style.display="block"),t&&(t.style.display="block");const e=document.getElementById("li-animaciones");e&&(e.style.display="block"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}}else usuarioEsAdmin=!1,localStorage.removeItem("userRole"),document.body.classList.remove("is-admin");cargarNodos()}).catch(e=>{console.error("Error al obtener rol:",e),usuarioEsAdmin=!1,cargarNodos()}):window.location.href="login.html"})}function configurarSidebar(){const e=document.getElementById("sidebar"),o=document.getElementById("main-content"),n=document.querySelectorAll("#menu-toggle");e&&o&&0!==n.length?(n.forEach(n=>{n.addEventListener("click",()=>{e.classList.toggle("expanded"),o.classList.toggle("expanded")})}),lucide.createIcons()):console.error("No se encontr√≥ el sidebar o main content.")}function configurarLogout(){const e=document.getElementById("logout-btn");e&&e.addEventListener("click",()=>{auth.signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>{console.error("Error al cerrar sesi√≥n:",e)})})}function cargarNodos(){const e=document.getElementById("fiber-structure");let o="";usuarioEsAdmin&&(o+='\n      <button onclick="window.KMLService.startWizard()" class="fiber-action-btn kml-btn">\n          <i data-lucide="upload-cloud" style="width:14px;"></i> IMP. KML\n      </button>\n      <button onclick="crearNodo()" class="fiber-action-btn new-node-btn">\n         <i data-lucide="plus-circle" style="width:14px;"></i> NUEVO GABINETE\n      </button>\n    '),e.innerHTML=`\n    <div class="section-header">\n      <div class="section-title-wrapper">\n        <h2>Sala de Servidores (Nodos)</h2>\n        <p>Seleccione un Gabinete para acceder a los equipos OLT.</p>\n      </div>\n      <div class="header-actions">\n          ${o}\n      </div>\n    </div>\n  `;const n=document.getElementById("kml-import-btn");n&&n.remove(),db.collection("Nodos").orderBy("name").get().then(o=>{const n=document.createElement("div");n.classList.add("rack-aisle-grid");const a=[];o.forEach(e=>{const o=e.data(),t=e.id,r=o.name,i=contarDatosNodo(t).then(e=>{const o=document.createElement("div");o.classList.add("server-rack"),o.onclick=function(){mostrarVistaPonLetras(t,r)};let a="";if(a=0===e.totalPONs?'<div class="node-status-badge empty">OFFLINE</div>':`<div class="node-status-badge populated">SYS: ONLINE<br>PON: ${e.totalPONs} | BOX: ${e.totalCajas}</div>`,o.innerHTML=`\n            ${a}\n            <div class="rack-nameplate">${r}</div>\n            <div class="rack-interior">\n                \x3c!-- Simulated Units --\x3e\n                ${generarLucesRack()}\n                ${generarLucesRack()}\n                ${generarLucesRack()}\n                <div style="height:20px;"></div> \x3c!-- Gap --\x3e\n                ${generarLucesRack()}\n                ${generarLucesRack()}\n            </div>\n            <div class="rack-door"></div>\n        `,usuarioEsAdmin){const e=document.createElement("div");e.classList.add("rack-actions"),e.innerHTML='\n            <button class="edit-rack-btn" title="Editar Nombre" style="background:none; border:none; color:#fbbf24; cursor:pointer; font-weight:bold; font-size:1.2rem; margin-right:5px;">‚úé</button>\n            <button class="delete-rack-btn" title="Desmantelar Nodo" style="background:none; border:none; color:#ef4444; cursor:pointer; font-weight:bold; font-size:1.2rem;">√ó</button>\n          ';e.querySelector(".edit-rack-btn").onclick=function(e){e.stopPropagation(),editarNodo(t,r)};e.querySelector(".delete-rack-btn").onclick=function(e){e.stopPropagation(),confirmarEliminarNodo(t,r)},o.appendChild(e)}n.appendChild(o)});a.push(i)}),Promise.all(a).then(()=>{e.appendChild(n),lucide.createIcons()})}).catch(o=>{console.error("Error al cargar nodos:",o),e.innerHTML+="<p>Error cargando la sala de servidores.</p>"})}async function contarDatosNodo(e){const o=`node_stats_v2_${e}`,n=localStorage.getItem(o);if(n)try{const{timestamp:e,data:o}=JSON.parse(n);if(Date.now()-e<3e5)return o}catch(e){localStorage.removeItem(o)}let a=0,t=0;try{const n=(await db.collection("Nodos").doc(e).collection("PONLetters").get()).docs.map(async o=>{const n=db.collection("Nodos").doc(e).collection("PONLetters").doc(o.id).collection("PONs"),a=await n.get(),t=a.size,r=a.docs.map(async e=>(await n.doc(e.id).collection("Cajas").get()).size);return{p:t,c:(await Promise.all(r)).reduce((e,o)=>e+o,0)}});(await Promise.all(n)).forEach(e=>{a+=e.p,t+=e.c}),localStorage.setItem(o,JSON.stringify({timestamp:Date.now(),data:{totalPONs:a,totalCajas:t}}))}catch(o){console.error(`Error contando datos para nodo ${e}:`,o)}return{totalPONs:a,totalCajas:t}}function generarLucesRack(){const e=['<div class="rack-light break"></div><div class="rack-light"></div><div class="rack-light"></div>','<div class="rack-light blue"></div><div class="rack-light blue"></div>','<div class="rack-light orange"></div>','<div class="rack-light red"></div><div class="rack-light"></div>','<div class="rack-light"></div><div class="rack-light blue"></div><div class="rack-light"></div><div class="rack-light"></div>'],o=e[Math.floor(Math.random()*e.length)];return`<div class="rack-activity-lights" style="justify-content:${Math.random()>.5?"flex-start":"flex-end"}">${o}</div>`}function eliminarNodo(e){usuarioEsAdmin?db.collection("Nodos").doc(e).delete().then(()=>{Swal.fire("√âxito","Nodo eliminado","success"),cargarNodos()}).catch(e=>{console.error("Error al eliminar nodo:",e)}):Swal.fire("Acceso denegado","No tienes permiso para eliminar nodos.","error")}function mostrarVistaPonLetras(e,o){currentNodoName=o;const n=document.getElementById("fiber-structure");let a=`\n    <div class="olt-management-panel">\n        <div class="olt-header-left">\n            <button class="olt-header-back-btn" onclick="cargarNodos()">\n                ‚Üê RACK ROOM\n            </button>\n            <div class="olt-info-group">\n                <span class="olt-device-label">OPTICAL LINE TERMINAL</span>\n                <span class="olt-device-name">${o}</span>\n            </div>\n        </div>\n\n        <div class="olt-lcd-display">\n            <div class="olt-status-light"></div>\n            <span>SYSTEM STATUS: ONLINE / MANAGED</span>\n        </div>\n  `;a+=usuarioEsAdmin?`\n        <div class="olt-admin-controls">\n            <span class="olt-device-label" style="font-size:0.7rem;">EXPANSION SLOT</span>\n            <select id="pon-letra-dropdown" class="olt-select-dark">\n               ${[...Array(26)].map((e,o)=>{const n=String.fromCharCode(65+o);return`<option value="${n}">CARD SLOT ${n}</option>`}).join("")}\n            </select>\n            <button class="olt-btn-install" onclick="crearPonLetra('${e}')">\n                INITIALIZE CARD\n            </button>\n        </div>\n    `:"<div></div>",a+="</div>",a+='<div id="pon-letters-list" style="width: 100%; display: flex; justify-content: center;"></div>',n.innerHTML=a,cargarPonLetters(e)}function crearPonLetra(e){if(!usuarioEsAdmin)return void Swal.fire("Acceso denegado","No tienes permiso para crear PONs.","error");const o=document.getElementById("pon-letra-dropdown").value,n=db.collection("Nodos").doc(e).collection("PONLetters");n.doc(o).get().then(a=>{a.exists?Swal.fire("Error",`La letra ${o} ya existe en este nodo.`,"error"):n.doc(o).set({name:o}).then(()=>{Swal.fire("√âxito",`PON ${o} creado correctamente`,"success"),cargarPonLetters(e)}).catch(e=>{console.error("Error al crear la letra:",e)})}).catch(e=>{console.error("Error al verificar la letra:",e)})}function cargarPonLetters(e){const o=document.getElementById("pon-letters-list");o.innerHTML='<div class="spinner"></div>',db.collection("Nodos").doc(e).collection("PONLetters").orderBy("name").get().then(n=>{let a='\n        <div class="olt-chassis">\n          <div class="olt-fan-tray">\n            \x3c!-- Real Animated Fans --\x3e\n            <div class="olt-fan-blade"></div>\n            <div class="olt-fan-blade"></div>\n            <div class="olt-fan-blade"></div>\n            <div class="olt-fan-blade"></div>\n          </div>\n          <div class="olt-shelf">\n      ';const t=[];n.forEach(e=>{t.push({id:e.id,...e.data()})});for(let o=0;o<16;o++)if(t[o]){const n=t[o].name;a+=`\n                <div class="olt-card" onclick="mostrarVistaPONPorLetra('${e}', '${n}')" title="PON Board ${n}">\n                  <div class="olt-handle"></div>\n                  <div class="olt-faceplate">\n                    <div class="olt-led-group">\n                       <div class="olt-led run"></div>\n                       <div class="olt-led"></div>\n                    </div>\n                    <div class="olt-port-grid">\n                       ${[...Array(8)].map(()=>'<div class="olt-port"></div>').join("")}\n                    </div>\n                    <div class="olt-label">BOARD ${n}</div>\n                  </div>\n                  <div class="olt-handle bottom"></div>\n                  ${usuarioEsAdmin?`<button style="position:absolute; bottom:30px; border:none; background:transparent; color:red; font-weight:bold; cursor:pointer;"\n                      onclick="confirmarEliminarPonLetra(event, '${e}', '${n}')">√ó</button>`:""}\n                </div>\n              `}else a+='\n            <div class="olt-slot-empty">\n                \x3c!-- Screws for realism --\x3e\n                <div style="position:absolute; top:5px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:#111; border-radius:50%; box-shadow:inset 0 0 2px #fff;"></div>\n                <div style="position:absolute; bottom:5px; left:50%; transform:translateX(-50%); width:6px; height:6px; background:#111; border-radius:50%; box-shadow:inset 0 0 2px #fff;"></div>\n            </div>';a+="\n          </div> \x3c!-- End shelf --\x3e\n        </div> \x3c!-- End chassis --\x3e\n      ",o.innerHTML=a}).catch(e=>{console.error("Error al cargar OLT:",e),o.innerHTML="<p>Error cargando visualizaci√≥n.</p>"})}function confirmarEliminarPonLetra(e,o,n){e.stopPropagation(),Swal.fire({title:"Desmontar M√≥dulo",text:`¬øRetirar la tarjeta PON ${n} del rack?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"S√≠, retirar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&eliminarPonLetra(o,n)})}function eliminarPonLetra(e,o){usuarioEsAdmin?db.collection("Nodos").doc(e).collection("PONLetters").doc(o).delete().then(()=>{Swal.fire("√âxito",`Letra ${o} eliminada`,"success"),cargarPonLetters(e)}).catch(e=>{console.error("Error al eliminar la letra:",e)}):Swal.fire("Acceso denegado","No tienes permiso para eliminar PONs.","error")}function mostrarVistaPONPorLetra(e,o){const n=document.getElementById("fiber-structure");let a=`\n    <div class="olt-management-panel">\n        <div class="olt-header-left">\n            <button class="olt-header-back-btn" onclick="mostrarVistaPonLetras('${e}', '${currentNodoName}')">\n                ‚Üê CARD ${o} [BACK]\n            </button>\n            <div class="olt-info-group">\n                <span class="olt-breadcrumb">NODE: ${currentNodoName} > SLOT: ${o}</span>\n                <span class="olt-device-name">SLOT ${o}</span>\n            </div>\n        </div>\n\n        <div class="olt-lcd-display">\n            <div class="olt-status-light"></div>\n            <span>MODULE STATUS: ACTIVE / SYNCED</span>\n        </div>\n  `;a+=usuarioEsAdmin?`\n        <div class="olt-admin-controls">\n            <span class="olt-device-label" style="font-size:0.7rem;">SFP PORT MGMT</span>\n            <select id="pon-numero" class="olt-select-dark">\n              ${[...Array(16)].map((e,o)=>`<option value="${o}">PORT ${o}</option>`).join("")}\n            </select>\n            <button class="olt-btn-install" onclick="crearPON('${e}', '${o}')">\n               INSERT SFP MODULE\n            </button>\n            <input type="hidden" id="pon-letra" value="${o}" />\n        </div>\n    `:"<div></div>",a+="</div>",a+='<div id="pon-list" class="olt-card-detail-container"></div>',n.innerHTML=a,cargarPONs(e,o)}function crearPON(e,o){if(!usuarioEsAdmin)return void Swal.fire("Acceso denegado","No tienes permiso para crear PONs.","error");o||(o=document.getElementById("pon-letra").value);const n=document.getElementById("pon-numero").value,a=`PON ${o}${n}`,t=db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs");t.where("name","==",a).get().then(r=>{r.empty?t.add({name:a}).then(()=>{Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3}).fire({icon:"success",title:`SFP insertado en Puerto ${n}`}),cargarPONs(e,o)}).catch(e=>{console.error("Error al crear PON:",e)}):Swal.fire({icon:"error",title:"Puerto Ocupado",text:`El puerto SFP ${n} de la tarjeta ${o} ya tiene un transceptor instalado.`,confirmButtonColor:"#333"})})}function cargarPONs(e,o){const n=document.getElementById("pon-list");n.innerHTML='<div class="spinner"></div>',db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").get().then(a=>{const t={};a.forEach(e=>{const o=e.data(),n=o.name.match(/PON\s*[A-Z]+(\d+)/i);if(n){const a=parseInt(n[1]);t[a]={id:e.id,...o}}});let r='<div class="olt-faceplate-detail">';for(let n=0;n<16;n++){const a=t[n];r+=a?`\n                <div class="sfp-cage active" onclick="mostrarVistaPON('${e}', '${o}', '${a.id}', '${a.name}')" title="${a.name} - Conectado">\n                    <div class="sfp-cage-label">${o}${n}</div>\n                    ${usuarioEsAdmin?`<button class="sfp-delete-btn" onclick="confirmarEliminarPON(event, '${e}', '${o}', '${a.id}')">√ó</button>`:""}\n                    <div class="sfp-module inserted">\n                         \x3c!-- Visual Text on Module --\x3e\n                         <div style="font-size:5px; color:#333; position:absolute; top:2px; left:2px; font-family:sans-serif;">10G</div>\n                         \x3c!-- Laser Glow --\x3e\n                         <div class="sfp-glow-laser" style="position:absolute; top:40%; right:-2px; width:4px; height:4px; background:#0f0; border-radius:50%; box-shadow:0 0 5px #0f0; opacity:0.8; animation:blink-random 0.1s infinite;"></div>\n                    </div>\n                    \x3c!-- Fiber Cable --\x3e\n                    <div class="sfp-fiber"></div>\n                </div>\n            `:`\n                <div class="sfp-cage empty" title="Puerto ${n} Vac√≠o">\n                    <div class="sfp-cage-label">${o}${n}</div>\n                </div>\n            `}r+="</div>",r+='\n        <div style="margin-top:20px; display:flex; gap:20px; color:#888; font-size:0.8rem;">\n            <div style="display:flex; align-items:center; gap:5px;"><div style="width:10px; height:10px; background:#00a8ff; border-radius:2px;"></div> SFP Activo</div>\n            <div style="display:flex; align-items:center; gap:5px;"><div style="width:10px; height:10px; background:#111; border:1px solid #666; border-radius:2px;"></div> Puerto Libre</div>\n        </div>\n      ',n.innerHTML=r}).catch(e=>{console.error("Error al cargar PONs:",e),n.innerHTML="<p>Error cargando panel frontal.</p>"})}function confirmarEliminarPON(e,o,n,a){e.stopPropagation(),Swal.fire({title:"Desconectar Fibra",text:"¬øRetirar el m√≥dulo SFP y eliminar este PON?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"S√≠, desconectar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&eliminarPON(o,n,a)})}function eliminarPON(e,o,n){usuarioEsAdmin?db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).delete().then(()=>{Swal.fire("√âxito","PON eliminado","success"),cargarPONs(e,o)}).catch(e=>{console.error("Error al eliminar PON:",e)}):Swal.fire("Acceso denegado","No tienes permiso para eliminar PONs.","error")}function mostrarVistaPON(e,o,n,a){const t=document.getElementById("fiber-structure");let r=`\n    <div class="olt-management-panel">\n        <div class="olt-header-left">\n            <button class="olt-header-back-btn" onclick="mostrarVistaPONPorLetra('${e}', '${o}')">\n                ‚Üê SFP FACEPLATE [BACK]\n            </button>\n            <div class="olt-info-group">\n                <span class="olt-breadcrumb">NODE: ${currentNodoName||"N/A"} > SLOT: ${o} > PON: ${a}</span>\n                <span class="olt-device-name">${a}</span>\n            </div>\n        </div>\n\n        <div class="olt-lcd-display">\n            <div class="olt-status-light"></div>\n            <span>NETWORK STATUS: ACTIVE / LIVE</span>\n        </div>\n  `;r+=usuarioEsAdmin?`\n        <div class="olt-admin-controls">\n            <span class="olt-device-label" style="font-size:0.7rem;">SPLICE BOX MGMT</span>\n            <select id="caja-numero" class="olt-select-dark">\n               ${[...Array(51)].map((e,o)=>`<option value="${o}">BOX ID ${o}</option>`).join("")}\n            </select>\n            <select id="caja-capacidad" class="olt-select-dark" style="margin-left:5px;">\n              <option value="8">8 PORTS</option>\n              <option value="12" selected>12 PORTS</option>\n              <option value="16">16 PORTS</option>\n              <option value="24">24 PORTS</option>\n            </select>\n            <button class="olt-btn-install" onclick="crearCaja('${e}', '${o}', '${n}')">\n                DEPLOY SPLICE BOX\n            </button>\n        </div>\n    `:"<div></div>",r+="</div>",r+='<div id="caja-list" class="topology-container"></div>',t.innerHTML=r,cargarCajas(e,o,n)}function crearCaja(e,o,n){if(!usuarioEsAdmin)return void Swal.fire("Acceso denegado","No tienes permiso para crear Cajas.","error");const a=document.getElementById("caja-numero").value,t=parseInt(document.getElementById("caja-capacidad").value)||12,r=`Caja ${a}`,i=db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas");i.where("name","==",r).get().then(a=>{a.empty?i.add({name:r,capacity:t}).then(()=>{Swal.fire("√âxito",`Caja ${r} creada correctamente`,"success"),cargarCajas(e,o,n)}).catch(e=>{console.error("Error al crear Caja:",e)}):Swal.fire("Error",`La ${r} ya existe en este PON.`,"error")})}function cargarCajas(e,o,n){const a=document.getElementById("caja-list");a.innerHTML='<div class="spinner"></div>',db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").get().then(t=>{let r=[];t.forEach(e=>{const o=e.data();r.push({docId:e.id,name:o.name,capacity:o.capacity||12,numeric:extraerNumeroDeNombre(o.name)})}),r.sort((e,o)=>e.numeric!==o.numeric?e.numeric-o.numeric:e.name.localeCompare(o.name,void 0,{numeric:!0}));let i='<div class="trunk-line"></div>';0===r.length?i+='<div style="z-index:1; background:#222; padding:10px; border-radius:8px; color:#888;">No hay cajas en el troncal.</div>':r.forEach((a,t)=>{const r=t%2==0?"left":"right",c=(8*Math.random()-15).toFixed(1),s=(950+50*Math.random()).toFixed(0),l=(25+15*Math.random()).toFixed(1),d=Math.floor(365*Math.random()),u=c>-10?"#00ff88":c>-12?"#ffaa00":"#ff4444";i+=`\n            <div class="branch ${r}">\n              <div class="branch-cable"></div>\n              <div class="branch-content">\n                <div class="splice-box health-${c>-10?"optimal":c>-12?"warning":"critical"}" \n                     onclick="mostrarVistaCaja('${e}', '${o}', '${n}', '${a.docId}', '${a.name}', ${a.capacity})"\n                     data-signal="${c}"\n                     data-rate="${s}"\n                     data-temp="${l}"\n                     data-uptime="${d}"\n                     title="üì° Se√±al: ${c} dBm | ‚ö° Tasa: ${s} Mbps | üå°Ô∏è Temp: ${l}¬∞C | ‚è±Ô∏è Uptime: ${d} d√≠as"\n                     style="--health-color: ${u};">\n                  <div class="splice-box-header">\n                    <span>${a.name}</span>\n                    <span style="font-size:0.7em; opacity:0.7;">${a.capacity} FO</span>\n                  </div>\n                  <div class="splice-box-info">\n                    Manga de Empalme\n                  </div>\n                  <div class="capacity-bar">\n                    <div class="capacity-fill" style="width: 0%"></div>\n                  </div>\n                  ${usuarioEsAdmin?`<span class="delete-icon" onclick="confirmarEliminarCaja(event, '${e}', '${o}', '${n}', '${a.docId}')">üóë</span>`:""}\n                </div>\n              </div>\n            </div>\n          `}),a.innerHTML=i}).catch(e=>{console.error("Error al cargar Topolog√≠a:",e),a.innerHTML="<p>Error cargando la red.</p>"})}function confirmarEliminarCaja(e,o,n,a,t){e.stopPropagation(),Swal.fire({title:"Desinstalar Caja",text:"¬øCortar y retirar esta caja de empalme?",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",confirmButtonText:"S√≠, retirar",cancelButtonText:"Cancelar"}).then(e=>{e.isConfirmed&&eliminarCaja(o,n,a,t)})}function eliminarCaja(e,o,n,a){usuarioEsAdmin?db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").doc(a).delete().then(()=>{Swal.fire("√âxito","Caja eliminada","success"),cargarCajas(e,o,n)}).catch(e=>{console.error("Error al eliminar Caja:",e)}):Swal.fire("Acceso denegado","No tienes permiso para eliminar Cajas.","error")}function mostrarVistaCaja(e,o,n,a,t,r=12){const i=document.getElementById("fiber-structure");let c=`\n    <div class="olt-management-panel">\n        <div class="olt-header-left">\n            <button class="olt-header-back-btn" onclick="mostrarVistaPON('${e}', '${o}', '${n}', '')">\n                ‚Üê NETWORK [BACK]\n            </button>\n            <div class="olt-info-group">\n                <span class="olt-breadcrumb">NODE: ${currentNodoName||"N/A"} > ... > PON: ${n} > BOX: ${t}</span>\n                <span class="olt-device-name">${t}</span>\n            </div>\n        </div>\n\n        <div class="olt-lcd-display">\n            <div class="olt-status-light"></div>\n            <span>TRAY STATUS: ${r} PORTS AVAIL</span>\n        </div>\n        \n        <div class="olt-admin-controls">\n             <span class="olt-device-label" style="font-size:0.7rem;">ACTION</span>\n             <button class="olt-btn-install" style="background:#444; border-color:#666; cursor:default">\n                VIEW ONLY\n             </button>\n        </div>\n    </div>\n\n    \x3c!-- TRAY CONTAINER --\x3e\n    <div class="fiber-tray-container" style="border-top:none; margin-top:0;">\n      \x3c!-- GRID DE PUERTOS (Din√°mico) --\x3e\n      <div id="fiber-grid" class="fiber-grid"></div>\n    </div>\n  `;i.innerHTML=c,cargarFilamentosGrid(e,o,n,a,r)}function cargarFilamentosGrid(e,o,n,a,t){const r=document.getElementById("fiber-grid");r.innerHTML='<div class="spinner"></div>';db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").doc(a).collection("Filamentos").get().then(i=>{r.innerHTML="";const c={};i.forEach(e=>{const o=e.data(),n=extraerNumeroDeNombre(o.name);n&&(c[n]={id:e.id,name:o.name,signal:o.signal})});const s=parseInt(t)||12;for(let t=1;t<=s;t++){const i=document.createElement("div"),l=c[t];let d="fiber-port",u=`<span class="port-number">${t}</span>`;const m=getTiaColorClass(t);l?(d+=` occupied ${m}`,u+=`<span class="port-signal">${l.signal||"N/A"}</span>`,i.onclick=()=>{editarFilamento(e,o,n,a,l.id,l.name,l.signal,s)}):(u+='<span style="font-size:0.7em; opacity:0.5;">Vac√≠o</span>',i.onclick=()=>{crearFilamentoModal(e,o,n,a,t)}),i.className=d,i.innerHTML=u,r.appendChild(i)}}).catch(e=>{console.error("Error cargando grid:",e),r.innerHTML="<p>Error cargando datos.</p>"})}function getTiaColorClass(e){switch((e-1)%12+1){case 1:return"tia-blue";case 2:return"tia-orange";case 3:return"tia-green";case 4:return"tia-brown";case 5:return"tia-slate";case 6:return"tia-white";case 7:return"tia-red";case 8:return"tia-black";case 9:return"tia-yellow";case 10:return"tia-violet";case 11:return"tia-rose";case 12:return"tia-aqua";default:return""}}async function crearFilamentoModal(e,o,n,a,t){if(!usuarioEsAdmin)return Swal.fire("Error","No tienes permisos","error");const{value:r}=await Swal.fire({title:`Conectar Filamento ${t}`,input:"text",inputLabel:"Se√±al Estimada (dBm)",inputValue:"-14dBm",showCancelButton:!0,confirmButtonText:"Empalmar",inputValidator:e=>{if(!e)return"Debes escribir la se√±al!"}});r&&crearFilamentoDirecto(e,o,n,a,t,r)}function crearFilamentoDirecto(e,o,n,a,t,r){const i=`Filamento ${t}`;db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").doc(a).collection("Filamentos").add({name:i,signal:r}).then(()=>{Swal.fire({icon:"success",title:"Empalme Exitoso",text:`Filamento ${t} color ${getNombreColor((t-1)%12+1)} conectado.`,timer:1500,showConfirmButton:!1}),cargarFilamentosGrid(e,o,n,a)})}async function editarFilamento(e,o,n,a,t,r,i,c){if(!usuarioEsAdmin)return;const s=await Swal.fire({title:r,text:`Se√±al actual: ${i||"Sin se√±al"}`,showDenyButton:!0,showCancelButton:!0,confirmButtonText:"Actualizar Se√±al",denyButtonText:"Desconectar (Borrar)",confirmButtonColor:"#3085d6",denyButtonColor:"#d33"});if(s.isConfirmed){const{value:r}=await Swal.fire({input:"text",inputLabel:"Nueva Se√±al",inputValue:i||""});null!=r&&db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").doc(a).collection("Filamentos").doc(t).update({signal:r}).then(()=>{Swal.fire("Actualizado","Potencia actualizada correctamente","success"),cargarFilamentosGrid(e,o,n,a,c)}).catch(e=>{console.error("Error actualizando se√±al:",e),Swal.fire("Error","No se pudo actualizar la se√±al.","error")})}else s.isDenied&&db.collection("Nodos").doc(e).collection("PONLetters").doc(o).collection("PONs").doc(n).collection("Cajas").doc(a).collection("Filamentos").doc(t).delete().then(()=>{Swal.fire("Desconectado","Filamento eliminado.","success"),cargarFilamentosGrid(e,o,n,a,c)}).catch(e=>{console.error("Error eliminando filamento:",e),Swal.fire("Error","No se pudo eliminar el filamento.","error")})}function getNombreColor(e){return["Azul","Naranja","Verde","Marr√≥n","Gris","Blanco","Rojo","Negro","Amarillo","Violeta","Rosa","Aqua"][e-1]||"Desconocido"}function crearNodo(){Swal.fire({title:"Nuevo Gabinete",input:"text",inputLabel:"Nombre del Nodo / Ubicaci√≥n",inputPlaceholder:"Ej: Sala Servidores Piso 1",showCancelButton:!0,confirmButtonText:"Crear",confirmButtonColor:"#10b981",background:"#1f2937",color:"#fff",customClass:{input:"swal-input-dark"}}).then(e=>{e.isConfirmed&&e.value&&db.collection("Nodos").add({name:e.value,createdAt:firebase.firestore.FieldValue.serverTimestamp()}).then(()=>{Swal.fire({title:"Creado",text:"Gabinete registrado correctamente",icon:"success",timer:1500,showConfirmButton:!1,background:"#1f2937",color:"#fff"}),cargarNodos()}).catch(e=>{console.error(e),Swal.fire({title:"Error",text:"No se pudo crear: "+e.message,icon:"error",background:"#1f2937",color:"#fff"})})})}function editarNodo(e,o){Swal.fire({title:"Editar Nombre",input:"text",inputValue:o,showCancelButton:!0,confirmButtonText:"Guardar",confirmButtonColor:"#fbbf24",background:"#1f2937",color:"#fff"}).then(o=>{o.isConfirmed&&o.value&&db.collection("Nodos").doc(e).update({name:o.value}).then(()=>{Swal.fire({title:"Actualizado",icon:"success",timer:1e3,showConfirmButton:!1,background:"#1f2937",color:"#fff"}),cargarNodos()}).catch(e=>Swal.fire({title:"Error",text:e.message,icon:"error",background:"#1f2937",color:"#fff"}))})}function confirmarEliminarNodo(e,o){Swal.fire({title:"Desmantelar Gabinete",text:`¬øEst√°s seguro de eliminar el nodo ${o}? Esta acci√≥n es irreversible.`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#ef4444",cancelButtonColor:"#374151",confirmButtonText:"S√≠, desmantelar",background:"#1f2937",color:"#fff"}).then(o=>{o.isConfirmed&&eliminarNodo(e)})}function extraerNumeroDeNombre(e){const o=e.match(/(\d+)/);return o?parseInt(o[1],10):0}window.verificarRolUsuario=verificarRolUsuario,window.configurarSidebar=configurarSidebar,window.configurarLogout=configurarLogout,window.cargarNodos=cargarNodos,window.mostrarVistaPonLetras=mostrarVistaPonLetras,window.crearPonLetra=crearPonLetra,window.mostrarVistaPONPorLetra=mostrarVistaPONPorLetra,window.crearPON=crearPON,window.cargarPONs=cargarPONs,window.mostrarVistaPON=mostrarVistaPON,window.crearCaja=crearCaja,window.confirmarEliminarCaja=confirmarEliminarCaja,window.eliminarCaja=eliminarCaja,window.mostrarVistaCaja=mostrarVistaCaja,window.crearFilamento=null,window.cargarFilamentos=null,window.crearNodo=crearNodo,window.editarNodo=editarNodo,window.confirmarEliminarNodo=confirmarEliminarNodo,document.addEventListener("DOMContentLoaded",function(){configurarSidebar(),window.KMLService&&(console.log("Injecting KML Button..."),window.KMLService.injectButton());const e=localStorage.getItem("userRole");if(e&&(console.log("Aplicando rol desde cach√© (Se√±ales):",e),("admin"===e||"superadmin"===e)&&(usuarioEsAdmin=!0,document.body.classList.add("is-admin"),"superadmin"===e))){const e=document.getElementById("li-registros"),o=document.getElementById("li-turnos");e&&(e.style.display="block"),o&&(o.style.display="block")}verificarRolUsuario(),configurarLogout()});