const auth=window.auth,db=window.db;document.addEventListener("DOMContentLoaded",()=>{console.log("documentos.js cargado (Full Width Layout) - v5.2");const e=document.getElementById("sidebar"),o=document.getElementById("main-content"),t=document.getElementById("menu-toggle");t&&t.addEventListener("click",()=>{e.classList.toggle("expanded"),o.classList.toggle("expanded")});const n=document.getElementById("logout-btn");n&&n.addEventListener("click",()=>{firebase.auth().signOut().then(()=>{localStorage.removeItem("userRole"),window.location.href="login.html"}).catch(e=>{console.error("Error al cerrar sesión:",e)})}),window.lucide&&lucide.createIcons();const i="https://turnos-app-8viu.onrender.com";let r="";const a=localStorage.getItem("userRole");a&&(console.log("Aplicando rol desde caché (Documentos):",a),r=a,"admin"!==r&&"superadmin"!==r||document.body.classList.add("is-admin"),d()),firebase.auth().onAuthStateChanged(async e=>{if(e)try{const o=await firebase.firestore().collection("userRoles").doc(e.uid).get();if(o.exists){const e=o.data().rol;e!==r?(console.log("Rol actualizado desde Firestore:",e),r=e,localStorage.setItem("userRole",e),"admin"===r||"superadmin"===r?document.body.classList.add("is-admin"):document.body.classList.remove("is-admin"),d()):(console.log("Rol confirmado (sin cambios), recargando archivos..."),f())}else localStorage.removeItem("userRole")}catch(e){console.error("Error al verificar el rol del usuario:",e)}else window.location.href="login.html"});const l=document.getElementById("open-upload-modal-btn"),s=document.getElementById("upload-modal"),c=document.getElementById("close-upload-modal");function d(){const e=document.querySelector(".documentos-container"),o=document.getElementById("li-registros"),t=document.getElementById("li-turnos"),n=document.getElementById("open-upload-modal-btn");if("admin"===r||"superadmin"===r?n&&(n.style.display="flex"):n&&(n.style.display="none"),"superadmin"===r){o&&(o.style.display="block"),t&&(t.style.display="block");const e=document.getElementById("li-usuarios");e&&(e.style.display="block");const n=document.getElementById("li-animaciones");n&&(n.style.display="block"),"function"==typeof refreshIcons?refreshIcons():"undefined"!=typeof lucide&&lucide.createIcons()}e&&e.classList.remove("hidden"),f()}l&&l.addEventListener("click",()=>{s.style.display="flex"}),c&&c.addEventListener("click",()=>{s.style.display="none"}),window.addEventListener("click",e=>{e.target===s&&(s.style.display="none");const o=document.getElementById("preview-modal");e.target===o&&(o.style.display="none")});const u=document.getElementById("upload-dropzone"),m=document.getElementById("file-input"),p=document.getElementById("upload-btn");async function f(){console.log("Iniciando loadFiles...");const e=document.getElementById("files-grid");if(!e)return void console.error("No se encontró el elemento #files-grid");e.innerHTML=Array(4).fill('<div class="file-card skeleton"></div>').join("");const o=new AbortController,t=setTimeout(()=>o.abort(),6e4);try{const n=firebase.auth().currentUser;if(!n)return void console.log("Auth no listo aún, esperando onAuthStateChanged...");console.log("Realizando fetch a:",`${i}/files`);const a=await n.getIdToken(),l=a?{Authorization:`Bearer ${a}`}:{},s=await fetch(`${i}/files?t=${Date.now()}`,{headers:l,signal:o.signal});if(clearTimeout(t),!s.ok){if(401===s.status){if("Session expired by inactivity"===(await s.json()).error)return console.warn("Sesión expirada. Redirigiendo al login..."),alert("Tu sesión ha expirado por inactividad. Por favor ingresa nuevamente."),void(window.location.href="login.html")}throw new Error(`HTTP error! status: ${s.status}`)}const c=await s.json();let d=[];if(Array.isArray(c)?d=c:c.files&&Array.isArray(c.files)&&(d=c.files),e.innerHTML="",!d||0===d.length)return e.innerHTML='\n                    <div class="empty-state">\n                        <i data-lucide="folder-open"></i>\n                        <h3>No hay documentos</h3>\n                        <p>No se encontraron archivos en el sistema.</p>\n                    </div>\n                ',void(window.lucide&&lucide.createIcons());e.innerHTML=d.map((e,o)=>{const t=/\.(png|jpg|jpeg|gif)$/i.test(e.url),n=/\.pdf$/i.test(e.url),i=Math.min(60*o,800);let a="";if(t)a=`<img src="${e.url}" alt="${e.name}" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<i data-lucide=\\'image-off\\'></i>'; lucide.createIcons();">`;else if(n)a=`\n                        <iframe \n                            src="${e.url}#view=FitH&toolbar=0&navpanes=0&scrollbar=0" \n                            loading="lazy" \n                            style="width: 100%; height: 100%; border: none; pointer-events: none;"\n                            scrolling="no"\n                        ></iframe>`;else{const o=(l=e.url,/\.(doc|docx)$/i.test(l)?"file-type-2":/\.(xls|xlsx)$/i.test(l)?"sheet":/\.(ppt|pptx)$/i.test(l)?"presentation":"file");a=`<i data-lucide="${o}" style="color: ${"sheet"===o?"#10b981":"file-type-2"===o?"#3b82f6":"var(--color-texto-secundario)"}; transform: scale(1.5);"></i>`}var l;let s="";return"admin"!==r&&"superadmin"!==r||(s=`\n                        <button onclick="deleteFile('${e.name}')" class="delete-btn" title="Eliminar">\n                            <i data-lucide="trash-2"></i>\n                        </button>\n                    `),`\n                    <div class="file-card animate-entry" style="animation-delay: ${i}ms">\n                        <div class="file-thumbnail">\n                            ${a}\n                        </div>\n                        <div class="file-details">\n                            <h3 class="file-name" title="${e.name}">${e.name}</h3>\n                            <div class="file-actions">\n                                <button onclick="previewFile('${e.url}')" class="view-btn" title="Ver">\n                                    <i data-lucide="eye"></i>\n                                </button>\n                                <a href="${e.url}" download="${e.name}" class="download-btn" title="Descargar" target="_blank">\n                                    <i data-lucide="download"></i>\n                                </a>\n                                ${s}\n                            </div>\n                        </div>\n                    </div>\n                `}).join(""),window.lucide&&lucide.createIcons()}catch(o){console.error("Error al cargar archivos:",o);let t="Hubo un problema al conectar con el servidor.",n="Error al cargar archivos";"AbortError"===o.name?(n="Servidor Iniciando...",t="El servidor está despertando (Cold Start). Por favor, espera unos segundos y reintenta."):"Failed to fetch"===o.message?(n="Error de Conexión / CORS",t="No se pudo conectar con el servidor.<br><br><b>Si estás en Localhost:</b> Es probable que el servidor (Render) esté bloqueando la conexión por seguridad (CORS).<br><b>Si estás en Producción:</b> Verifica tu conexión a internet o el estado del servidor."):o.message&&(t=o.message),e.innerHTML=`\n                <div class="empty-state" style="color: var(--color-error);">\n                    <i data-lucide="server-off"></i>\n                    <h3>${n}</h3>\n                    <p>${t}</p>\n                    <button onclick="location.reload()" class="primary-btn" style="margin-top: 1rem;">Reintentar</button>\n                    <small style="display:block; margin-top:10px; opacity:0.7;">(Render Free Tier puede tardar hasta 60s en despertar)</small>\n                </div>\n            `,window.lucide&&lucide.createIcons()}}u&&u.addEventListener("click",()=>{m.click()}),p&&p.addEventListener("click",async function(){if("admin"!==r&&"superadmin"!==r)return void Swal.fire({icon:"error",title:"Acceso Denegado",text:"No tienes permisos para subir archivos.",confirmButtonColor:"#e74c3c"});if(!m.files.length)return void Swal.fire({icon:"warning",title:"Selecciona un Archivo",text:"Por favor, selecciona un archivo.",confirmButtonColor:"#f39c12"});const e=m.files[0],o=new FormData;o.append("file",e);try{Swal.fire({title:"Subiendo Archivo...",text:"Por favor espera...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const e=await firebase.auth().currentUser.getIdToken(),t=await fetch(`${i}/upload`,{method:"POST",headers:{Authorization:`Bearer ${e}`},body:o}),n=await t.json();if(!n.success)throw new Error(n.error||"Error al subir archivo.");Swal.fire({icon:"success",title:"Archivo Subido",text:"El archivo se ha subido correctamente.",confirmButtonColor:"#2ecc71"}),m.value="",f(),s&&(s.style.display="none")}catch(e){console.error("Error al subir archivo:",e),Swal.fire({icon:"error",title:"Error",text:"Hubo un problema al subir el archivo.",confirmButtonColor:"#e74c3c"})}}),window.deleteFile=async function(e){if("admin"!==r&&"superadmin"!==r)return void Swal.fire({icon:"error",title:"Acceso Denegado",text:"No tienes permisos."});if((await Swal.fire({title:"¿Estás seguro?",text:"No podrás revertir esto",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, eliminar",cancelButtonText:"Cancelar"})).isConfirmed)try{const o=await firebase.auth().currentUser.getIdToken(),t=await fetch(`${i}/delete/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${o}`}}),n=await t.json();if(!n.success)throw new Error(n.error||"Error al eliminar.");Swal.fire("Eliminado!","El archivo ha sido eliminado.","success"),f()}catch(e){console.error("Error al eliminar:",e),Swal.fire("Error","No se pudo eliminar el archivo.","error")}},window.previewFile=e=>{const o=document.getElementById("preview-modal"),t=document.getElementById("modal-preview-content");t.classList.remove("modal-zoom-in"),t.offsetWidth,t.classList.add("modal-zoom-in"),t.innerHTML='<span class="close-button" id="modal-close-preview">&times;</span>';const n=document.getElementById("modal-close-preview");if(n.onclick=()=>{o.style.display="none"},n.style.cssText="position: absolute; top: -40px; right: 0; color: #fff; font-size: 2rem; cursor: pointer; z-index: 2002;",/\.(png|jpg|jpeg|gif)$/i.test(e)){const o=document.createElement("img");o.src=e,t.appendChild(o)}else if(/\.pdf$/i.test(e)){const o=document.createElement("iframe");o.src=e,o.style.width="100%",o.style.height="100%",o.style.border="none",t.appendChild(o)}else{const o=document.createElement("iframe");o.src=`https://docs.google.com/gview?url=${encodeURIComponent(e)}&embedded=true`,o.style.width="100%",o.style.height="100%",o.style.border="none",t.appendChild(o)}o.style.display="flex"}});