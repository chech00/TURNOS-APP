<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Logger: Suprime console.log en producción -->
    <script src="./js/logger.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Directorio de Empleados - NOC</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="Sistema de gestión de turnos del NOC de PatagoniaIP." />
    <meta name="author" content="PatagoniaIP" />
    <meta name="theme-color" content="#1a1d2d" />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="icon" type="image/svg+xml" href="./img/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="stylesheet" href="./css/enhancements.css" />
    <link rel="stylesheet" href="./css/styles.css?v=8" />
    <link rel="stylesheet" href="./css/user-profile-header.css" />
    <link rel="stylesheet" href="./css/directorio.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="./js/lucide-instant.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script defer src="./js/auto-logout.js"></script>
    <!-- Security: XSS Protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="./js/security-helpers.js"></script>
    <!-- Optimistic Profile Header Loading -->
    <script src="./js/user-profile-header.js"></script>
    <script defer src="./js/christmas.js"></script>
    <!-- Performance Helpers (debounced icons, DOM utils) -->
    <script src="./js/performance-helpers.js"></script>
</head>

<body>
    <!-- Loader de página completa -->
    <div id="page-loader" class="page-loader">
        <div class="spinner"></div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <button id="menu-toggle" class="menu-btn"><i data-lucide="menu"></i></button>
        <div class="sidebar-header">
            <img src="https://i.ibb.co/HqrX2cr/LOGO-COLOR-2-SLOGAN-768x185.png" alt="Logo" class="logo-sidebar" />
        </div>
        <nav class="sidebar-menu">
            <ul>

                <li data-tooltip="Directorio"><a href="directorio.html" id="menu-directorio" class="active"><i
                            data-lucide="users"></i>
                        <span>Directorio</span></a></li>
                <li id="li-turnos" class="superadmin-only" style="display:none;" style="display:none;"
                    data-tooltip="Turnos"><a href="index.html" id="menu-turnos"><i data-lucide="calendar"></i>
                        <span>Turnos</span></a></li>
                <li id="li-senales" class="admin-only" data-tooltip="Señal de Fibra"><a href="senales.html"
                        id="menu-fibra"><i data-lucide="waypoints"></i>
                        <span>Señal de
                            Fibra</span></a></li>
                <li data-tooltip="Documentos Noc"><a href="documentos.html" id="menu-doc"><i data-lucide="dock"></i>
                        <span>Documentos Noc</span></a>
                </li>
                <li data-tooltip="Turnos Noc"><a href="noc.html" id="calendar-check"><i
                            data-lucide="calendar-check"></i> <span>Turnos
                            Noc</span></a></li>
                <li class="admin-only" data-tooltip="Bitácora Uptime"><a
                        href="uptime.html"><i data-lucide="activity"></i><span>Bitácora
                            Uptime</span></a></li>
                <li data-tooltip="Notificaciones"><a href="suralis.html"><i
                            data-lucide="send"></i><span>Notificaciones</span></a></li>
                <li id="li-empleados" class="admin-only" data-tooltip="Gestionar Empleados">
                    <a href="gestion_empleados.html">
                        <i data-lucide="user-cog"></i>
                        <span>Gestionar Empleados</span>
                    </a>
                </li>
                <li id="li-usuarios" class="superadmin-only" style="display:none;" data-tooltip="Cuentas de Sistema">
                    <a href="gestion_usuarios.html">
                        <i data-lucide="shield-check"></i>
                        <span>Cuentas de Sistema</span>
                    </a>
                </li>
                <li id="li-animaciones" class="superadmin-only" style="display:none;" data-tooltip="Animaciones">
                    <a href="animaciones.html">
                        <i data-lucide="sparkles"></i>
                        <span>Animaciones</span>
                    </a>
                </li>
                <li id="li-registros" style="display:none;" data-tooltip="Registros">
                    <a href="registros.html">
                        <i data-lucide="file-text"></i>
                        <span>Registros</span>
                    </a>
                </li>
            </ul>
        </nav>
        <button id="logout-btn" class="primary-btn logout-btn">
            <i data-lucide="log-out"></i> <span>Cerrar sesión</span>
        </button>
    </div>

    <!-- Contenido Principal -->
    <div id="main-content" class="main-content" style="display: none;">
        <header>
            <!-- Logger: Suprime console.log en producción -->
            <script src="./js/logger.js"></script>
            <h1>Directorio Telefónico</h1>
            <!-- Premium User Profile Header -->
            <div class="user-profile-header">
                <div class="user-avatar">
                    <i data-lucide="user"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="user-display-name">Usuario</span>
                    <span class="user-email" id="user-display-email">email@example.com</span>
                </div>
                <div class="user-role-badge" id="user-role-badge">
                    <i data-lucide="shield"></i>
                    <span id="user-role-text">Usuario</span>
                </div>
            </div>
        </header>

        <main>
            <!-- Stats Cards -->
            <section class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i data-lucide="users"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="stat-total">0</span>
                        <span class="stat-label">Total Empleados</span>
                    </div>
                </div>
                <div class="stat-card working">
                    <div class="stat-icon">
                        <i data-lucide="briefcase"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="stat-working">0</span>
                        <span class="stat-label">De Turno Hoy</span>
                    </div>
                </div>
                <div class="stat-card free">
                    <div class="stat-icon">
                        <i data-lucide="coffee"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="stat-free">0</span>
                        <span class="stat-label">Libres</span>
                    </div>
                </div>
                <div class="stat-card vacation">
                    <div class="stat-icon">
                        <i data-lucide="palm-tree"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" id="stat-vacation">0</span>
                        <span class="stat-label">Vacaciones</span>
                    </div>
                </div>
            </section>

            <!-- Search and Filters -->
            <section class="search-filter-container">
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="search-employee" placeholder="Buscar empleado..." />
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Todos</button>
                    <button class="filter-btn" data-filter="working">De Turno</button>
                    <button class="filter-btn" data-filter="free">Libres</button>
                    <button class="filter-btn" data-filter="vacation">Vacaciones</button>
                </div>
                <!-- View Mode Toggle -->
                <div class="view-mode-toggle">
                    <button class="view-btn active" data-view="grid" title="Vista Tarjetas">
                        <i data-lucide="layout-grid"></i>
                    </button>
                    <button class="view-btn" data-view="compact" title="Vista Compacta">
                        <i data-lucide="list"></i>
                    </button>
                </div>
            </section>

            <!-- Employee Cards Grid (Sortable) -->
            <section class="employees-grid" id="employees-grid" data-view="grid">
                <!-- Cards will be loaded dynamically -->
                <div class="loading-placeholder">
                    <div class="spinner"></div>
                    <p>Cargando equipo...</p>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 PatagoniaIP SpA - Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- Cargar Firebase desde CDN -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Sortable.js for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Firebase init -->
    <script type="module" src="./js/firebase.js"></script>

    <!-- Active Session Tracker -->
    <script defer src="./js/active-session.js"></script>

    <!-- Directorio functionality -->
    <script defer src="./js/directorio.js"></script>

    <script type="module">
        import { auth, db } from './js/firebase.js';

        function loadCachedProfile() {
            const cached = localStorage.getItem('userProfileCache');
            if (!cached) return;
            try {
                const data = JSON.parse(cached);
                const nameEl = document.getElementById('user-display-name');
                const emailEl = document.getElementById('user-display-email');
                const roleBadge = document.getElementById('user-role-badge');
                const roleText = document.getElementById('user-role-text');
                if (nameEl) nameEl.textContent = data.displayName;
                if (emailEl) emailEl.textContent = data.email;
                if (roleText) roleText.textContent = data.role === 'superadmin' ? 'Super Admin' : data.role === 'admin' ? 'Admin' : 'Usuario';
                if (roleBadge) roleBadge.className = `user-role-badge ${data.role === 'superadmin' ? 'superadmin' : data.role === 'admin' ? 'admin' : ''}`;
            } catch (e) { console.warn('[Profile] Cache parse error:', e); }
        }

        function cacheProfile(displayName, email, role) {
            localStorage.setItem('userProfileCache', JSON.stringify({ displayName, email, role, timestamp: Date.now() }));
        }

        function startApp() {
            loadCachedProfile();

            const cachedRole = localStorage.getItem('userRole');
            if (cachedRole) {
                // Show page immediately based on cached role
                document.getElementById("page-loader").style.display = "none";
                document.getElementById("sidebar").style.display = "";
                document.getElementById("main-content").style.display = "";

                // Always ensure admin-only elements are hidden first
                document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");

                // Show admin features ONLY for admin or superadmin
                if (cachedRole === "admin" || cachedRole === "superadmin") {
                    document.body.classList.add("is-admin");
                    document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
                }

                if (cachedRole === "superadmin") {
                    document.querySelectorAll(".superadmin-only").forEach(el => el.style.display = "block");
                    document.getElementById("li-registros").style.display = "block";
                }
            }

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = "login.html";
                    return;
                }

                try {
                    const userDoc = await db.collection("userRoles").doc(user.uid).get();
                    if (!userDoc.exists) {
                        auth.signOut();
                        localStorage.removeItem('userRole');
                        window.location.href = "login.html";
                        return;
                    }

                    const userData = userDoc.data();
                    const userRole = userData.rol;
                    localStorage.setItem('userRole', userRole);

                    // Update profile header
                    const displayName = user.displayName || user.email.split('@')[0];
                    document.getElementById('user-display-name').textContent = displayName;
                    document.getElementById('user-display-email').textContent = user.email;

                    const roleMap = {
                        'user': { text: 'Usuario', icon: 'user', class: '' },
                        'admin': { text: 'Admin', icon: 'shield-check', class: 'admin' },
                        'superadmin': { text: 'Super Admin', icon: 'crown', class: 'superadmin' }
                    };
                    const roleInfo = roleMap[userRole] || roleMap['user'];
                    document.getElementById('user-role-text').textContent = roleInfo.text;
                    document.getElementById('user-role-badge').className = `user-role-badge ${roleInfo.class}`;

                    cacheProfile(displayName, user.email, userRole);

                    // Always hide admin elements first
                    document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");

                    // Show UI
                    document.getElementById("page-loader").style.display = "none";
                    document.getElementById("sidebar").style.display = "";
                    document.getElementById("main-content").style.display = "";

                    // Show admin features ONLY for admin/superadmin
                    if (userRole === "admin" || userRole === "superadmin") {
                        document.body.classList.add("is-admin");
                        document.querySelectorAll(".admin-only").forEach(el => el.style.display = "block");
                    }

                    if (userRole === "superadmin") {
                        document.querySelectorAll(".superadmin-only").forEach(el => el.style.display = "block");
                        document.getElementById("li-registros").style.display = "block";
                    }

                } catch (error) {
                    console.error("Error verificando rol:", error);
                    if (!cachedRole) {
                        alert("Error de conexión verificando permisos.");
                    }
                }
            });
        }

        startApp();

        // Sidebar toggle
        document.getElementById("menu-toggle")?.addEventListener("click", () => {
            document.getElementById("sidebar").classList.toggle("expanded");
            document.getElementById("main-content").classList.toggle("expanded");
        });

        // Logout
        document.getElementById("logout-btn")?.addEventListener("click", () => {
            auth.signOut().then(() => {
                localStorage.removeItem('userRole');
                localStorage.removeItem('userProfileCache');
                window.location.href = "login.html";
            });
        });

        // Use debounced refreshIcons for performance
        if (window.refreshIcons) refreshIcons(); else lucide.createIcons();
    </script>
    <script src="./js/sw-register.js"></script>
</body>

</html>
