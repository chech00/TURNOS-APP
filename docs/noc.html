<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turnos Noc - Calendario de Turnos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="./css/styles.css">
  <link rel="stylesheet" href="./css/noc.css" />
  <link rel="stylesheet" href="./css/user-profile-header.css" />
  <script defer src="./js/user-profile-header.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script defer src="./js/auto-logout.js"></script>
  <!-- Security: XSS Protection -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="./js/security-helpers.js"></script>
  <script defer src="./js/christmas.js"></script>
</head>

<body>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <img src="https://i.ibb.co/HqrX2cr/LOGO-COLOR-2-SLOGAN-768x185.png" alt="Logo de la Empresa" class="logo-sidebar">
    </div>
    <nav class="sidebar-menu">
      <ul>
        <li><a href="directorio.html" id="menu-directorio"><i data-lucide="users"></i> <span>Directorio</span></a></li>
        <li><a href="user.html" id="menu-turnos"><i data-lucide="calendar"></i> <span>Turnos</span></a></li>
        <li><a href="senales.html" id="menu-fibra"><i data-lucide="waypoints"></i> <span>Señal de Fibra</span></a></li>
        <li><a href="documentos.html" id="menu-doc"><i data-lucide="dock"></i> <span>Documentos Noc</span></a></li>
        <li><a href="noc.html" id="calendar-check" class="active"><i data-lucide="calendar-check"></i> <span>Turnos
              Noc</span></a></li>
        <li id="li-empleados" class="admin-only">
          <a href="gestion_empleados.html">
            <i data-lucide="user-cog"></i>
            <span>Gestionar Empleados</span>
          </a>
        </li>
        <li id="li-usuarios" class="superadmin-only" style="display:none;">
          <a href="gestion_usuarios.html">
            <i data-lucide="shield-check"></i>
            <span>Cuentas de Sistema</span>
          </a>
        </li>
        <li id="li-animaciones" class="superadmin-only" style="display:none;">
          <a href="animaciones.html">
            <i data-lucide="sparkles"></i>
            <span>Animaciones</span>
          </a>
        </li>
        <li id="li-registros" style="display:none;">
          <a href="registros.html">
            <i data-lucide="file-text"></i>
            <span>Registros</span>
          </a>
        </li>
      </ul>
    </nav>
    <button id="logout-btn" class="primary-btn logout-btn">
      <i data-lucide="log-out"></i> <span>Cerrar sesión</span>
    </button>
  </div>

  <!-- Contenedor Principal -->
  <div id="main-content" class="main-content">
    <header>
      <button id="menu-toggle" class="menu-btn">
        <i data-lucide="panel-left"></i>
      </button>
      <h1>Turnos Noc</h1>
      <!-- Premium User Profile Header -->
      <div class="user-profile-header">
        <div class="user-avatar">
          <i data-lucide="user"></i>
        </div>
        <div class="user-details">
          <span class="user-name" id="user-display-name">Usuario</span>
          <span class="user-email" id="user-display-email">email@example.com</span>
        </div>
        <div class="user-role-badge" id="user-role-badge">
          <i data-lucide="shield"></i>
          <span id="user-role-text">Usuario</span>
        </div>
      </div>
    </header>

    <main>
      <div class="container">

        <!-- Sección Calendario General con encabezado personalizado -->
        <section id="general-calendar-container" class="calendar-container">
          <div class="calendar-header">
            <div class="month-navigator">
              <button id="prev-month" class="btn-icon">
                <i data-lucide="chevron-left"></i>
              </button>
              <span id="current-month" class="text-xl">Mes y Año</span>
              <button id="next-month" class="btn-icon">
                <i data-lucide="chevron-right"></i>
              </button>
              <button id="today" class="btn-icon">
                <i data-lucide="calendar"></i> Hoy
              </button>
            </div>
          </div>
          <div id="lockedIndicator" class="locked-indicator" style="display:none;">
            <i data-lucide="lock"></i> MES CERRADO
          </div>
          <table id="general-calendar" class="calendar">
            <thead>
              <tr>
                <th class="text-left">Empleado</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </section>

        <!-- Calendario Nocturno -->
        <section id="nocturno-calendar-container" class="calendar-container">
          <h2>Calendario Nocturno - Cristian Oyarzo</h2>
          <table id="nocturno-calendar" class="calendar">
            <thead>
              <tr>
                <th class="text-left">Empleado</th>
              </tr>

            </thead>
            <tbody id="calendario-nocturno">
            </tbody>
          </table>
        </section>

        <!-- Calendario Feriados/Fines de Semana -->
        <section id="feriados-calendar-container" class="calendar-container">
          <h2>Calendario Feriados/Fines de Semana - Turno Especial</h2>
          <table id="feriados-calendar" class="calendar">
            <thead>
              <tr>
                <th class="text-left">Empleado</th>
              </tr>
            </thead>
            <tbody id="calendario-feriados">
            </tbody>
          </table>

          <!-- Reporte de Horas Extras -->
          <div id="overtime-report-container" class="admin-only" style="margin-top: 2rem;"></div>
        </section>

        <!-- Sección Turnos y Backup -->
        <section class="turnos-backup">
          <div class="turnos-section admin-only">
            <div class="turnos-header"
              style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h2 style="margin:0;">Turnos</h2>
              <button id="btnToggleFloating" class="btn-icon" title="Desacoplar panel"
                style="background:transparent; border:none; color:#a1a1aa; cursor:pointer;">
                <i data-lucide="maximize-2"></i>
              </button>
            </div>

            <div class="assignment-container">
              <div class="turnos-buttons">
                <!-- Fila 1 -->
                <button data-turno="M0" class="btn-turno" data-color="#648c9b"
                  style="background-color: #648c9b;">M0</button>
                <button data-turno="M0A" class="btn-turno" data-color="#7b69a5"
                  style="background-color: #7b69a5;">M0A</button>
                <button data-turno="M1" class="btn-turno" data-color="#557a5f"
                  style="background-color: #557a5f;">M1</button>
                <button data-turno="M1A" class="btn-turno" data-color="#c49f87"
                  style="background-color: #c49f87;">M1A</button>
                <button data-turno="M1B" class="btn-turno" data-color="#ffaaa5"
                  style="background-color: #ffaaa5;">M1B</button>
                <button data-turno="M2" class="btn-turno" data-color="#ffcc99"
                  style="background-color: #ffcc99;">M2</button>
                <button data-turno="M2A" class="btn-turno" data-color="#d4a5a5"
                  style="background-color: #d4a5a5;">M2A</button>

                <!-- Fila 2 -->
                <button data-turno="M2B" class="btn-turno" data-color="#b5e7a0"
                  style="background-color: #b5e7a0;">M2B</button>
                <button data-turno="M3" class="btn-turno" data-color="#996a7f"
                  style="background-color: #996a7f;">M3</button>
                <button data-turno="V" class="btn-turno" data-color="#88C0A6"
                  style="background-color: #88C0A6;">V</button>
                <button data-turno="L" class="btn-turno" data-color="#8FBCBB"
                  style="background-color: #8FBCBB;">L</button>
                <button data-turno="DL" class="btn-turno" data-color="#D77A7A"
                  style="background-color: #D77A7A;">DL</button>
                <button data-turno="N" class="btn-turno" data-color="#cccccc"
                  style="background-color: #cccccc;">N</button>
                <button data-turno="S" class="btn-turno" data-color="#4A90E2"
                  style="background-color: #4A90E2;">S</button>

                <!-- Fila 3 -->
                <button data-turno="I" class="btn-turno" data-color="#2C3E50"
                  style="background-color: #2C3E50;">I</button>
              </div>
            </div>
          </div>

          <div class="backup-container">
            <h2>Panel de Control</h2>
            <select id="selectMeses" class="select-meses">
              <option value="">-- Seleccione un mes guardado --</option>
            </select>

            <!-- SECCIÓN: DATOS -->
            <div class="control-section">
              <h4 class="control-section-title"><i data-lucide="database"></i> Datos</h4>
              <div class="backup-controls">
                <button id="btnCargar" class="btn-cargar"><i data-lucide="refresh-cw"></i> Recargar Calendario</button>
                <button id="btnGuardar" class="btn-guardar admin-only"><i data-lucide="save"></i> Guardar
                  Cambios</button>
                <input type="file" id="jsonInput" accept=".json" style="display: none;" />
                <button id="btnImportarGeneral" class="btn-horarios admin-only"
                  style="background-color: #3498db; color: white;">
                  <i data-lucide="upload"></i> Importar
                </button>
                <button id="btnExportarGeneral" class="btn-horarios admin-only"
                  style="background-color: #2ecc71; color: white;">
                  <i data-lucide="download"></i> Exportar
                </button>
              </div>
            </div>

            <!-- SECCIÓN: VISUALIZACIÓN -->
            <div class="control-section">
              <h4 class="control-section-title"><i data-lucide="eye"></i> Visualización</h4>
              <div class="backup-controls">
                <button id="btnVerHorarios" class="btn-horarios"><i data-lucide="clock"></i> Horarios</button>
                <button id="btnVerEstadisticas" class="btn-horarios admin-only"><i data-lucide="bar-chart-3"></i>
                  Estadísticas</button>
                <button id="btnVerSugerencias" class="btn-horarios admin-only"><i data-lucide="lightbulb"></i>
                  Sugerencias</button>
              </div>
            </div>

            <!-- SECCIÓN: ACCIONES ESPECIALES -->
            <div class="control-section admin-only">
              <h4 class="control-section-title"><i data-lucide="wand-2"></i> Acciones</h4>
              <button id="btnAutoAsignar" class="btn-cargar admin-only" style="background-color: #7796cb; width: 100%;">
                <i data-lucide="wand-2"></i> Auto-Asignar Turnos
              </button>
              <button id="btnToggleLock" class="btn-horarios superadmin-only"
                style="display:none; align-items: center; gap: 5px; width: 100%; margin-top: 5px;">
                <i data-lucide="lock"></i> Cerrar Mes
              </button>
            </div>

            <!-- SECCIÓN: ZONA DE PELIGRO -->
            <div class="control-section danger-zone admin-only">
              <h4 class="control-section-title" style="color: #e74c3c;"><i data-lucide="alert-triangle"></i> Zona de
                Peligro</h4>
              <button id="btnEliminar" class="btn-horarios admin-only" style="background-color: #e74c3c; width: 100%;">
                <i data-lucide="trash-2"></i> Eliminar Calendario
              </button>
            </div>

            <!-- Modal para Sugerencias -->
            <div id="modalSugerencias" class="modal-horarios">
              <div class="modal-horarios-content">
                <span id="cerrarSugerencias" class="close-horarios">&times;</span>
                <h2>Sugerencias de Optimización</h2>
                <ul id="listaSugerencias"></ul>
              </div>
            </div>

            <!-- Modal para Estadísticas Mejoradas -->
            <div id="modalEstadisticas" class="modal-horarios">
              <div class="modal-horarios-content">
                <span id="cerrarEstadisticas" class="close-horarios">&times;</span>
                <h2>Turnos - Estadísticas</h2>

                <!-- Tarjetas de Métricas -->
                <div class="stats-cards">
                  <div class="stats-card">
                    <h3>Total Turnos</h3>
                    <p id="total-turnos">0</p>
                  </div>
                  <div class="stats-card">
                    <h3>Turno más usado</h3>
                    <p id="turno-mas-usado">-</p>
                  </div>
                  <div class="stats-card">
                    <h3>Turno menos usado</h3>
                    <p id="turno-menos-usado">-</p>
                  </div>
                </div>

                <!-- Tabla de Turnos por Empleado -->
                <h3>Distribución de Turnos por Empleado</h3>
                <table class="tabla-turnos-empleados">
                  <thead>
                    <tr>
                      <th>Empleado</th>
                      <th>Turno más asignado</th>
                      <th>Turno menos asignado</th>
                    </tr>
                  </thead>
                  <tbody id="tabla-turnos-empleados">
                    <!-- Se llenará dinámicamente con JS -->
                  </tbody>
                </table>

                <!-- Contenedor de Gráficos -->
                <div class="charts-container">
                  <h3>Distribución de Turnos</h3>
                  <canvas id="graficoTurnos"></canvas>

                  <h3>Carga de Trabajo por Empleado</h3>
                  <canvas id="graficoEmpleados"></canvas>

                  <h3>Tendencias de Asignación de Turnos</h3>
                  <canvas id="graficoTendencias"></canvas>
                </div>
              </div>
            </div>
          </div>
      </div>
      </section>
      <!-- Employee cards moved to directorio.html -->
  </div>
  </main>

  <footer>
    <p>PatagoniaIP SPA - Todos los derechos reservados</p>
  </footer>
  </div>

  <!-- Modal Calendario Guardado -->
  <div id="modalCalendario" class="modal">
    <div class="modal-content">
      <span id="cerrarModal" class="close">&times;</span>
      <h2>Calendario Guardado</h2>
      <div id="contenidoModal"></div>
    </div>
  </div>

  <!-- Modal Horarios -->
  <div id="modalHorarios" class="modal-horarios">
    <div class="modal-horarios-content">
      <span id="cerrarHorarios" class="close-horarios">&times;</span>
      <h2>Horarios de Turnos</h2>
      <table class="tabla-horarios">
        <thead>
          <tr>
            <th>Turnos</th>
            <th>Horarios</th>
            <th>Días Libres</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>M0</td>
            <td>09:00hrs - 19:00hrs</td>
            <td>Martes, Jueves</td>
          </tr>
          <tr>
            <td>M0A</td>
            <td>09:00hrs - 19:00hrs</td>
            <td>Miércoles, Domingo</td>
          </tr>
          <tr>
            <td>M1</td>
            <td>08:30hrs - 17:30hrs<br>Sábado 8:30hrs - 13:30hrs</td>
            <td>Domingo</td>
          </tr>
          <tr>
            <td>M1A</td>
            <td>08:30hrs - 18:30hrs</td>
            <td>Sábado, Domingo</td>
          </tr>
          <tr>
            <td>M1B</td>
            <td>7:00hrs - 17:00hrs</td>
            <td>Sábado, Domingo</td>
          </tr>
          <tr>
            <td>M2</td>
            <td>11:00hrs - 20:00hrs<br>Sábado 13:00hrs - 18:00hrs</td>
            <td>Domingo</td>
          </tr>
          <tr>
            <td>M2A</td>
            <td>10:00hrs - 20:00hrs</td>
            <td>Sábado, Domingo</td>
          </tr>
          <tr>
            <td>M2B</td>
            <td>10:00hrs - 20:00hrs</td>
            <td>Miércoles, Domingo</td>
          </tr>
          <tr>
            <td>M3</td>
            <td>11:00hrs - 21:00hrs</td>
            <td>Martes, Jueves</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="modalEstadisticasSimple" class="modal-horarios" style="display:none;">
    <div class="modal-horarios-content">
      <span class="close-horarios">&times;</span>
      <h2>Estadísticas</h2>
      <div id="estadisticas-contenido"></div>
    </div>
  </div>

  <!-- Firebase SDKs (Classic Loading to ensure Globals) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script type="module" src="./js/firebase.js"></script>
  <script defer src="./js/noc.js"></script>
  <!-- Employee cards moved to directorio.html -->
  <script>
    // Esperar a que lucide esté cargado antes de inicializar iconos
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) {
        lucide.createIcons();
      }
    });
  </script>
</body>

</html>