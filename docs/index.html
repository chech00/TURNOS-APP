<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asignación de Turnos</title>

  <!-- Preconnect para recursos externos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- Critical CSS first -->
  <link rel="stylesheet" href="./css/critical.css">

  <!-- CSS principal (carga asíncrona con media-swap) -->
  <link rel="stylesheet" href="./css/styles.css?v=8" media="print" onload="this.media='all'">
  <noscript>
    <link rel="stylesheet" href="./css/styles.css?v=8">
  </noscript>
  <link rel="stylesheet" href="./css/user-profile-header.css" />

  <!-- Scripts con defer para non-blocking -->
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script defer src="./js/auto-logout.js"></script>
  <script defer src="./js/christmas.js"></script>

  <!-- Security: XSS Protection -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="./js/security-helpers.js"></script>
  <!-- Optimistic Profile Header Loading -->
  <script src="./js/user-profile-header.js"></script>
  <!-- Performance Helpers (debounced icons, DOM utils) -->
  <script src="./js/performance-helpers.js"></script>

  <!-- SweetAlert2: Lazy load on first use -->
  <script>
    window.Swal = window.Swal || new Proxy({}, {
      get: function (target, prop) {
        if (prop === 'fire' || prop === 'mixin') {
          return function (...args) {
            return new Promise(resolve => {
              const script = document.createElement('script');
              script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
              script.onload = () => resolve(window.Swal[prop]?.(...args));
              document.head.appendChild(script);
            });
          };
        }
        return undefined;
      }
    });
  </script>
</head>

<body>
  <!-- Loader de página completa -->
  <div id="page-loader"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--color-fondo-principal, #1a1a2e); z-index: 10000; display: flex; justify-content: center; align-items: center;">
    <div class="spinner"
      style="width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.1); border-top-color: var(--color-acento-primario, #3a86ff); border-radius: 50%; animation: spin 1s linear infinite;">
    </div>
  </div>
  <style>
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <div id="sidebar" class="sidebar" style="display: none;">
    <div class="sidebar-header">
      <img src="https://i.ibb.co/HqrX2cr/LOGO-COLOR-2-SLOGAN-768x185.png" alt="Logo de la Empresa"
        class="logo-sidebar" />
    </div>
    <nav class="sidebar-menu">
      <ul>

        <li><a href="directorio.html" id="menu-directorio"><i data-lucide="users"></i> <span>Directorio</span></a></li>
        <li id="li-turnos" class="admin-only" style="display:none;"><a href="#" id="menu-turnos" class="active"><i
              data-lucide="calendar"></i> <span>Turnos</span></a></li>
        <li><a href="senales.html" id="menu-fibra"><i data-lucide="waypoints"></i> <span>Señal de Fibra</span></a></li>
        <li><a href="documentos.html" id="menu-doc"><i data-lucide="dock"></i> <span>Documentos Noc</span></a></li>
        <li><a href="noc.html" id="calendar-check"><i data-lucide="calendar-check"></i> <span>Turnos Noc</span></a></li>
        <li><a href="suralis.html"><i data-lucide="send"></i><span>Notificaciones</span></a></li>
        <li id="li-empleados" class="admin-only">
          <a href="gestion_empleados.html">
            <i data-lucide="user-cog"></i>
            <span>Gestionar Empleados</span>
          </a>
        </li>
        <li id="li-usuarios" class="superadmin-only" style="display:none;">
          <a href="gestion_usuarios.html">
            <i data-lucide="shield-check"></i>
            <span>Cuentas de Sistema</span>
          </a>
        </li>
        <li id="li-animaciones" class="superadmin-only" style="display:none;">
          <a href="animaciones.html">
            <i data-lucide="sparkles"></i>
            <span>Animaciones</span>
          </a>
        </li>
        <li id="li-registros" style="display:none;">
          <a href="registros.html">
            <i data-lucide="file-text"></i>
            <span>Registros</span>
          </a>
        </li>
      </ul>
    </nav>
    <button id="logout-btn" class="primary-btn logout-btn">
      <i data-lucide="log-out"></i> <span>Cerrar sesión</span>
    </button>
  </div>

  <!-- Contenido Principal -->
  <div id="main-content" class="main-content" style="display: none;">
    <header>
      <button id="menu-toggle" class="menu-btn">
        <i data-lucide="panel-left"></i>
      </button>
      <h1>Calendario de Turnos</h1>
      <!-- Premium User Profile Header -->
      <div class="user-profile-header">
        <div class="user-avatar">
          <i data-lucide="user"></i>
        </div>
        <div class="user-details">
          <span class="user-name" id="user-display-name">Usuario</span>
          <span class="user-email" id="user-display-email">email@example.com</span>
        </div>
        <div class="user-role-badge" id="user-role-badge">
          <i data-lucide="shield"></i>
          <span id="user-role-text">Usuario</span>
        </div>
      </div>
    </header>

    <main>
      <section class="calendar-container">
        <div id="loading-spinner" style="display: none;">
          <div class="spinner"></div>
        </div>
        <div id="external-arrow" class="external-arrow"></div>
        <div class="calendar-header">
          <button id="prev-month">&laquo; Mes Anterior</button>
          <h2 id="calendar-title"></h2>
          <button id="next-month">Mes Siguiente &raquo;</button>
        </div>
        <table id="calendar">
          <thead></thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="linear-view" class="linear-container" style="display: none;">
        <h2 id="linear-title">Agenda de Turnos</h2>
        <ul id="linear-list"></ul>
      </section>

      <section class="botones-contenedor">

        <button id="calendar-view-btn" class="primary-btn">Vista de Calendario</button>
        <button id="linear-view-btn" class="primary-btn">Vista Lineal</button>
        <button id="assign-turns" class="primary-btn">Asignar Turnos para la Semana</button>
        <button id="open-edit-modal" class="primary-btn" disabled>Editar Semanas</button>
        <button id="manage-additional-btn" class="primary-btn">Gestionar Contactos Adicionales</button>
        <button id="manage-empleados-btn" class="primary-btn">Gestionar Empleados</button>
      </section>

      <!-- Sección de Búsqueda -->
      <section id="search-section">
        <h2>Buscar Asignación por Fecha</h2>
        <input type="date" id="search-date" />
        <button id="search-button" class="primary-btn">Buscar</button>
        <div id="search-result"></div>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 PatagoniaIP SpA - Todos los derechos reservados.</p>
    </footer>



    <!-- Modal de confirmación personalizado -->
    <div id="custom-confirm" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="confirm-title">Confirmación</h2>
          <span id="close-confirm" class="close-modal">&times;</span>
        </div>
        <p id="confirm-message">¿Estás seguro?</p>
        <div class="button-container">
          <button id="confirm-yes" class="primary-btn">Sí</button>
          <button id="confirm-no" class="primary-btn">No</button>
        </div>
      </div>
    </div>

    <!-- Modal para gestionar contactos adicionales -->
    <div id="manage-additional-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2>Gestionar Contactos Adicionales de Telegram</h2>
          <span id="close-additional-modal" class="close-modal">&times;</span>
        </div>
        <div class="form-group">
          <label for="contact-select">Seleccionar Contacto:</label>
          <select id="contact-select">
            <option value="">-- Seleccione un contacto --</option>
          </select>
        </div>
        <div class="button-container">
          <button id="edit-contact-btn" class="primary-btn" disabled>Editar</button>
          <button id="delete-contact-btn" class="primary-btn" disabled>Eliminar</button>
        </div>
        <hr />
        <h3>Agregar / Editar Contacto</h3>
        <div class="form-group">
          <label for="contact-name">Nombre:</label>
          <input type="text" id="contact-name" placeholder="Nombre del contacto" />
        </div>
        <div class="form-group">
          <label for="contact-id">Chat ID:</label>
          <input type="text" id="contact-id" placeholder="ID de Telegram" />
        </div>
        <button id="save-contact" class="primary-btn">Guardar Contacto</button>
      </div>
    </div>

    <!-- Modal para gestionar empleados -->
    <div id="manage-empleados-modal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h2>Gestionar Empleados</h2>
          <span id="close-empleados-modal" class="close-modal">&times;</span>
        </div>
        <hr />
        <h3>Gestionar Empleados</h3>
        <div class="form-group">
          <label for="empleados-select">Seleccionar Empleado:</label>
          <select id="empleados-select">
            <option value="">-- Seleccione un empleado --</option>
          </select>
        </div>
        <div class="button-container">
          <button id="edit-employee-btn" class="primary-btn" disabled>Editar</button>
          <button id="delete-employee-btn" class="primary-btn" disabled>Eliminar</button>
        </div>
        <hr />
        <h3>Agregar / Editar Empleado</h3>
        <div class="form-group">
          <label for="empleado-name">Nombre:</label>
          <input type="text" id="empleado-name" placeholder="Nombre del empleado" />
        </div>
        <div class="form-group">
          <label for="empleado-rol">Rol:</label>
          <select id="empleado-rol">
            <option value="Técnico de Red">Técnico de Red</option>
            <option value="Ingeniero">Ingeniero</option>
            <option value="Planta Externa">Planta Externa</option>
          </select>
        </div>
        <div class="form-group">
          <label for="empleado-chatid">Telegram Chat ID:</label>
          <input type="text" id="empleado-chatid" placeholder="ID de Telegram" />
        </div>
        <button id="save-empleado" class="primary-btn">Guardar Empleado</button>
      </div>
    </div>

    <!-- Modal para editar semanas (¡Agregado para solucionar el error!) -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Editar Semana</h2>
          <span id="close-edit-modal" class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="edit-tecnico">Técnico:</label>
            <select id="edit-tecnico"></select>
          </div>
          <div class="form-group">
            <label for="edit-ingeniero">Ingeniero:</label>
            <select id="edit-ingeniero"></select>
          </div>
          <div class="form-group">
            <label for="edit-planta">Planta Externa:</label>
            <select id="edit-planta"></select>
          </div>
          <button id="update-week" class="primary-btn">Actualizar Semana</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Cargar Firebase desde CDN (Deferred) -->
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Error Handler for Debugging -->
  <script>
    window.onerror = function (msg, url, line, col, error) {
      alert("Error Global: " + msg + "\nEn: " + url + "\nLínea: " + line);
      console.error("Global Error:", msg, url, line, error);
    };
  </script>

  <!-- Tus scripts de configuración -->
  <script type="module" src="./js/firebase.js"></script>
  <script type="module" src="./js/script.js"></script>

  <script type="module">
    // Modulo de incialización optimizado
    import { auth, db } from './js/firebase.js';

    function loadCachedProfile() {
      const cached = localStorage.getItem('userProfileCache');
      if (!cached) return;
      try {
        const data = JSON.parse(cached);
        const nameEl = document.getElementById('user-display-name');
        const emailEl = document.getElementById('user-display-email');
        const roleBadge = document.getElementById('user-role-badge');
        const roleText = document.getElementById('user-role-text');
        if (nameEl) nameEl.textContent = data.displayName;
        if (emailEl) emailEl.textContent = data.email;
        if (roleText) roleText.textContent = data.role === 'superadmin' ? 'Super Admin' : data.role === 'admin' ? 'Admin' : 'Usuario';
        if (roleBadge) roleBadge.className = `user-role-badge ${data.role === 'superadmin' ? 'superadmin' : data.role === 'admin' ? 'admin' : ''}`;
        console.log('[Profile] Loaded from cache:', data.displayName);
      } catch (e) { console.warn('[Profile] Cache parse error:', e); }
    }

    function cacheProfile(displayName, email, role) {
      localStorage.setItem('userProfileCache', JSON.stringify({ displayName, email, role, timestamp: Date.now() }));
    }

    function startApp() {
      // 0. Load cached profile IMMEDIATELY to prevent flash
      loadCachedProfile();

      // 1. Optimización: Chequeo inmediato de caché para mostrar UI instantáneamente
      const cachedRole = localStorage.getItem('userRole');
      if (cachedRole === 'admin' || cachedRole === 'superadmin') {
        // Mostrar UI inmediatamente basado en caché
        document.body.classList.add("is-admin");
        const loader = document.getElementById("page-loader");
        if (loader) loader.style.display = "none";
        const sidebar = document.getElementById("sidebar");
        if (sidebar) sidebar.style.display = "";
        const mainContent = document.getElementById("main-content");
        if (mainContent) mainContent.style.display = "";
        if (cachedRole === "superadmin") {
          const liRegistros = document.getElementById("li-registros");
          if (liRegistros) liRegistros.style.display = "block";
        }
      }

      // 2. Verificación de Seguridad en Segundo Plano
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        try {
          const userDoc = await db.collection("userRoles").doc(user.uid).get();
          if (!userDoc.exists) {
            auth.signOut();
            localStorage.removeItem('userRole'); // Limpiar caché si ya no existe
            window.location.href = "login.html";
            return;
          }
          const userData = userDoc.data();
          const userRole = userData.rol;

          // Actualizar caché con el dato fresco
          localStorage.setItem('userRole', userRole);

          // Verificar rol (Redundante si la caché era correcta, pero vital si cambió)
          if (window.location.pathname.includes("index.html") && userRole !== "admin" && userRole !== "superadmin") {
            window.location.href = "user.html";
            return;
          }

          // ============================================================
          // ACTUALIZAR USER PROFILE HEADER
          // ============================================================
          const nameElement = document.getElementById('user-display-name');
          const emailElement = document.getElementById('user-display-email');
          const roleBadge = document.getElementById('user-role-badge');
          const roleText = document.getElementById('user-role-text');

          if (nameElement && emailElement && roleBadge && roleText) {
            // Nombre: extraer de email si no hay displayName
            const displayName = user.displayName || user.email.split('@')[0];
            nameElement.textContent = displayName;
            emailElement.textContent = user.email;

            // Role badge mapping
            const roleMap = {
              'user': { text: 'Usuario', icon: 'user', class: '' },
              'admin': { text: 'Admin', icon: 'shield-check', class: 'admin' },
              'superadmin': { text: 'Super Admin', icon: 'crown', class: 'superadmin' }
            };

            const roleInfo = roleMap[userRole] || roleMap['user'];
            roleText.textContent = roleInfo.text;
            roleBadge.className = `user-role-badge ${roleInfo.class}`;

            // Update icon
            const roleIcon = roleBadge.querySelector('i');
            if (roleIcon) {
              roleIcon.setAttribute('data-lucide', roleInfo.icon);
              if (window.lucide) window.lucide.createIcons();
            }

            console.log('✅ User profile updated:', displayName, '(' + userRole + ')');

            // Cache for next page load
            cacheProfile(displayName, user.email, userRole);
          }
          // ============================================================

          // Si NO teníamos caché (primera carga) o si la caché estaba desactualizada, actualizar UI ahora
          if (!cachedRole || cachedRole !== userRole) {
            document.body.classList.add("is-admin");
            const loader = document.getElementById("page-loader");
            if (loader) loader.style.display = "none";
            const sidebar = document.getElementById("sidebar");
            if (sidebar) sidebar.style.display = "";
            const mainContent = document.getElementById("main-content");
            if (mainContent) mainContent.style.display = "";

            if (userRole === "superadmin") {
              const liRegistros = document.getElementById("li-registros");
              if (liRegistros) liRegistros.style.display = "block";
            }
          }
        } catch (error) {
          console.error("Error verificando rol:", error);
          // Si falla la red pero teníamos caché, el usuario puede ver la UI (aunque quizás no guardar cambios)
          if (!cachedRole) {
            alert("Error de conexión verificando permisos. Intente recargar.");
          }
        }
      });
    }

    // Iniciar app
    startApp();

    lucide.createIcons();
  </script>
</body>

</html>